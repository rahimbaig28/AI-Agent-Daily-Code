name: Perplexity Random Daily Update

on:
  schedule:
    - cron: "13 * * * *"   # every hour at :13 UTC (24 chances/day)
  workflow_dispatch: {}

concurrency:
  group: perplexity-auto
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  run-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Create / reset a daily random plan: date,target,done
      - name: Prepare daily random plan
        id: plan
        run: |
          set -e
          DATE=$(date -u +%Y-%m-%d)
          PLAN_FILE=".automation_plan"

          # Helper: weighted random target 1..4
          # (tweak weights if you want; these give a nice mix)
          pick_target () {
            r=$((RANDOM % 100))
            if   [ $r -lt 15 ]; then echo 1
            elif [ $r -lt 50 ]; then echo 2
            elif [ $r -lt 75 ]; then echo 3
            else echo 4
            fi
          }

          if [ ! -f "$PLAN_FILE" ]; then
            TARGET=$(pick_target)
            echo "$DATE,$TARGET,0" > "$PLAN_FILE"
          else
            FILE_DATE=$(cut -d',' -f1 < "$PLAN_FILE")
            if [ "$FILE_DATE" != "$DATE" ]; then
              TARGET=$(pick_target)
              echo "$DATE,$TARGET,0" > "$PLAN_FILE"
            fi
          fi

          TARGET=$(cut -d',' -f2 < "$PLAN_FILE")
          DONE=$(cut -d',' -f3 < "$PLAN_FILE")

          echo "date=$DATE"   >> $GITHUB_OUTPUT
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "done=$DONE"   >> $GITHUB_OUTPUT

          echo "Plan for $DATE => target runs: $TARGET, completed: $DONE"

      # Decide randomly whether to run THIS hour.
      # Probability = remaining_runs / remaining_hours_in_day (UTC)
      - name: Decide whether to run now
        id: decide
        run: |
          set -e
          TARGET="${{ steps.plan.outputs.target }}"
          DONE="${{ steps.plan.outputs.done }}"

          if [ "$DONE" -ge "$TARGET" ]; then
            echo "run_now=false" >> $GITHUB_OUTPUT
            echo "Daily target already met ($DONE/$TARGET)."
            exit 0
          fi

          HOUR=$(date -u +%H)
          # remaining hours including current hour
          REM_HOURS=$((24 - 10#$HOUR))
          REM_RUNS=$((TARGET - DONE))

          # Avoid division issues
          if [ "$REM_HOURS" -le 0 ]; then REM_HOURS=1; fi

          # Probability in percent
          PROB=$(( (REM_RUNS * 100) / REM_HOURS ))
          # Ensure at least 5% chance so we don't miss late in day due to rounding
          if [ "$PROB" -lt 5 ]; then PROB=5; fi
          if [ "$PROB" -gt 95 ]; then PROB=95; fi

          R=$((RANDOM % 100))
          echo "Remaining runs: $REM_RUNS, remaining hours: $REM_HOURS, prob: ${PROB}%"
          echo "Rolled: $R"

          if [ "$R" -lt "$PROB" ]; then
            echo "run_now=true" >> $GITHUB_OUTPUT
            echo "✅ Will run this hour."
          else
            echo "run_now=false" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping this hour."
          fi

      - name: Stop if skipping this hour
        if: ${{ steps.decide.outputs.run_now != 'true' }}
        run: |
          echo "Skipping execution this hour (random schedule)."

      - name: Set up Python
        if: ${{ steps.decide.outputs.run_now == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: ${{ steps.decide.outputs.run_now == 'true' }}
        run: pip install requests

      - name: Generate auto-prompt + single-file app (with retries)
        if: ${{ steps.decide.outputs.run_now == 'true' }}
        env:
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
          PPLX_TIMEOUT: "420"
          PPLX_MODEL: "sonar"
        run: |
          set -e
          for i in 1 2 3; do
            echo "Attempt $i..."
            if python automation/generate.py; then
              echo "Success."
              break
            fi
            echo "Attempt $i failed. Sleeping before retry..."
            sleep 10
          done

      - name: Verify prompt exists
        if: ${{ steps.decide.outputs.run_now == 'true' }}
        run: |
          test -f dist/latest/prompt.txt || (echo "No prompt found at dist/latest/prompt.txt" && exit 1)

      # Commit dist/** (only if changed)
      - name: Commit & push if changed
        if: ${{ steps.decide.outputs.run_now == 'true' }}
        id: autocommit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "automation using Perplexity AI"
          commit_user_name: "rahimbaig28"
          commit_user_email: "rahimbaig00332211@gmail.com"
          file_pattern: "dist/**"

      # Only if something was committed: increment daily done counter and commit it
      - name: Update daily plan done count
        if: ${{ steps.decide.outputs.run_now == 'true' && steps.autocommit.outputs.changes_detected == 'true' }}
        run: |
          set -e
          PLAN_FILE=".automation_plan"
          DATE=$(date -u +%Y-%m-%d)
          TARGET=$(cut -d',' -f2 < "$PLAN_FILE")
          DONE=$(cut -d',' -f3 < "$PLAN_FILE")
          NEW_DONE=$((DONE + 1))
          echo "$DATE,$TARGET,$NEW_DONE" > "$PLAN_FILE"
          echo "Updated plan: $DATE target=$TARGET done=$NEW_DONE"

      - name: Commit plan update
        if: ${{ steps.decide.outputs.run_now == 'true' && steps.autocommit.outputs.changes_detected == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "update daily automation plan"
          commit_user_name: "rahimbaig28"
          commit_user_email: "rahimbaig00332211@gmail.com"
          file_pattern: ".automation_plan"

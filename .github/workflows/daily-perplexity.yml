name: Daily Perplexity Update

on:
  schedule:
    - cron: "0 13 * * *"     # still runs daily at 13:00 UTC
    - cron: "0 */4 * * *"    # run every 4 hours (6 times/day max)
  workflow_dispatch: {}

concurrency:
  group: perplexity-auto
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  run-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare commit counter file
        run: |
          DATE=$(date +%Y-%m-%d)
          if [ ! -f .automation_count ]; then
            echo "$DATE,0" > .automation_count
          else
            FILE_DATE=$(cut -d',' -f1 < .automation_count)
            if [ "$FILE_DATE" != "$DATE" ]; then
              echo "$DATE,0" > .automation_count
            fi
          fi

      - name: Read number of commits done today
        id: counter
        run: |
          COUNT=$(cut -d',' -f2 < .automation_count)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Stop if commit limit reached
        if: ${{ steps.counter.outputs.count >= 5 }}
        run: |
          echo "Maximum of 5 commits already performed today. Exiting workflow."
          exit 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Generate auto-prompt + single-file app (with retries)
        env:
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
          PPLX_TIMEOUT: "420"
          PPLX_MODEL: "sonar"
        run: |
          set -e
          for i in 1 2 3; do
            echo "Attempt $i..."
            if python automation/generate.py; then
              echo "Success."
              break
            fi
            echo "Attempt $i failed. Sleeping before retry..."
            sleep 10
          done

      - name: Show generated files
        run: |
          echo "== dist tree =="
          ls -lah dist || true
          echo "== prompts =="
          ls -lah dist/prompts || true
          echo "== apps =="
          ls -lah dist/apps || true
          echo "== latest =="
          ls -lah dist/latest || true

      - name: Verify prompt exists
        run: |
          test -f dist/latest/prompt.txt || (echo "No prompt found at dist/latest/prompt.txt" && exit 1)

      - name: Commit & push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "automation using Perplexity AI"
          commit_user_name: "rahimbaig28"
          commit_user_email: "rahimbaig00332211@gmail.com"
          file_pattern: "dist/**"
          add_options: "--force"

      - name: Increment daily commit counter
        run: |
          DATE=$(date +%Y-%m-%d)
          COUNT=$(cut -d',' -f2 < .automation_count)
          NEW_COUNT=$((COUNT + 1))
          echo "$DATE,$NEW_COUNT" > .automation_count

      - name: Commit counter update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "update automation counter"
          file_pattern: ".automation_count"

<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-12-10T08:28:32.940341Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Personal Finance Ledger CLI</title>
<style>
  :root {
    --bg-light: #f9f9f9;
    --fg-light: #222;
    --bg-dark: #121212;
    --fg-dark: #eee;
    --accent-light: #007acc;
    --accent-dark: #3399ff;
  }
  body {
    font-family: monospace, monospace;
    margin: 0; padding: 0; min-height: 100vh;
    background-color: var(--bg-light);
    color: var(--fg-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }
  body.dark {
    background-color: var(--bg-dark);
    color: var(--fg-dark);
  }
  h1 {
    margin-bottom: 0.5rem;
  }
  #ledger {
    width: 100%;
    max-width: 900px;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }
  #ledger th, #ledger td {
    border: 1px solid currentColor;
    padding: 0.25rem 0.5rem;
    text-align: left;
  }
  #ledger th {
    background-color: var(--accent-light);
    color: white;
  }
  body.dark #ledger th {
    background-color: var(--accent-dark);
  }
  #menu {
    margin-bottom: 1rem;
  }
  button, input, select {
    font-family: monospace, monospace;
    font-size: 1rem;
    margin: 0.2rem;
    padding: 0.3rem 0.6rem;
  }
  input[type="date"], input[type="number"], input[type="text"] {
    width: 12rem;
  }
  label {
    margin-right: 0.5rem;
  }
  #message {
    min-height: 1.2rem;
    margin-bottom: 1rem;
    color: #d00;
  }
  #summary {
    margin-top: 1rem;
    max-width: 900px;
    width: 100%;
  }
  #filter-section {
    margin-bottom: 1rem;
  }
  #filter-section label {
    margin-right: 0.3rem;
  }
  #pagination {
    margin-top: 0.5rem;
  }
  #pagination button {
    min-width: 3rem;
  }
  .sr-only {
    position: absolute;
    left: -9999px;
    top: auto;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }
</style>
</head>
<body>
<h1>Personal Finance Ledger</h1>
<div id="message" role="alert" aria-live="assertive"></div>
<div id="filter-section" aria-label="Filter transactions">
  <label for="filter-start-date">Start Date:</label>
  <input type="date" id="filter-start-date" />
  <label for="filter-end-date">End Date:</label>
  <input type="date" id="filter-end-date" />
  <label for="filter-category">Category:</label>
  <input type="text" id="filter-category" placeholder="Category filter" />
  <button id="filter-apply">Apply Filter</button>
  <button id="filter-clear">Clear Filter</button>
</div>
<table id="ledger" aria-label="Transaction ledger" role="grid" aria-readonly="true" tabindex="0">
  <thead>
    <tr>
      <th scope="col">ID</th>
      <th scope="col">Date</th>
      <th scope="col">Category</th>
      <th scope="col">Description</th>
      <th scope="col">Amount</th>
      <th scope="col">Balance</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div id="pagination" aria-label="Pagination controls">
  <button id="prev-page" aria-label="Previous page">&lt; Prev</button>
  <span id="page-info" aria-live="polite" aria-atomic="true"></span>
  <button id="next-page" aria-label="Next page">Next &gt;</button>
</div>
<div id="summary" aria-label="Monthly summary report"></div>
<div id="menu" role="menu" aria-label="Main menu">
  <button id="add-transaction" role="menuitem">Add Transaction</button>
  <button id="edit-transaction" role="menuitem">Edit Transaction</button>
  <button id="remove-transaction" role="menuitem">Remove Transaction</button>
  <button id="undo" role="menuitem">Undo</button>
  <button id="redo" role="menuitem">Redo</button>
  <button id="show-summary" role="menuitem">Show Summary Report</button>
  <button id="exit" role="menuitem">Exit</button>
</div>

<div id="form-dialog" role="dialog" aria-modal="true" aria-labelledby="form-title" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:inherit; border:1px solid currentColor; padding:1rem; max-width:400px; z-index:1000;">
  <h2 id="form-title"></h2>
  <form id="transaction-form">
    <input type="hidden" id="form-id" />
    <div>
      <label for="form-date">Date:</label>
      <input type="date" id="form-date" required />
    </div>
    <div>
      <label for="form-category">Category:</label>
      <input type="text" id="form-category" required placeholder="e.g. Salary, Food" />
    </div>
    <div>
      <label for="form-description">Description:</label>
      <input type="text" id="form-description" required placeholder="Description" />
    </div>
    <div>
      <label for="form-amount">Amount:</label>
      <input type="number" id="form-amount" step="0.01" required placeholder="Positive for income, negative for expense" />
    </div>
    <div style="margin-top:0.5rem;">
      <button type="submit" id="form-submit">Save</button>
      <button type="button" id="form-cancel">Cancel</button>
    </div>
  </form>
</div>

<script>
(() => {
  "use strict";

  // Constants
  const STORAGE_KEY = 'personalFinanceLedgerData';
  const PAGE_SIZE = 10;

  // State
  let transactions = [];
  let undoStack = [];
  let redoStack = [];
  let filteredTransactions = null;
  let currentPage = 1;

  // Elements
  const tbody = document.querySelector('#ledger tbody');
  const messageEl = document.getElementById('message');
  const pageInfo = document.getElementById('page-info');
  const prevPageBtn = document.getElementById('prev-page');
  const nextPageBtn = document.getElementById('next-page');
  const filterStartDate = document.getElementById('filter-start-date');
  const filterEndDate = document.getElementById('filter-end-date');
  const filterCategory = document.getElementById('filter-category');
  const filterApplyBtn = document.getElementById('filter-apply');
  const filterClearBtn = document.getElementById('filter-clear');
  const addBtn = document.getElementById('add-transaction');
  const editBtn = document.getElementById('edit-transaction');
  const removeBtn = document.getElementById('remove-transaction');
  const undoBtn = document.getElementById('undo');
  const redoBtn = document.getElementById('redo');
  const summaryBtn = document.getElementById('show-summary');
  const exitBtn = document.getElementById('exit');
  const formDialog = document.getElementById('form-dialog');
  const formTitle = document.getElementById('form-title');
  const form = document.getElementById('transaction-form');
  const formId = document.getElementById('form-id');
  const formDate = document.getElementById('form-date');
  const formCategory = document.getElementById('form-category');
  const formDescription = document.getElementById('form-description');
  const formAmount = document.getElementById('form-amount');
  const formSubmit = document.getElementById('form-submit');
  const formCancel = document.getElementById('form-cancel');
  const summaryDiv = document.getElementById('summary');

  // Utility functions
  function showMessage(msg, isError = true) {
    messageEl.textContent = msg;
    messageEl.style.color = isError ? '#d00' : '#060';
    if (msg) {
      setTimeout(() => {
        if (messageEl.textContent === msg) messageEl.textContent = '';
      }, 5000);
    }
  }

  function saveData() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({transactions, undoStack, redoStack}));
    } catch (e) {
      showMessage('Error saving data: ' + e.message);
    }
  }

  function loadData() {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        const parsed = JSON.parse(data);
        transactions = parsed.transactions || [];
        undoStack = parsed.undoStack || [];
        redoStack = parsed.redoStack || [];
      }
    } catch (e) {
      showMessage('Error loading data: ' + e.message);
    }
  }

  function generateId() {
    // Generate a unique numeric ID based on timestamp + random
    return Date.now().toString(36) + Math.floor(Math.random()*1000).toString(36);
  }

  function parseDate(str) {
    // Parse date string YYYY-MM-DD to Date object (local time)
    const d = new Date(str + 'T00:00:00');
    return isNaN(d) ? null : d;
  }

  function formatDate(d) {
    // Format Date object as YYYY-MM-DD
    if (!(d instanceof Date)) return '';
    const y = d.getFullYear();
    const m = (d.getMonth()+1).toString().padStart(2,'0');
    const day = d.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function formatAmount(a) {
    return (a < 0 ? '-$' : '$') + Math.abs(a).toFixed(2);
  }

  function compareDate(t1, t2) {
    // Compare transactions by date ascending, then by id ascending
    const d1 = parseDate(t1.date);
    const d2 = parseDate(t2.date);
    if (d1 < d2) return -1;
    if (d1 > d2) return 1;
    return t1.id.localeCompare(t2.id);
  }

  function cloneTransaction(t) {
    return {...t};
  }

  // Undo/Redo helpers
  function pushUndo(action) {
    undoStack.push(action);
    if (undoStack.length > 100) undoStack.shift();
    redoStack = [];
  }

  function undo() {
    if (undoStack.length === 0) {
      showMessage('Nothing to undo.', true);
      return;
    }
    const action = undoStack.pop();
    applyInverseAction(action);
    redoStack.push(action);
    saveData();
    renderLedger();
    showMessage('Undo performed.', false);
  }

  function redo() {
    if (redoStack.length === 0) {
      showMessage('Nothing to redo.', true);
      return;
    }
    const action = redoStack.pop();
    applyAction(action);
    undoStack.push(action);
    saveData();
    renderLedger();
    showMessage('Redo performed.', false);
  }

  function applyAction(action) {
    switch(action.type) {
      case 'add':
        transactions.push(cloneTransaction(action.transaction));
        break;
      case 'edit': {
        const idx = transactions.findIndex(t => t.id === action.transaction.id);
        if (idx !== -1) transactions[idx] = cloneTransaction(action.transaction);
        break;
      }
      case 'remove': {
        const idx = transactions.findIndex(t => t.id === action.transaction.id);
        if (idx !== -1) transactions.splice(idx, 1);
        break;
      }
    }
    transactions.sort(compareDate);
  }

  function applyInverseAction(action) {
    switch(action.type) {
      case 'add': {
        // inverse of add is remove
        const idx = transactions.findIndex(t => t.id === action.transaction.id);
        if (idx !== -1) transactions.splice(idx, 1);
        break;
      }
      case 'edit': {
        // inverse of edit is edit with oldTransaction
        const idx = transactions.findIndex(t => t.id === action.oldTransaction.id);
        if (idx !== -1) transactions[idx] = cloneTransaction(action.oldTransaction);
        break;
      }
      case 'remove': {
        // inverse of remove is add
        transactions.push(cloneTransaction(action.transaction));
        transactions.sort(compareDate);
        break;
      }
    }
  }

  // Rendering
  function getDisplayedTransactions() {
    return filteredTransactions || transactions;
  }

  function paginate(arr, page, pageSize) {
    const start = (page-1)*pageSize;
    return arr.slice(start, start+pageSize);
  }

  function renderLedger() {
    const data = getDisplayedTransactions();
    const totalPages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;
    const pageData = paginate(data, currentPage, PAGE_SIZE);

    tbody.innerHTML = '';
    let runningBalance = 0;
    // Calculate running balance for all transactions before current page
    for (let i = 0; i < (currentPage-1)*PAGE_SIZE; i++) {
      runningBalance += data[i].amount;
    }
    for (const t of pageData) {
      runningBalance += t.amount;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${t.id}</td>
        <td>${t.date}</td>
        <td>${escapeHtml(t.category)}</td>
        <td>${escapeHtml(t.description)}</td>
        <td style="text-align:right;">${formatAmount(t.amount)}</td>
        <td style="text-align:right;">${formatAmount(runningBalance)}</td>
      `;
      tbody.appendChild(tr);
    }
    pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${data.length} transactions)`;
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
  }

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => {
      switch(m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }

  // Summary report: total income, expenses, net balance per month
  function generateSummary() {
    // Group by YYYY-MM
    const summaryMap = {};
    for (const t of transactions) {
      const month = t.date.slice(0,7);
      if (!summaryMap[month]) summaryMap[month] = {income:0, expenses:0};
      if (t.amount >= 0) summaryMap[month].income += t.amount;
      else summaryMap[month].expenses += t.amount;
    }
    return summaryMap;
  }

  function renderSummary() {
    const summary = generateSummary();
    const months = Object.keys(summary).sort();
    if (months.length === 0) {
      summaryDiv.textContent = 'No transactions to summarize.';
      return;
    }
    let html = '<table aria-label="Monthly summary report" style="width:100%; border-collapse: collapse;">';
    html += '<thead><tr><th>Month</th><th>Total Income</th><th>Total Expenses</th><th>Net Balance</th></tr></thead><tbody>';
    for (const m of months) {
      const inc = summary[m].income;
      const exp = summary[m].expenses;
      const net = inc + exp;
      html += `<tr>
        <td>${m}</td>
        <td style="text-align:right; color:green;">${formatAmount(inc)}</td>
        <td style="text-align:right; color:red;">${formatAmount(exp)}</td>
        <td style="text-align:right;">${formatAmount(net)}</td>
      </tr>`;
    }
    html += '</tbody></table>';
    summaryDiv.innerHTML = html;
  }

  // Filtering
  function applyFilter() {
    const startDate = filterStartDate.value ? parseDate(filterStartDate.value) : null;
    const endDate = filterEndDate.value ? parseDate(filterEndDate.value) : null;
    const categoryFilter = filterCategory.value.trim().toLowerCase();

    filteredTransactions = transactions.filter(t => {
      const tDate = parseDate(t.date);
      if (startDate && tDate < startDate) return false;
      if (endDate && tDate > endDate) return false;
      if (categoryFilter && !t.category.toLowerCase().includes(categoryFilter)) return false;
      return true;
    });
    currentPage = 1;
    renderLedger();
    summaryDiv.textContent = '';
  }

  function clearFilter() {
    filterStartDate.value = '';
    filterEndDate.value = '';
    filterCategory.value = '';
    filteredTransactions = null;
    currentPage = 1;
    renderLedger();
    summaryDiv.textContent = '';
  }

  // Form dialog
  function openFormDialog(mode, transaction = null) {
    form.reset();
    formId.value = '';
    if (mode === 'add') {
      formTitle.textContent = 'Add Transaction';
      formSubmit.textContent = 'Add';
      // Default date today
      formDate.value = new Date().toISOString().slice(0,10);
    } else if (mode === 'edit') {
      formTitle.textContent = 'Edit Transaction';
      formSubmit.textContent = 'Save';
      if (transaction) {
        formId.value = transaction.id;
        formDate.value = transaction.date;
        formCategory.value = transaction.category;
        formDescription.value = transaction.description;
        formAmount.value = transaction.amount.toFixed(2);
      }
    }
    formDialog.style.display = 'block';
    formDate.focus();
  }

  function closeFormDialog() {
    formDialog.style.display = 'none';
  }

  // Add transaction
  function addTransaction(t) {
    transactions.push(t);
    transactions.sort(compareDate);
    pushUndo({type:'add', transaction: cloneTransaction(t)});
    saveData();
    renderLedger();
    showMessage('Transaction added.', false);
  }

  // Edit transaction
  function editTransaction(id, newData) {
    const idx = transactions.findIndex(t => t.id === id);
    if (idx === -1) {
      showMessage('Transaction ID not found.');
      return;
    }
    const oldTransaction = cloneTransaction(transactions[idx]);
    transactions[idx] = {...oldTransaction, ...newData};
    transactions.sort(compareDate);
    pushUndo({type:'edit', transaction: cloneTransaction(transactions[idx]), oldTransaction});
    saveData();
    renderLedger();
    showMessage('Transaction edited.', false);
  }

  // Remove transaction
  function removeTransaction(id) {
    const idx = transactions.findIndex(t => t.id === id);
    if (idx === -1) {
      showMessage('Transaction ID not found.');
      return;
    }
    const removed = transactions.splice(idx, 1);
    pushUndo({type:'remove', transaction: cloneTransaction(removed)});
    saveData();
    renderLedger();
    showMessage('Transaction removed.', false);
  }

  // Prompt helpers
  async function promptTransactionId(actionName) {
    return new Promise(resolve => {
      let id = prompt(`Enter transaction ID to ${actionName}:`);
      if (id) id = id.trim();
      resolve(id || null);
    });
  }

  // Keyboard navigation for dialog: trap focus inside form dialog
  function trapFocus(element) {
    const focusableElements = element.querySelectorAll('input, button, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusableElements.length === 0) return;
    const firstEl = focusableElements;
    const lastEl = focusableElements[focusableElements.length - 1];
    element.addEventListener('keydown', e => {
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstEl) {
            e.preventDefault();
            lastEl.focus();
          }
        } else {
          if (document.activeElement === lastEl) {
            e.preventDefault();
            firstEl.focus();
          }
        }
      } else if (e.key === 'Escape') {
        closeFormDialog();
      }
    });
  }

  // Auto theme based on system time (local)
  function applyAutoTheme() {
    const hour = new Date().getHours();
    // Light theme between 7am and 7pm, dark otherwise
    if (hour >= 7 && hour < 19) {
      document.body.classList.remove('dark');
    } else {
      document.body.classList.add('dark');
    }
  }

  // Event handlers
  prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderLedger();
    }
  });
  nextPageBtn.addEventListener('click', () => {
    const data = getDisplayedTransactions();
    const totalPages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
    if (currentPage < totalPages) {
      currentPage++;
      renderLedger();
    }
  });
  filterApplyBtn.addEventListener('click', () => {
    applyFilter();
  });
  filterClearBtn.addEventListener('click', () => {
    clearFilter();
  });
  addBtn.addEventListener('click', () => {
    openFormDialog('add');
  });
  editBtn.addEventListener('click', async () => {
    const id = await promptTransactionId('edit');
    if (!id) return;
    const t = transactions.find(t => t.id === id);
    if (!t) {
      showMessage('Transaction ID not found.');
      return;
    }
    openFormDialog('edit', t);
  });
  removeBtn.addEventListener('click', async () => {
    const id = await promptTransactionId('remove');
    if (!id) return;
    if (!transactions.find(t => t.id === id)) {
      showMessage('Transaction ID not found.');
      return;
    }
    if (confirm(`Are you sure you want to remove transaction ID ${id}?`)) {
      removeTransaction(id);
    }
  });
  undoBtn.addEventListener('click', () => {
    undo();
  });
  redoBtn.addEventListener('click', () => {
    redo();
  });
  summaryBtn.addEventListener('click', () => {
    renderSummary();
  });
  exitBtn.addEventListener('click', () => {
    if (confirm('Exit the application? Unsaved changes are saved automatically.')) {
      window.close();
    }
  });

  formCancel.addEventListener('click', e => {
    e.preventDefault();
    closeFormDialog();
  });

  form.addEventListener('submit', e => {
    e.preventDefault();
    const id = formId.value;
    const date = formDate.value;
    const category = formCategory.value.trim();
    const description = formDescription.value.trim();
    const amountStr = formAmount.value.trim();

    if (!date || !category || !description || !amountStr) {
      showMessage('All fields are required.');
      return;
    }
    const dateObj = parseDate(date);
    if (!dateObj) {
      showMessage('Invalid date format.');
      return;
    }
    const amount = Number(amountStr);
    if (isNaN(amount) || amount === 0) {
      showMessage('Amount must be a non-zero number.');
      return;
    }

    if (id) {
      // Edit existing
      editTransaction(id, {date, category, description, amount});
    } else {
      // Add new
      const newTransaction = {
        id: generateId(),
        date,
        category,
        description,
        amount
      };
      addTransaction(newTransaction);
    }
    closeFormDialog();
  });

  // Initialization
  function init() {
    applyAutoTheme();
    loadData();
    renderLedger();
    trapFocus(formDialog);
  }

  window.addEventListener('load', init);
  window.addEventListener('storage', () => {
    // Reload data if changed in another tab
    loadData();
    renderLedger();
  });
})();
</script>
</body>
</html>
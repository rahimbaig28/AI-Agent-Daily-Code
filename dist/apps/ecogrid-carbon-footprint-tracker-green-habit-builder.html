<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-11-23T13:22:24.159699Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EcoGrid: Carbon Footprint Tracker & Green Habit Builder</title>
<style>
  :root {
    --green-dark: #2a5d34;
    --green-medium: #4caf50;
    --green-light: #a8d5a3;
    --earth-dark: #5d4a1a;
    --earth-medium: #bfa76f;
    --earth-light: #f0e6c8;
    --bg: #f9f9f7;
    --text-dark: #222;
    --text-light: #555;
    --focus-outline: 3px solid #4caf50;
    --font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  html {
    font-size: 16px;
    background: var(--bg);
    color: var(--text-dark);
    font-family: var(--font-family);
    line-height: 1.4;
  }
  body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  h1, h2, h3 {
    margin: 0 0 0.25em 0;
    font-weight: 600;
    color: var(--green-dark);
  }
  h1 {
    font-size: 1.75rem;
  }
  h2 {
    font-size: 1.25rem;
  }
  h3 {
    font-size: 1rem;
  }
  main {
    flex: 1 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    padding: 1rem;
    max-width: 1200px;
    margin: 0 auto;
  }
  @media(min-width: 600px) {
    main {
      grid-template-columns: 1fr 1fr;
    }
  }
  @media(min-width: 900px) {
    main {
      grid-template-columns: 2fr 1fr 1fr;
    }
  }
  section {
    background: white;
    border-radius: 6px;
    box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
    padding: 1rem;
    display: flex;
    flex-direction: column;
  }
  /* Focus styles for keyboard users */
  button:focus,
  input:focus,
  select:focus,
  textarea:focus,
  [tabindex]:focus {
    outline: var(--focus-outline);
    outline-offset: 2px;
  }
  /* Buttons */
  button {
    background-color: var(--green-medium);
    border: none;
    color: white;
    padding: 0.4em 0.8em;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    user-select: none;
  }
  button[aria-pressed="true"] {
    background-color: var(--green-dark);
  }
  button:disabled {
    background-color: var(--earth-medium);
    cursor: not-allowed;
  }
  button:hover:not(:disabled),
  button:focus:not(:disabled) {
    background-color: var(--green-dark);
  }
  /* Inputs */
  input[type="text"],
  input[type="number"],
  select,
  input[type="date"] {
    border: 1px solid var(--earth-medium);
    border-radius: 4px;
    padding: 0.3em 0.5em;
    font-size: 1rem;
    color: var(--text-dark);
    background: white;
  }
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    margin: 0;
    -webkit-appearance: none;
  }
  label {
    font-weight: 600;
    margin-bottom: 0.2em;
    display: inline-block;
  }
  /* Grid for activity inputs */
  .activity-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 2fr auto;
    gap: 0.5rem;
    align-items: center;
  }
  @media(max-width: 500px) {
    .activity-grid {
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }
    .activity-grid > * {
      width: 100%;
    }
  }
  /* Habit list */
  .habit-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 300px;
    overflow-y: auto;
  }
  .habit-list li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--earth-light);
    padding: 0.5em 0;
  }
  .habit-list li:last-child {
    border-bottom: none;
  }
  .habit-desc {
    flex: 1;
    margin-right: 1em;
    color: var(--text-dark);
  }
  .habit-toggle {
    flex-shrink: 0;
  }
  /* Dashboard charts container */
  .dashboard {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .chart {
    background: var(--earth-light);
    border-radius: 6px;
    padding: 1rem;
  }
  .chart svg {
    width: 100%;
    height: 150px;
  }
  /* Table for activities */
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 0.3em 0.5em;
    border-bottom: 1px solid var(--earth-light);
    text-align: left;
  }
  th {
    background-color: var(--earth-light);
    color: var(--green-dark);
  }
  /* Controls container */
  .controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.5rem;
  }
  /* Toggle habit panel */
  #habit-panel[hidden] {
    display: none;
  }
  /* Scrollbar for habit list */
  .habit-list::-webkit-scrollbar {
    width: 8px;
  }
  .habit-list::-webkit-scrollbar-thumb {
    background-color: var(--green-medium);
    border-radius: 4px;
  }
  /* Visually hidden for screen reader only text */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    border: 0;
  }
</style>
</head>
<body>
<header role="banner" aria-label="EcoGrid application header" style="background: var(--green-dark); color: white; padding: 1rem;">
  <h1>EcoGrid: Carbon Footprint Tracker & Green Habit Builder</h1>
</header>
<main role="main" aria-label="Main application content">
  <section id="activity-section" aria-labelledby="activity-section-title" tabindex="0">
    <h2 id="activity-section-title">Daily Activities</h2>
    <div class="controls" role="region" aria-label="Activity controls">
      <label for="date-input">Date:</label>
      <input type="date" id="date-input" aria-describedby="date-desc" />
      <span id="date-desc" class="sr-only">Select date to view or log activities</span>
      <button id="add-activity-btn" aria-label="Add new activity entry (Ctrl+N)">Add Activity</button>
    </div>
    <form id="activity-form" aria-label="Add or edit activity" hidden>
      <div class="activity-grid">
        <label for="activity-type" class="sr-only">Activity Type</label>
        <select id="activity-type" required aria-required="true" aria-label="Activity type">
          <option value="" disabled selected>Select activity type</option>
        </select>
        <label for="activity-amount" class="sr-only">Amount</label>
        <input type="number" id="activity-amount" min="0" step="any" required aria-required="true" aria-label="Amount or quantity" placeholder="Amount" />
        <label for="activity-unit" class="sr-only">Unit</label>
        <select id="activity-unit" required aria-required="true" aria-label="Unit of measurement">
          <option value="" disabled selected>Select unit</option>
        </select>
        <label for="activity-note" class="sr-only">Note</label>
        <input type="text" id="activity-note" aria-label="Additional notes or description" placeholder="Note (optional)" />
        <div>
          <button type="submit" id="save-activity-btn">Save</button>
          <button type="button" id="cancel-activity-btn">Cancel</button>
        </div>
      </div>
    </form>
    <div role="region" aria-live="polite" aria-atomic="true" id="activity-list-region">
      <table aria-label="Logged activities for selected date" id="activity-table" tabindex="0">
        <thead>
          <tr>
            <th scope="col">Activity</th>
            <th scope="col">Amount</th>
            <th scope="col">Unit</th>
            <th scope="col">CO₂e (kg)</th>
            <th scope="col">Note</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="activity-tbody">
          <!-- Activities inserted here -->
        </tbody>
      </table>
    </div>
  </section>
  <section id="habit-section" aria-labelledby="habit-section-title" tabindex="0" hidden>
    <h2 id="habit-section-title">Green Habit Suggestions</h2>
    <ul class="habit-list" role="list" id="habit-list" tabindex="0" aria-live="polite" aria-relevant="additions removals">
      <!-- Habit items inserted here -->
    </ul>
  </section>
  <section id="dashboard-section" aria-labelledby="dashboard-section-title" tabindex="0">
    <h2 id="dashboard-section-title">Summary Dashboard</h2>
    <div class="dashboard" role="region" aria-label="Carbon footprint summary charts">
      <section class="chart" aria-labelledby="daily-total-title">
        <h3 id="daily-total-title">Daily Carbon Footprint (kg CO₂e)</h3>
        <svg id="daily-total-chart" role="img" aria-label="Bar chart of daily carbon footprint"></svg>
      </section>
      <section class="chart" aria-labelledby="weekly-trend-title">
        <h3 id="weekly-trend-title">Weekly Carbon Footprint Trend (kg CO₂e)</h3>
        <svg id="weekly-trend-chart" role="img" aria-label="Line chart of weekly carbon footprint trend"></svg>
      </section>
      <section class="chart" aria-labelledby="habit-progress-title">
        <h3 id="habit-progress-title">Habit Adoption Progress</h3>
        <svg id="habit-progress-chart" role="img" aria-label="Progress chart of adopted habits"></svg>
      </section>
    </div>
  </section>
</main>
<footer role="contentinfo" style="text-align:center; padding:1rem; font-size:0.875rem; color: var(--text-light);">
  &copy; 2025 EcoGrid. All rights reserved.
</footer>
<script>
(() => {
  "use strict";

  // Emission factors (kg CO2e per unit) for preloaded activities
  // Units: km for transport, kWh for energy, servings for diet, kg for waste
  const EMISSION_FACTORS = {
    transport: {
      car: 0.192, // per km (average petrol car)
      bus: 0.105, // per km
      train: 0.041, // per km
      bike: 0, // per km
      walk: 0, // per km
      flight_short: 0.255, // per km short haul
      flight_long: 0.195, // per km long haul
    },
    energy: {
      electricity: 0.475, // per kWh (average grid)
      natural_gas: 2.204, // per m3
      heating_oil: 2.68, // per liter
    },
    diet: {
      beef: 27, // per serving (~0.25kg)
      chicken: 6.9,
      vegetables: 2,
      dairy: 3,
      fish: 6,
      grains: 1.5,
    },
    waste: {
      landfill: 1.9, // per kg
      recycle: 0.2, // per kg
      compost: 0.1, // per kg
    }
  };

  // Preloaded activity types with units and categories
  const PRELOADED_ACTIVITIES = [
    { id: "car", label: "Car travel", category: "transport", unit: "km" },
    { id: "bus", label: "Bus travel", category: "transport", unit: "km" },
    { id: "train", label: "Train travel", category: "transport", unit: "km" },
    { id: "bike", label: "Bike travel", category: "transport", unit: "km" },
    { id: "walk", label: "Walking", category: "transport", unit: "km" },
    { id: "flight_short", label: "Short-haul flight", category: "transport", unit: "km" },
    { id: "flight_long", label: "Long-haul flight", category: "transport", unit: "km" },
    { id: "electricity", label: "Electricity use", category: "energy", unit: "kWh" },
    { id: "natural_gas", label: "Natural gas use", category: "energy", unit: "m³" },
    { id: "heating_oil", label: "Heating oil use", category: "energy", unit: "liters" },
    { id: "beef", label: "Beef servings", category: "diet", unit: "servings" },
    { id: "chicken", label: "Chicken servings", category: "diet", unit: "servings" },
    { id: "vegetables", label: "Vegetable servings", category: "diet", unit: "servings" },
    { id: "dairy", label: "Dairy servings", category: "diet", unit: "servings" },
    { id: "fish", label: "Fish servings", category: "diet", unit: "servings" },
    { id: "grains", label: "Grain servings", category: "diet", unit: "servings" },
    { id: "landfill", label: "Landfill waste", category: "waste", unit: "kg" },
    { id: "recycle", label: "Recycled waste", category: "waste", unit: "kg" },
    { id: "compost", label: "Composted waste", category: "waste", unit: "kg" },
  ];

  // Habit suggestions based on activities and reduction potential
  // Each habit linked to categories and activity ids it can reduce
  const HABIT_SUGGESTIONS = [
    {
      id: "reduce_car",
      description: "Reduce car travel by using public transport, biking, or walking",
      relatedActivities: ["car"],
      reductionFactor: 0.5,
    },
    {
      id: "use_public_transport",
      description: "Use bus or train instead of car when possible",
      relatedActivities: ["car", "bus", "train"],
      reductionFactor: 0.3,
    },
    {
      id: "reduce_flights",
      description: "Limit short and long-haul flights",
      relatedActivities: ["flight_short", "flight_long"],
      reductionFactor: 0.7,
    },
    {
      id: "reduce_meat",
      description: "Eat less beef and chicken, increase plant-based meals",
      relatedActivities: ["beef", "chicken"],
      reductionFactor: 0.6,
    },
    {
      id: "reduce_dairy",
      description: "Reduce dairy consumption",
      relatedActivities: ["dairy"],
      reductionFactor: 0.4,
    },
    {
      id: "energy_efficiency",
      description: "Reduce electricity and heating energy use",
      relatedActivities: ["electricity", "natural_gas", "heating_oil"],
      reductionFactor: 0.4,
    },
    {
      id: "waste_reduction",
      description: "Reduce landfill waste and increase recycling and composting",
      relatedActivities: ["landfill"],
      reductionFactor: 0.5,
    },
  ];

  // LocalStorage keys
  const STORAGE_KEYS = {
    activities: "ecogrid_activities",
    habits: "ecogrid_habits",
    preferences: "ecogrid_preferences",
  };

  // DOM Elements
  const dateInput = document.getElementById("date-input");
  const addActivityBtn = document.getElementById("add-activity-btn");
  const activityForm = document.getElementById("activity-form");
  const activityTypeSelect = document.getElementById("activity-type");
  const activityAmountInput = document.getElementById("activity-amount");
  const activityUnitSelect = document.getElementById("activity-unit");
  const activityNoteInput = document.getElementById("activity-note");
  const saveActivityBtn = document.getElementById("save-activity-btn");
  const cancelActivityBtn = document.getElementById("cancel-activity-btn");
  const activityTbody = document.getElementById("activity-tbody");
  const habitSection = document.getElementById("habit-section");
  const habitList = document.getElementById("habit-list");
  const dashboardSection = document.getElementById("dashboard-section");
  const dailyTotalChart = document.getElementById("daily-total-chart");
  const weeklyTrendChart = document.getElementById("weekly-trend-chart");
  const habitProgressChart = document.getElementById("habit-progress-chart");

  // Live regions for screen reader announcements
  const activityListRegion = document.getElementById("activity-list-region");

  // State
  let activities = {}; // { date: [ {id, type, amount, note} ] }
  let habits = {}; // { habitId: adopted (bool) }
  let preferences = {}; // future use
  let editingActivity = null; // {date, id} or null
  let currentDate = null;

  // Utility: generate unique id for activities
  function generateId() {
    return "id-" + Math.random().toString(36).slice(2, 10);
  }

  // Initialize date input to current UTC date
  function setDateToToday() {
    const now = new Date();
    const yyyy = now.getUTCFullYear();
    const mm = String(now.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(now.getUTCDate()).padStart(2, "0");
    const today = `${yyyy}-${mm}-${dd}`;
    dateInput.value = today;
    currentDate = today;
  }

  // Load data from localStorage
  function loadData() {
    try {
      const storedActivities = localStorage.getItem(STORAGE_KEYS.activities);
      activities = storedActivities ? JSON.parse(storedActivities) : {};
    } catch {
      activities = {};
    }
    try {
      const storedHabits = localStorage.getItem(STORAGE_KEYS.habits);
      habits = storedHabits ? JSON.parse(storedHabits) : {};
    } catch {
      habits = {};
    }
    try {
      const storedPrefs = localStorage.getItem(STORAGE_KEYS.preferences);
      preferences = storedPrefs ? JSON.parse(storedPrefs) : {};
    } catch {
      preferences = {};
    }
  }

  // Save data to localStorage
  function saveData() {
    localStorage.setItem(STORAGE_KEYS.activities, JSON.stringify(activities));
    localStorage.setItem(STORAGE_KEYS.habits, JSON.stringify(habits));
    localStorage.setItem(STORAGE_KEYS.preferences, JSON.stringify(preferences));
  }

  // Populate activity type select options
  function populateActivityTypes() {
    PRELOADED_ACTIVITIES.forEach(act => {
      const opt = document.createElement("option");
      opt.value = act.id;
      opt.textContent = act.label;
      activityTypeSelect.appendChild(opt);
    });
  }

  // Update unit select based on selected activity type
  function updateUnitSelect() {
    const selectedType = activityTypeSelect.value;
    const act = PRELOADED_ACTIVITIES.find(a => a.id === selectedType);
    activityUnitSelect.innerHTML = "";
    if (act) {
      const opt = document.createElement("option");
      opt.value = act.unit;
      opt.textContent = act.unit;
      opt.selected = true;
      activityUnitSelect.appendChild(opt);
      activityUnitSelect.disabled = true;
    } else {
      activityUnitSelect.disabled = false;
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select unit";
      placeholder.disabled = true;
      placeholder.selected = true;
      activityUnitSelect.appendChild(placeholder);
    }
  }

  // Calculate CO2e for an activity entry
  function calculateCO2e(activity) {
    const { type, amount } = activity;
    if (!type || !amount || amount <= 0) return 0;
    // Find emission factor
    for (const cat in EMISSION_FACTORS) {
      if (EMISSION_FACTORS[cat][type] !== undefined) {
        return amount * EMISSION_FACTORS[cat][type];
      }
    }
    return 0;
  }

  // Render activities table for currentDate
  function renderActivities() {
    const dayActivities = activities[currentDate] || [];
    activityTbody.innerHTML = "";
    if (dayActivities.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.textContent = "No activities logged for this date.";
      td.style.textAlign = "center";
      tr.appendChild(td);
      activityTbody.appendChild(tr);
      announceActivityList("No activities logged for this date.");
      return;
    }
    dayActivities.forEach((act, i) => {
      const tr = document.createElement("tr");
      // Activity label
      const actDef = PRELOADED_ACTIVITIES.find(a => a.id === act.type);
      const label = actDef ? actDef.label : act.type;
      const tdLabel = document.createElement("td");
      tdLabel.textContent = label;
      tr.appendChild(tdLabel);
      // Amount
      const tdAmount = document.createElement("td");
      tdAmount.textContent = act.amount;
      tr.appendChild(tdAmount);
      // Unit
      const tdUnit = document.createElement("td");
      tdUnit.textContent = act.unit || (actDef ? actDef.unit : "");
      tr.appendChild(tdUnit);
      // CO2e
      const tdCO2e = document.createElement("td");
      const co2e = calculateCO2e(act);
      tdCO2e.textContent = co2e.toFixed(2);
      tr.appendChild(tdCO2e);
      // Note
      const tdNote = document.createElement("td");
      tdNote.textContent = act.note || "";
      tr.appendChild(tdNote);
      // Actions
      const tdActions = document.createElement("td");
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.setAttribute("aria-label", `Edit activity ${label}`);
      editBtn.addEventListener("click", () => startEditActivity(i));
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.setAttribute("aria-label", `Delete activity ${label}`);
      delBtn.addEventListener("click", () => deleteActivity(i));
      tdActions.appendChild(editBtn);
      tdActions.appendChild(delBtn);
      tdActions.style.display = "flex";
      tdActions.style.gap = "0.25rem";
      tr.appendChild(tdActions);
      activityTbody.appendChild(tr);
    });
    announceActivityList(`${dayActivities.length} activities loaded.`);
  }

  // Announce activity list changes for screen readers
  function announceActivityList(message) {
    activityListRegion.textContent = message;
  }

  // Start adding a new activity
  function startAddActivity() {
    editingActivity = null;
    activityForm.reset();
    activityUnitSelect.disabled = true;
    activityForm.hidden = false;
    activityTypeSelect.focus();
  }

  // Start editing an existing activity by index
  function startEditActivity(index) {
    const dayActivities = activities[currentDate] || [];
    if (!dayActivities[index]) return;
    editingActivity = { date: currentDate, id: dayActivities[index].id, index };
    const act = dayActivities[index];
    activityTypeSelect.value = act.type;
    updateUnitSelect();
    activityAmountInput.value = act.amount;
    activityNoteInput.value = act.note || "";
    activityForm.hidden = false;
    activityTypeSelect.focus();
  }

  // Cancel add/edit activity
  function cancelActivity() {
    editingActivity = null;
    activityForm.hidden = true;
    addActivityBtn.focus();
  }

  // Save activity from form
  function saveActivity(e) {
    e.preventDefault();
    const type = activityTypeSelect.value;
    const amount = parseFloat(activityAmountInput.value);
    const unit = activityUnitSelect.value;
    const note = activityNoteInput.value.trim();
    if (!type || isNaN(amount) || amount <= 0) return;
    if (!activities[currentDate]) activities[currentDate] = [];
    if (editingActivity) {
      // Edit existing
      activities[currentDate][editingActivity.index] = {
        id: editingActivity.id,
        type,
        amount,
        unit,
        note,
      };
    } else {
      // Add new
      activities[currentDate].push({
        id: generateId(),
        type,
        amount,
        unit,
        note,
      });
    }
    saveData();
    renderActivities();
    updateHabitSuggestions();
    updateDashboard();
    cancelActivity();
  }

  // Delete activity by index
  function deleteActivity(index) {
    if (!activities[currentDate]) return;
    activities[currentDate].splice(index, 1);
    if (activities[currentDate].length === 0) delete activities[currentDate];
    saveData();
    renderActivities();
    updateHabitSuggestions();
    updateDashboard();
  }

  // Update habit suggestions based on logged activities
  function updateHabitSuggestions() {
    // Compute total emissions per activity type for currentDate
    const dayActivities = activities[currentDate] || [];
    const emissionsByType = {};
    dayActivities.forEach(act => {
      const co2e = calculateCO2e(act);
      if (!emissionsByType[act.type]) emissionsByType[act.type] = 0;
      emissionsByType[act.type] += co2e;
    });
    // Filter habits that relate to activities with emissions > 0
    const relevantHabits = HABIT_SUGGESTIONS.filter(habit => {
      return habit.relatedActivities.some(actType => emissionsByType[actType] > 0);
    });
    // Render habit list
    habitList.innerHTML = "";
    if (relevantHabits.length === 0) {
      habitSection.hidden = true;
      return;
    }
    habitSection.hidden = false;
    relevantHabits.forEach(habit => {
      const li = document.createElement("li");
      li.tabIndex = 0;
      const desc = document.createElement("span");
      desc.className = "habit-desc";
      desc.textContent = habit.description;
      const toggleBtn = document.createElement("button");
      toggleBtn.className = "habit-toggle";
      toggleBtn.setAttribute("aria-pressed", habits[habit.id] ? "true" : "false");
      toggleBtn.setAttribute("aria-label", `${habit.description}, mark as adopted`);
      toggleBtn.textContent = habits[habit.id] ? "Adopted" : "Mark Adopted";
      toggleBtn.addEventListener("click", () => {
        habits[habit.id] = !habits[habit.id];
        toggleBtn.setAttribute("aria-pressed", habits[habit.id] ? "true" : "false");
        toggleBtn.textContent = habits[habit.id] ? "Adopted" : "Mark Adopted";
        saveData();
        updateDashboard();
        announceHabitChange(habit.description, habits[habit.id]);
      });
      li.appendChild(desc);
      li.appendChild(toggleBtn);
      habitList.appendChild(li);
    });
  }

  // Announce habit adoption changes for screen readers
  function announceHabitChange(desc, adopted) {
    const liveRegion = document.createElement("div");
    liveRegion.className = "sr-only";
    liveRegion.setAttribute("aria-live", "polite");
    liveRegion.textContent = adopted ? `Habit adopted: ${desc}` : `Habit unadopted: ${desc}`;
    document.body.appendChild(liveRegion);
    setTimeout(() => document.body.removeChild(liveRegion), 1000);
  }

  // Calculate total emissions for a given date
  function totalEmissionsForDate(date) {
    const dayActivities = activities[date] || [];
    return dayActivities.reduce((sum, act) => sum + calculateCO2e(act), 0);
  }

  // Get last 7 dates including currentDate in YYYY-MM-DD format
  function getLast7Dates() {
    const dates = [];
    const baseDate = new Date(currentDate + "T00:00:00Z");
    for (let i = 6; i >= 0; i--) {
      const d = new Date(baseDate);
      d.setUTCDate(d.getUTCDate() - i);
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(d.getUTCDate()).padStart(2, "0");
      dates.push(`${yyyy}-${mm}-${dd}`);
    }
    return dates;
  }

  // Update dashboard charts
  function updateDashboard() {
    updateDailyTotalChart();
    updateWeeklyTrendChart();
    updateHabitProgressChart();
  }

  // Draw daily total bar chart (single day)
  function updateDailyTotalChart() {
    const width = dailyTotalChart.clientWidth || 300;
    const height = 150;
    const margin = { top: 20, right: 20, bottom: 30, left: 40 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;
    const total = totalEmissionsForDate(currentDate);

    dailyTotalChart.innerHTML = "";
    dailyTotalChart.setAttribute("width", width);
    dailyTotalChart.setAttribute("height", height);

    // Axis labels
    const ns = document.createElementNS("http://www.w3.org/2000/svg", "text");
    ns.setAttribute("x", width / 2);
    ns.setAttribute("y", height - 5);
    ns.setAttribute("text-anchor", "middle");
    ns.setAttribute("fill", "var(--green-dark)");
    ns.textContent = currentDate;
    dailyTotalChart.appendChild(ns);

    // Bar height proportional to total (max 50 kg for scale)
    const maxVal = 50;
    const barHeight = Math.min(innerHeight, (total / maxVal) * innerHeight);

    // Bar
    const bar = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    bar.setAttribute("x", margin.left);
    bar.setAttribute("y", margin.top + innerHeight - barHeight);
    bar.setAttribute("width", innerWidth);
    bar.setAttribute("height", barHeight);
    bar.setAttribute("fill", "var(--green-medium)");
    dailyTotalChart.appendChild(bar);

    // Text label on bar
    const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
    label.setAttribute("x", margin.left + innerWidth / 2);
    label.setAttribute("y", margin.top + innerHeight - barHeight - 5);
    label.setAttribute("text-anchor", "middle");
    label.setAttribute("fill", "var(--earth-dark)");
    label.setAttribute("font-weight", "bold");
    label.textContent = total.toFixed(2) + " kg";
    dailyTotalChart.appendChild(label);
  }

  // Draw weekly trend line chart
  function updateWeeklyTrendChart() {
    const width = weeklyTrendChart.clientWidth || 300;
    const height = 150;
    const margin = { top: 20, right: 30, bottom: 30, left: 40 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    weeklyTrendChart.innerHTML = "";
    weeklyTrendChart.setAttribute("width", width);
    weeklyTrendChart.setAttribute("height", height);

    const dates = getLast7Dates();
    const data = dates.map(d => ({ date: d, value: totalEmissionsForDate(d) }));
    const maxVal = Math.max(...data.map(d => d.value), 10);

    // Axes lines
    const nsLine = (x1, y1, x2, y2) => {
      const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
      l.setAttribute("x1", x1);
      l.setAttribute("y1", y1);
      l.setAttribute("x2", x2);
      l.setAttribute("y2", y2);
      l.setAttribute("stroke", "var(--earth-dark)");
      l.setAttribute("stroke-width", "1");
      return l;
    };
    weeklyTrendChart.appendChild(nsLine(margin.left, margin.top, margin.left, height - margin.bottom));
    weeklyTrendChart.appendChild(nsLine(margin.left, height - margin.bottom, width - margin.right, height - margin.bottom));

    // X axis labels
    dates.forEach((d, i) => {
      const x = margin.left + (i * innerWidth) / (dates.length - 1);
      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", x);
      text.setAttribute("y", height - 8);
      text.setAttribute("text-anchor", "middle");
      text.setAttribute("fill", "var(--green-dark)");
      text.setAttribute("font-size", "0.7rem");
      text.textContent = d.slice(5);
      weeklyTrendChart.appendChild(text);
    });

    // Y axis labels (0, maxVal/2, maxVal)
    [0, maxVal / 2, maxVal].forEach((val) => {
      const y = margin.top + innerHeight - (val / maxVal) * innerHeight;
      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", margin.left - 5);
      text.setAttribute("y", y + 4);
      text.setAttribute("text-anchor", "end");
      text.setAttribute("fill", "var(--green-dark)");
      text.setAttribute("font-size", "0.7rem");
      text.textContent = val.toFixed(0);
      weeklyTrendChart.appendChild(text);
      // Horizontal grid line
      const line = nsLine(margin.left, y, width - margin.right, y);
      line.setAttribute("stroke-dasharray", "2,2");
      line.setAttribute("stroke-opacity", "0.3");
      weeklyTrendChart.appendChild(line);
    });

    // Line path
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    let d = "";
    data.forEach((point, i) => {
      const x = margin.left + (i * innerWidth) / (dates.length - 1);
      const y = margin.top + innerHeight - (point.value / maxVal) * innerHeight;
      d += (i === 0 ? "M" : "L") + x + " " + y + " ";
    });
    path.setAttribute("d", d.trim());
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", "var(--green-medium)");
    path.setAttribute("stroke-width", "3");
    weeklyTrendChart.appendChild(path);

    // Points
    data.forEach((point, i) => {
      const x = margin.left + (i * innerWidth) / (dates.length - 1);
      const y = margin.top + innerHeight - (point.value / maxVal) * innerHeight;
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", x);
      circle.setAttribute("cy", y);
      circle.setAttribute("r", 4);
      circle.setAttribute("fill", "var(--green-dark)");
      weeklyTrendChart.appendChild(circle);
    });
  }

  // Draw habit progress chart (adopted habits vs total)
  function updateHabitProgressChart() {
    const width = habitProgressChart.clientWidth || 300;
    const height = 150;
    const margin = { top: 20, right: 20, bottom: 30, left: 40 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    habitProgressChart.innerHTML = "";
    habitProgressChart.setAttribute("width", width);
    habitProgressChart.setAttribute("height", height);

    const relevantHabits = HABIT_SUGGESTIONS.filter(habit => {
      // Only habits relevant to current activities
      const dayActivities = activities[currentDate] || [];
      const emissionsByType = {};
      dayActivities.forEach(act => {
        const co2e = calculateCO2e(act);
        if (!emissionsByType[act.type]) emissionsByType[act.type] = 0;
        emissionsByType[act.type] += co2e;
      });
      return habit.relatedActivities.some(actType => emissionsByType[actType] > 0);
    });

    const totalHabits = relevantHabits.length;
    const adoptedHabits = relevantHabits.filter(h => habits[h.id]).length;
    if (totalHabits === 0) {
      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", width / 2);
      text.setAttribute("y", height / 2);
      text.setAttribute("text-anchor", "middle");
      text.setAttribute("fill", "var(--earth-dark)");
      text.textContent = "No habits suggested";
      habitProgressChart.appendChild(text);
      return;
    }

    // Draw progress bar background
    const bgRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    bgRect.setAttribute("x", margin.left);
    bgRect.setAttribute("y", margin.top + innerHeight / 3);
    bgRect.setAttribute("width", innerWidth);
    bgRect.setAttribute("height", innerHeight / 3);
    bgRect.setAttribute("fill", "var(--earth-light)");
    bgRect.setAttribute("rx", 8);
    habitProgressChart.appendChild(bgRect);

    // Draw progress bar foreground
    const progressWidth = (adoptedHabits / totalHabits) * innerWidth;
    const fgRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    fgRect.setAttribute("x", margin.left);
    fgRect.setAttribute("y", margin.top + innerHeight / 3);
    fgRect.setAttribute("width", progressWidth);
    fgRect.setAttribute("height", innerHeight / 3);
    fgRect.setAttribute("fill", "var(--green-medium)");
    fgRect.setAttribute("rx", 8);
    habitProgressChart.appendChild(fgRect);

    // Text label
    const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
    label.setAttribute("x", width / 2);
    label.setAttribute("y", margin.top + innerHeight / 2 + 5);
    label.setAttribute("text-anchor", "middle");
    label.setAttribute("fill", "var(--earth-dark)");
    label.setAttribute("font-weight", "bold");
    label.textContent = `${adoptedHabits} of ${totalHabits} habits adopted`;
    habitProgressChart.appendChild(label);
  }

  // Toggle habit panel visibility
  function toggleHabitPanel() {
    if (habitSection.hidden) {
      habitSection.hidden = false;
      habitSection.focus();
    } else {
      habitSection.hidden = true;
      addActivityBtn.focus();
    }
  }

  // Keyboard shortcuts handler
  function handleKeyboardShortcuts(e) {
    if (e.ctrlKey && !e.shiftKey && !e.altKey) {
      switch (e.key.toLowerCase()) {
        case "n":
          e.preventDefault();
          startAddActivity();
          break;
        case "h":
          e.preventDefault();
          toggleHabitPanel();
          break;
      }
    }
  }

  // Keyboard arrow navigation for activity table and habit list
  function setupArrowNavigation() {
    // Activity table rows navigation
    activityTbody.addEventListener("keydown", e => {
      const rows = Array.from(activityTbody.querySelectorAll("tr"));
      const current = document.activeElement.closest("tr");
      if (!current) return;
      const idx = rows.indexOf(current);
      if (idx === -1) return;
      if (e.key === "ArrowDown") {
        e.preventDefault();
        const next = rows[idx + 1] || rows;
        next.querySelector("button, td").focus();
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        const prev = rows[idx - 1] || rows[rows.length - 1];
        prev.querySelector("button, td").focus();
      }
    });
    // Habit list items navigation
    habitList.addEventListener("keydown", e => {
      const items = Array.from(habitList.querySelectorAll("li"));
      const current = document.activeElement.closest("li");
      if (!current) return;
      const idx = items.indexOf(current);
      if (idx === -1) return;
      if (e.key === "ArrowDown") {
        e.preventDefault();
        const next = items[idx + 1] || items;
        next.focus();
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        const prev = items[idx - 1] || items[items.length - 1];
        prev.focus();
      }
    });
  }

  // On activity type change, update unit select
  activityTypeSelect.addEventListener("change", updateUnitSelect);

  // On date change, update currentDate and refresh UI
  dateInput.addEventListener("change", () => {
    if (!dateInput.value) return;
    currentDate = dateInput.value;
    renderActivities();
    updateHabitSuggestions();
    updateDashboard();
  });

  // Add activity button click
  addActivityBtn.addEventListener("click", startAddActivity);

  // Cancel activity form
  cancelActivityBtn.addEventListener("click", cancelActivity);

  // Save activity form submit
  activityForm.addEventListener("submit", saveActivity);

  // Keyboard shortcuts
  window.addEventListener("keydown", handleKeyboardShortcuts);

  // Initialize app
  function init() {
    loadData();
    setDateToToday();
    populateActivityTypes();
    updateUnitSelect();
    renderActivities();
    updateHabitSuggestions();
    updateDashboard();
    setupArrowNavigation();
  }

  init();
})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-12-24T08:29:03.296680Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pocket Sprint</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1a1a1a;
      --accent: #007acc;
      --success: #10b981;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --radius: 8px;
      --font-size: 1rem;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f0f0f;
        --fg: #f3f4f6;
        --accent: #3b82f6;
        --success: #34d399;
        --muted: #9ca3af;
        --border: #374151;
      }
    }
    [data-theme="dark"] {
      --bg: #0f0f0f;
      --fg: #f3f4f6;
      --accent: #3b82f6;
      --success: #34d399;
      --muted: #9ca3af;
      --border: #374151;
    }
    [data-theme="light"] {
      --bg: #ffffff;
      --fg: #1a1a1a;
      --accent: #007acc;
      --success: #10b981;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      font-size: var(--font-size);
      line-height: 1.5;
      transition: all 0.2s ease;
    }
    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; }
    }
    .app { min-height: 100vh; display: flex; flex-direction: column; max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .title { font-size: 1.5rem; font-weight: 700; }
    .main { display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem; flex: 1; }
    @media (max-width: 768px) { .main { grid-template-columns: 1fr; } }
    .sprint-section, .sidebar { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; }
    @media (prefers-color-scheme: dark) { .sprint-section, .sidebar { background: rgba(255,255,255,0.03); } }
    .timer-display { text-align: center; margin: 2rem 0; }
    .time { font-size: 4rem; font-weight: 300; font-variant-numeric: tabular-nums; margin-bottom: 0.5rem; }
    .progress-ring { width: 200px; height: 200px; margin: 1rem auto; position: relative; }
    .progress-ring circle { fill: none; stroke: var(--border); stroke-width: 8; r: 85; cx: 100; cy: 100; transform-origin: center; }
    .progress-ring .progress { stroke: var(--accent); stroke-linecap: round; stroke-dasharray: 535; stroke-dashoffset: 535; transition: stroke-dashoffset 0.1s ease; }
    .state-running .progress { stroke: var(--accent); animation: pulse 2s infinite; }
    .state-finished .progress { stroke: var(--success); stroke-dashoffset: 0; }
    .state-paused .progress { stroke: var(--muted); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    .controls { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin: 1.5rem 0; }
    button { background: var(--accent); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--radius); cursor: pointer; font-size: 1rem; transition: all 0.2s; min-height: 44px; }
    button:hover:not(:disabled) { background: color-mix(in srgb, var(--accent) 90%, black); transform: translateY(-1px); }
    button:disabled { background: var(--muted); cursor: not-allowed; }
    button.secondary { background: var(--border); color: var(--fg); }
    .input-group { margin: 1rem 0; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.1); color: inherit; font-size: 1rem; }
    textarea { resize: vertical; min-height: 100px; font-family: inherit; }
    .backlog, .history { margin-top: 1.5rem; }
    .backlog-item, .history-item { display: flex; gap: 0.5rem; align-items: center; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 0.5rem; }
    .backlog-item.done { opacity: 0.6; text-decoration: line-through; }
    .stats { background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius); margin-top: 1rem; }
    .toast { position: fixed; top: 1rem; right: 1rem; background: var(--accent); color: white; padding: 1rem; border-radius: var(--radius); transform: translateX(400px); transition: transform 0.3s; z-index: 1000; }
    .toast.show { transform: translateX(0); }
    .sidebar-toggle { display: none; }
    @media (max-width: 768px) { .sidebar { display: none; } .sidebar-toggle { display: block; } }
    .no-js { display: none; }
    .js-only { display: block; }
    .no-js-fallback { padding: 2rem; text-align: center; }
    .cmd-palette { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1001; }
    .cmd-palette.show { display: flex; align-items: center; justify-content: center; }
    .cmd-input { width: 100%; max-width: 500px; }
    .section-toggle { cursor: pointer; font-size: 0.875rem; color: var(--muted); margin-bottom: 1rem; }
    .flash { animation: flash 0.5s; }
    @keyframes flash { 0%,100%{background:var(--success)} 50%{background:transparent} }
    .live-region { position: absolute; left: -9999px; }
    svg.icon { width: 1.2em; height: 1.2em; fill: currentColor; vertical-align: middle; margin-right: 0.25rem; }
  </style>
</head>
<body class="no-js">
  <div class="no-js-fallback">
    <h1>Pocket Sprint</h1>
    <p>Please enable JavaScript for full functionality. This is a lightweight productivity sprint app that works entirely offline.</p>
  </div>
  <div class="app js-only" role="application" aria-label="Pocket Sprint productivity app">
    <header class="header">
      <h1 class="title">Pocket Sprint</h1>
      <div>
        <kbd>Space</kbd> Start/Pause <kbd>S</kbd> Stop <kbd>Ctrl+K</kbd> Commands
      </div>
    </header>
    
    <main class="main">
      <section class="sprint-section" aria-labelledby="sprint-title">
        <h2 id="sprint-title">Current Sprint</h2>
        
        <div class="input-group">
          <label for="sprint-title-input">Title</label>
          <input id="sprint-title-input" type="text" placeholder="What are you working on?" aria-required="true">
        </div>
        
        <div class="input-group">
          <label for="duration-input">Duration (minutes)</label>
          <input id="duration-input" type="number" min="1" max="120" value="25" aria-label="Sprint duration in minutes">
        </div>
        
        <div class="input-group">
          <label for="tags-input">Tags (comma separated)</label>
          <input id="tags-input" type="text" placeholder="work, urgent, code">
        </div>
        
        <div class="input-group">
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Goals, thoughts, or progress..."></textarea>
        </div>
        
        <div class="controls">
          <button id="start-btn" aria-label="Start sprint (Spacebar)">‚ñ∂ Start</button>
          <button id="pause-btn" disabled aria-label="Pause sprint">‚è∏ Pause</button>
          <button id="stop-btn" disabled aria-label="Stop sprint (S key)">‚èπ Stop</button>
        </div>
        
        <div class="timer-display" role="timer" aria-live="polite" id="timer-display">
          <div class="progress-ring">
            <svg viewBox="0 0 200 200">
              <circle cx="100" cy="100" r="85"/>
              <circle id="progress-circle" class="progress" cx="100" cy="100" r="85" pathLength="1"/>
            </svg>
          </div>
          <div id="time-display" class="time">25:00</div>
          <div id="status-text">Ready to start</div>
        </div>
        
        <div class="input-group">
          <label for="attach-backlog">Attach backlog items</label>
          <select id="attach-backlog" multiple aria-label="Select backlog items to attach">
            <!-- populated by JS -->
          </select>
        </div>
      </section>
      
      <aside class="sidebar" role="complementary">
        <button class="section-toggle" id="backlog-toggle" aria-expanded="true">üìã Backlog <span class="icon">‚ñº</span></button>
        <div class="backlog" id="backlog-section" role="list">
          <div class="input-group">
            <input id="backlog-title" placeholder="New backlog item..." aria-label="Add new backlog item">
            <input id="backlog-estimate" type="number" min="1" placeholder="Est (min)" style="width: 80px;">
            <button id="add-backlog">Add</button>
          </div>
          <div id="backlog-list"></div>
        </div>
        
        <button class="section-toggle" id="history-toggle" aria-expanded="false">üìä History <span class="icon">‚ñ≤</span></button>
        <div class="history" id="history-section" role="list" style="display:none;">
          <div class="input-group">
            <select id="history-filter">
              <option value="all">All time</option>
              <option value="30d">Last 30 days</option>
              <option value="7d">Last 7 days</option>
              <option value="today">Today</option>
            </select>
            <button id="export-btn">Export JSON</button>
            <input type="file" id="import-file" accept=".json" style="display:none;">
            <button id="import-btn">Import</button>
          </div>
          <div id="history-list"></div>
          <div class="stats" id="stats"></div>
        </div>
        
        <details class="settings" style="margin-top: 2rem;">
          <summary>‚öôÔ∏è Settings</summary>
          <div class="input-group">
            <label>Theme</label>
            <select id="theme-select">
              <option value="auto">Auto (system)</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="input-group">
            <label>Font size</label>
            <select id="font-size">
              <option value="small">Small</option>
              <option value="normal">Normal</option>
              <option value="large">Large</option>
            </select>
          </div>
          <label><input type="checkbox" id="sound-toggle" checked> Sound on finish</label>
          <label><input type="checkbox" id="motion-toggle" checked> Animations</label>
          <button id="test-sprint">Test 5s sprint</button>
          <button id="clear-data" class="secondary">Clear all data</button>
        </details>
      </aside>
    </aside>
    
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <div id="live-region" class="live-region" aria-live="polite"></div>
    
    <div class="cmd-palette" id="cmd-palette" role="dialog" aria-modal="true" aria-labelledby="cmd-title">
      <div style="background:var(--bg);padding:2rem;width:100%;max-width:500px;border-radius:var(--radius);">
        <h3 id="cmd-title">Command Palette (Esc to close)</h3>
        <input id="cmd-input" class="cmd-input" placeholder="Type new, start, stop, export..." autofocus>
      </div>
    </div>
  </div>

  <script>
    class PocketSprint {
      constructor() {
        this.dataKey = 'pocketSprint:v1';
        this.data = this.loadData();
        this.currentSprint = null;
        this.timer = null;
        this.lastSave = 0;
        this.saveDebounce = null;
        this.audioContext = null;
        this.init();
      }
      
      loadData() {
        try {
          const json = localStorage.getItem(this.dataKey);
          return json ? JSON.parse(json) : {
            sprints: {},
            backlog: [],
            history: [],
            settings: { theme: 'auto', soundOn: true, motionOK: true, fontSize: 'normal' }
          };
        } catch {
          return { sprints: {}, backlog: [], history: [], settings: { theme: 'auto', soundOn: true, motionOK: true, fontSize: 'normal' } };
        }
      }
      
      saveData() {
        try {
          localStorage.setItem(this.dataKey, JSON.stringify(this.data));
          this.lastSave = Date.now();
        } catch (e) {
          this.showToast('Storage quota exceeded. Clear some data.', 'error');
        }
      }
      
      debounceSave() {
        clearTimeout(this.saveDebounce);
        this.saveDebounce = setTimeout(() => this.saveData(), 300);
      }
      
      init() {
        document.body.classList.remove('no-js');
        document.body.classList.add('js-only');
        this.applySettings();
        this.seedData();
        this.bindEvents();
        this.render();
        this.restoreSprint();
        this.updateTimerDisplay();
        document.addEventListener('visibilitychange', () => this.onVisibilityChange());
      }
      
      seedData() {
        if (this.data.backlog.length === 0) {
          this.data.backlog = [
            { id: Date.now(), title: 'Finish project proposal', estimateMin: 30, done: false, order: 0 },
            { id: Date.now() + 1, title: 'Review code changes', estimateMin: 15, done: false, order: 1 },
            { id: Date.now() + 2, title: 'Write tests', estimateMin: 45, done: false, order: 2 }
          ];
          this.data.sprints[Date.now() + 3] = {
            id: Date.now() + 3,
            title: 'Welcome to Pocket Sprint!',
            durationMin: 5,
            tags: [],
            notes: 'Try starting this sprint to test the timer, sound, and history.',
            attachedBacklogIds: [],
            createdAt: Date.now(),
            updatedAt: Date.now(),
            runningState: 'idle',
            remainingSec: 300
          };
          this.saveData();
        }
      }
      
      applySettings() {
        const settings = this.data.settings;
        document.documentElement.style.setProperty('--font-size', settings.fontSize === 'small' ? '0.875rem' : 
                                                  settings.fontSize === 'large' ? '1.125rem' : '1rem');
        document.body.dataset.theme = settings.theme;
        document.getElementById('sound-toggle').checked = settings.soundOn;
        document.getElementById('motion-toggle').checked = settings.motionOK;
        document.getElementById('theme-select').value = settings.theme;
        document.getElementById('font-size').value = settings.fontSize;
      }
      
      bindEvents() {
        // Controls
        document.getElementById('start-btn').onclick = () => this.startSprint();
        document.getElementById('pause-btn').onclick = () => this.pauseSprint();
        document.getElementById('stop-btn').onclick = () => this.stopSprint();
        document.getElementById('add-backlog').onclick = () => this.addBacklogItem();
        
        // Inputs
        document.getElementById('sprint-title-input').oninput = (e) => this.updateCurrentSprint('title', e.target.value);
        document.getElementById('duration-input').oninput = (e) => {
          const val = parseInt(e.target.value) || 25;
          e.target.value = Math.max(1, Math.min(120, val));
          if (this.currentSprint) this.updateCurrentSprint('durationMin', val);
        };
        document.getElementById('tags-input').oninput = (e) => this.updateCurrentSprint('tags', e.target.value.split(',').map(t=>t.trim()).filter(Boolean));
        document.getElementById('notes').oninput = (e) => this.updateCurrentSprint('notes', e.target.value);
        document.getElementById('attach-backlog').onchange = (e) => {
          if (this.currentSprint) {
            this.currentSprint.attachedBacklogIds = Array.from(e.target.selectedOptions).map(opt => parseInt(opt.value));
            this.debounceSave();
          }
        };
        document.getElementById('backlog-title').onkeypress = (e) => e.key === 'Enter' && this.addBacklogItem();
        
        // Settings
        document.getElementById('theme-select').onchange = (e) => {
          this.data.settings.theme = e.target.value;
          this.applySettings();
          this.debounceSave();
        };
        document.getElementById('font-size').onchange = (e) => {
          this.data.settings.fontSize = e.target.value;
          this.applySettings();
          this.debounceSave();
        };
        document.getElementById('sound-toggle').onchange = (e) => {
          this.data.settings.soundOn = e.target.checked;
          this.debounceSave();
        };
        document.getElementById('motion-toggle').onchange = (e) => {
          this.data.settings.motionOK = e.target.checked;
          document.body.dataset.motion = e.target.checked ? 'on' : 'reduced';
          this.debounceSave();
        };
        
        // History
        document.getElementById('history-filter').onchange = () => this.renderHistory();
        document.getElementById('export-btn').onclick = () => this.exportData();
        document.getElementById('import-btn').onclick = () => document.getElementById('import-file').click();
        document.getElementById('import-file').onchange = (e) => this.importData(e.target.files[0]);
        
        // Other
        document.getElementById('test-sprint').onclick = () => this.testSprint();
        document.getElementById('clear-data').onclick = () => this.clearData();
        
        // Keyboard
        document.addEventListener('keydown', (e) => {
          if (e.target.matches('input, textarea, select')) return;
          if (e.code === 'Space') {
            e.preventDefault();
            this.currentSprint?.runningState === 'running' ? this.pauseSprint() : this.startSprint();
          } else if (e.code === 'KeyS') {
            e.preventDefault();
            this.stopSprint();
          } else if ((e.ctrlKey || e.metaKey) && e.code === 'KeyK') {
            e.preventDefault();
            this.toggleCmdPalette();
          } else if (e.code === 'ArrowUp' && document.activeElement.id === 'duration-input') {
            e.preventDefault();
            const input = document.getElementById('duration-input');
            input.value = Math.min(120, parseInt(input.value) + 5);
            input.dispatchEvent(new Event('input'));
          } else if (e.code === 'ArrowDown' && document.activeElement.id === 'duration-input') {
            e.preventDefault();
            const input = document.getElementById('duration-input');
            input.value = Math.max(1, parseInt(input.value) - 5);
            input.dispatchEvent(new Event('input'));
          }
        });
        
        // Command palette
        document.getElementById('cmd-input').oninput = (e) => this.handleCommand(e.target.value);
        document.getElementById('cmd-input').onkeydown = (e) => {
          if (e.key === 'Escape') this.toggleCmdPalette();
          if (e.key === 'Enter') this.executeCommand(e.target.value);
        };
      }
      
      updateCurrentSprint(field, value) {
        if (!this.currentSprint) return;
        this.currentSprint[field] = value;
        this.currentSprint.updatedAt = Date.now();
        this.renderSprintForm();
        this.debounceSave();
      }
      
      createSprint() {
        const title = document.getElementById('sprint-title-input').value.trim() || 'Untitled Sprint';
        const durationMin = parseInt(document.getElementById('duration-input').value) || 25;
        const tags = document.getElementById('tags-input').value.split(',').map(t=>t.trim()).filter(Boolean);
        const notes = document.getElementById('notes').value;
        
        const sprint = {
          id: Date.now(),
          title,
          durationMin,
          tags,
          notes,
          attachedBacklogIds: [],
          createdAt: Date.now(),
          updatedAt: Date.now(),
          runningState: 'idle',
          remainingSec: durationMin * 60
        };
        
        this.data.sprints[sprint.id] = sprint;
        this.currentSprint = sprint;
        this.debounceSave();
        this.render();
        this.showToast('Sprint created');
        this.liveAnnounce(`${title} sprint created`);
      }
      
      startSprint() {
        if (!this.currentSprint) {
          this.createSprint();
        }
        if (this.currentSprint.runningState === 'finished') return;
        
        this.currentSprint.runningState = 'running';
        this.currentSprint.startTime = Date.now();
        document.body.classList.add('state-running');
        this.renderSprintForm();
        this.updateTimer();
        this.debounceSave();
        this.showToast('Sprint started');
        this.liveAnnounce('Sprint started');
      }
      
      pauseSprint() {
        if (!this.currentSprint || this.currentSprint.runningState !== 'running') return;
        
        this.currentSprint.runningState = 'paused';
        document.body.classList.remove('state-running');
        document.body.classList.add('state-paused');
        this.renderSprintForm();
        this.debounceSave();
        this.showToast('Sprint paused');
        this.liveAnnounce('Sprint paused');
      }
      
      stopSprint() {
        if (!this.currentSprint) return;
        
        const wasRunning = this.currentSprint.runningState === 'running';
        this.currentSprint.runningState = 'finished';
        this.currentSprint.updatedAt = Date.now();
        
        if (wasRunning) {
          this.data.history.push({
            id: Date.now(),
            sprintId: this.currentSprint.id,
            startAt: this.currentSprint.startTime,
            endAt: Date.now(),
            durationSec: this.currentSprint.durationMin * 60 - this.currentSprint.remainingSec,
            completed: this.currentSprint.remainingSec <= 5 // Allow 5s tolerance
          });
        }
        
        document.body.classList.remove('state-running', 'state-paused');
        document.body.classList.add('state-finished');
        this.renderSprintForm();
        this.playBeep();
        this.flashTimer();
        this.debounceSave();
        this.renderHistory();
        this.showToast('Sprint completed');
        this.liveAnnounce('Sprint finished');
        
        this.currentSprint = null;
      }
      
      updateTimer() {
        if (!this.currentSprint || this.currentSprint.runningState !== 'running') {
          if (this.timer) {
            cancelAnimationFrame(this.timer);
            this.timer = null;
          }
          return;
        }
        
        const now = Date.now();
        const elapsed = Math.floor((now - this.currentSprint.startTime) / 1000);
        this.currentSprint.remainingSec = Math.max(0, this.currentSprint.durationMin * 60 - elapsed);
        
        this.updateTimerDisplay();
        
        if (this.currentSprint.remainingSec <= 0) {
          this.stopSprint();
        } else {
          this.timer = requestAnimationFrame(() => this.updateTimer());
          if (now - this.lastSave > 1000) this.debounceSave();
        }
      }
      
      updateTimerDisplay() {
        if (!this.currentSprint) {
          document.getElementById('time-display').textContent = '25:00';
          document.getElementById('status-text').textContent = 'Ready to start';
          document.querySelector('#progress-circle').style.strokeDashoffset = '535';
          return;
        }
        
        const mins = Math.floor(this.currentSprint.remainingSec / 60);
        const secs = this.currentSprint.remainingSec % 60;
        document.getElementById('time-display').textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        
        const progress = 1 - (this.currentSprint.remainingSec / (this.currentSprint.durationMin * 60));
        document.querySelector('#progress-circle').style.strokeDashoffset = 535 * (1 - progress);
        
        const states = { running: '‚è± Running', paused: '‚è∏ Paused', finished: '‚úÖ Finished', idle: 'Ready to start' };
        document.getElementById('status-text').textContent = states[this.currentSprint.runningState] || 'Unknown';
      }
      
      renderSprintForm() {
        if (!this.currentSprint) return;
        
        document.getElementById('sprint-title-input').value = this.currentSprint.title;
        document.getElementById('duration-input').value = this.currentSprint.durationMin;
        document.getElementById('tags-input').value = this.currentSprint.tags.join(', ');
        document.getElementById('notes').value = this.currentSprint.notes;
        
        const attachSelect = document.getElementById('attach-backlog');
        attachSelect.innerHTML = '';
        this.data.backlog.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = `${item.title} (${item.estimateMin || '?'}min) ${item.done ? '[done]' : ''}`;
          if (this.currentSprint.attachedBacklogIds.includes(item.id)) opt.selected = true;
          attachSelect.appendChild(opt);
        });
        
        // Update buttons
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        startBtn.disabled = this.currentSprint.runningState === 'finished';
        pauseBtn.disabled = this.currentSprint.runningState !== 'running';
        stopBtn.disabled = this.currentSprint.runningState === 'idle';
      }
      
      render() {
        this.renderSprintForm();
        this.renderBacklog();
        this.renderHistory();
        this.updateTimerDisplay();
      }
      
      renderBacklog() {
        const container = document.getElementById('backlog-list');
        container.innerHTML = '';
        
        this.data.backlog
          .sort((a,b) => a.order - b.order)
          .forEach(item => {
            const div = document.createElement('div');
            div.className = `backlog-item ${item.done ? 'done' : ''}`;
            div.dataset.id = item.id;
            div.innerHTML = `
              <input type="checkbox" ${item.done ? 'checked' : ''} aria-label="Mark ${item.title} done">
              <input style="flex:1; margin-left:0.5rem;" value="${item.title}" aria-label="Edit ${item.title}">
              <input type="number" min="1" value="${item.estimateMin || ''}" style="width:60px;" aria-label="Estimate minutes">
              <button class="secondary" style="margin-left:0.5rem;">‚Üë</button>
              <button class="secondary">‚Üì</button>
              <button class="secondary">Delete</button>
            `;
            div.querySelector('input[type="checkbox"]').onchange = (e) => {
              item.done = e.target.checked;
              this.debounceSave();
              this.renderBacklog();
            };
            div.querySelector('input[type="number"]').onchange = (e) => {
              item.estimateMin = parseInt(e.target.value) || null;
              this.debounceSave();
            };
            div.querySelector('input[type="text"]').onchange = (e) => {
              item.title = e.target.value;
              this.debounceSave();
            };
            div.querySelector('button:nth-of-type(3)').onclick = () => {
              if (confirm('Delete this backlog item?')) {
                this.data.backlog = this.data.backlog.filter(b => b.id !== item.id);
                this.debounceSave();
                this.renderBacklog();
              }
            };
            container.appendChild(div);
          });
      }
      
      addBacklogItem() {
        const title = document.getElementById('backlog-title').value.trim();
        if (!title) return;
        
        const estimate = parseInt(document.getElementById('backlog-estimate').value) || null;
        this.data.backlog.push({
          id: Date.now(),
          title,
          estimateMin: estimate,
          done: false,
          order: this.data.backlog.length
        });
        document.getElementById('backlog-title').value = '';
        document.getElementById('backlog-estimate').value = '';
        this.debounceSave();
        this.renderBacklog();
        this.showToast('Backlog item added');
      }
      
      renderHistory() {
        const filter = document.getElementById('history-filter').value;
        const now = Date.now();
        const cutoff = filter === 'today' ? now - 86400000 :
                       filter === '7d' ? now - 7*86400000 :
                       filter === '30d' ? now - 30*86400000 : 0;
        
        const filtered = this.data.history.filter(h => h.endAt > cutoff);
        const container = document.getElementById('history-list');
        container.innerHTML = '';
        
        filtered.forEach(item => {
          const sprint = this.data.sprints[item.sprintId];
          if (!sprint) return;
          
          const div = document.createElement('div');
          div.className = 'history-item';
          const duration = Math.round(item.durationSec / 60);
          const completed = item.completed ? '‚úÖ' : '‚ö†Ô∏è';
          div.innerHTML = `
            <strong>${sprint.title}</strong> ${completed} ${duration}min
            <small style="margin-left:auto;">${new Date(item.endAt).toLocaleString()}</small>
          `;
          container.appendChild(div);
        });
        
        // Stats
        const totalSprints = filtered.length;
        const totalMinutes = Math.round(filtered.reduce((sum, h) => sum + h.durationSec/60, 0));
        const avgMinutes = totalSprints ? Math.round(totalMinutes / totalSprints) : 0;
        document.getElementById('stats').innerHTML = `
          <strong>Stats:</strong> ${totalSprints} sprints, ${totalMinutes}min total, ${avgMinutes}min avg
        `;
      }
      
      restoreSprint() {
        const recentSprint = Object.values(this.data.sprints)
          .filter(s => s.runningState !== 'idle')
          .sort((a,b) => b.updatedAt - a.updatedAt)[0];
        
        if (recentSprint) {
          this.currentSprint = recentSprint;
          if (recentSprint.runningState === 'running') {
            // Adjust for time passed
            const elapsedSincePause = Date.now() - recentSprint.updatedAt;
            recentSprint.remainingSec = Math.max(0, recentSprint.remainingSec - Math.floor(elapsedSincePause / 1000));
            if (recentSprint.remainingSec > 0) {
              document.body.classList.add('state-running');
              this.updateTimer();
            } else {
              recentSprint.runningState = 'finished';
            }
          }
          this.render();
        }
      }
      
      onVisibilityChange() {
        if (document.hidden && this.currentSprint?.runningState === 'running') {
          this.pauseSprint();
        } else if (!document.hidden && this.currentSprint?.runningState === 'paused') {
          this.startSprint();
        }
      }
      
      playBeep() {
        if (!this.data.settings.soundOn) return;
        try {
          if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);
          oscillator.frequency.value = 800;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
          oscillator.start(this.audioContext.currentTime);
          oscillator.stop(this.audioContext.currentTime + 0.5);
        } catch (e) {
          console.warn('Audio failed:', e);
        }
      }
      
      flashTimer() {
        const timer = document.getElementById('timer-display');
        timer.classList.add('flash');
        setTimeout(() => timer.classList.remove('flash'), 500);
      }
      
      showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => toast.classList.remove('show'), 3000);
      }
      
      liveAnnounce(message) {
        const region = document.getElementById('live-region');
        region.textContent = message;
        setTimeout(() => region.textContent = '', 1000);
      }
      
      exportData() {
        const dataStr = JSON.stringify(this.data, null, 2);
        const blob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pocket-sprint-export-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        this.showToast('Data exported');
      }
      
      importData(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            if (confirm('Replace all data with imported data?')) {
              this.data = imported;
              this.saveData();
              this.render();
              this.showToast('Data imported');
            }
          } catch (err) {
            this.showToast('Invalid JSON file');
          }
        };
        reader.readAsText(file);
      }
      
      clearData() {
        if (confirm('Clear ALL data? This cannot be undone. Data will be exported first.')) {
          this.exportData();
          localStorage.removeItem(this.dataKey);
          location.reload();
        }
      }
      
      testSprint() {
        this.currentSprint = {
          id: 'test',
          title: 'Test Sprint',
          durationMin: 0,
          remainingSec: 5,
          runningState: 'running',
          startTime: Date.now() - (5*1000 - 1000),
          tags: [],
          notes: '',
          attachedBacklogIds: []
        };
        document.body.classList.add('state-running');
        this.updateTimer();
        this.showToast('5-second test sprint started');
      }
      
      toggleCmdPalette() {
        const palette = document.getElementById('cmd-palette');
        palette.classList.toggle('show');
        if (palette.classList.contains('show')) {
          document.getElementById('cmd-input').focus();
        }
      }
      
      handleCommand(query) {
        // Simple command suggestions (filter existing commands)
        const commands = ['new', 'start', 'stop', 'pause', 'export', 'import', 'clear', 'mute'];
        // Could show dropdown here
      }
      
      executeCommand(query) {
        const q = query.toLowerCase().trim();
        if (q === 'new') this.createSprint();
        else if (q === 'start') this.startSprint();
        else if (q === 'stop') this.stopSprint();
        else if (q === 'pause') this.pauseSprint();
        else if (q === 'export') this.exportData();
        else if (q === 'mute') {
          this.data.settings.soundOn = !this.data.settings.soundOn;
          document.getElementById('sound-toggle').checked = this.data.settings.soundOn;
          this.debounceSave();
          this.showToast(`Sound ${this.data.settings.soundOn ? 'enabled' : 'muted'}`);
        }
        this.toggleCmdPalette();
      }
    }
    
    // Initialize app
    window.addEventListener('load', () => new PocketSprint());
  </script>
</body>
</html>
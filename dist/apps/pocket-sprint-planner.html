<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-12-28T01:49:14.024578Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pocket Sprint Planner</title>
<style>
:root{
  --bg:#f6f7f9; --card:#ffffff; --muted:#6b7280; --accent:#0066cc; --accent-2:#055a8c;
  --success:#0f9d58; --danger:#d64545; --focus:#ffb020; --ring-bg:#e6eef9;
  --high:#ff6b6b; --med:#ffb86b; --low:#68d391;
  --text:#0b1220; --border:#e6e9ee;
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  line-height:1.3;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:100vh;
}
.header{
  display:flex;align-items:center;gap:12px;justify-content:space-between;
}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
  display:grid;place-items:center;color:#fff;font-weight:700;font-size:18px;box-shadow:0 2px 6px rgba(2,6,23,.08)
}
.h-actions{display:flex;gap:8px;align-items:center}
button,select,input,textarea{font:inherit}
.btn{
  background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;
  box-shadow:0 1px 0 rgba(0,0,0,.04);
}
.btn.secondary{background:transparent;color:var(--accent-2);border:1px solid var(--border)}
.icon-btn{background:transparent;border:1px solid var(--border);padding:6px;border-radius:6px;cursor:pointer}
.btn:focus,.icon-btn:focus{outline:3px solid rgba(0,102,204,.15)}
.container{
  display:grid;
  gap:12px;
}
@media(min-width:900px){
  .container{grid-template-columns:1fr 360px}
}
.card{
  background:var(--card);border-radius:10px;padding:12px;border:1px solid var(--border);
  box-shadow:0 1px 0 rgba(12,18,24,.02);
}
.left{display:flex;flex-direction:column;gap:12px}
.right{display:flex;flex-direction:column;gap:12px}
.section-title{font-weight:600;margin-bottom:8px;color:var(--muted);font-size:13px}
.sprint-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.timer{
  display:flex;gap:12px;align-items:center;
  justify-content:space-between;
}
.timer-visual{display:flex;gap:12px;align-items:center}
.ring{width:120px;height:120px;position:relative;display:grid;place-items:center}
.ring svg{transform:rotate(-90deg)}
.time-display{font-weight:700;font-size:22px}
.timer-buttons{display:flex;gap:8px}
.small{font-size:13px;padding:6px 8px;border-radius:8px}
.tasks{display:flex;flex-direction:column;gap:8px}
.task-row{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;border:1px dashed transparent}
.task-row[aria-checked="true"]{opacity:.6;text-decoration:line-through}
.handle{cursor:grab;padding:6px;border-radius:6px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#fafafa)}
.task-text{flex:1;min-width:0}
.task-controls{display:flex;gap:6px;align-items:center}
select.priority{width:84px}
.tag{font-size:12px;padding:4px 6px;border-radius:6px;border:1px solid var(--border);background:#fbfdff}
.add-row{display:flex;gap:8px;align-items:center}
.distractions-list{max-height:160px;overflow:auto;display:flex;flex-direction:column;gap:8px}
.distraction-item{padding:8px;border-radius:8px;border:1px solid var(--border);display:flex;justify-content:space-between;gap:8px;background:#fff}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
.quicknotes{display:flex;flex-direction:column;gap:8px}
textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:8px;padding:8px;background:transparent;resize:vertical}
.preview{white-space:pre-wrap;padding:8px;border-radius:8px;border:1px dashed var(--border);background:#fbfeff}
.kv{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
.help-overlay{
  position:fixed;inset:0;display:none;background:rgba(4,8,18,.6);z-index:60;align-items:center;justify-content:center;padding:24px
}
.help-overlay[aria-hidden="false"]{display:flex}
.help-card{max-width:720px;width:100%;background:var(--card);padding:18px;border-radius:10px;border:1px solid var(--border)}
.modal{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,8,18,.4);z-index:70;padding:16px
}
.modal[aria-hidden="false"]{display:flex}
.modal-card{width:100%;max-width:720px;background:var(--card);padding:16px;border-radius:10px;border:1px solid var(--border)}
.row{display:flex;gap:8px;align-items:center}
.input{padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent}
.small-muted{font-size:12px;color:var(--muted)}
.search-row{display:flex;gap:8px;align-items:center}
.history-item{padding:8px;border-radius:8px;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.expand{font-size:13px;color:var(--accent)}
.controls-inline{display:flex;gap:6px;flex-wrap:wrap}
.hidden{display:none}
.visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
.footer{display:flex;gap:8px;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted)}
.badge{padding:4px 8px;border-radius:999px;background:#f2f8ff;border:1px solid var(--border);font-size:12px;color:var(--accent-2)}
.alert{padding:8px;border-radius:8px;background:#fff4f4;border:1px solid rgba(214,69,69,.12);color:var(--danger)}
.drag-over{border-color:var(--accent);background:linear-gradient(90deg,#fbfeff,#f0f8ff)}
/* priority colors */
.priority-high{border-left:4px solid var(--high);padding-left:8px}
.priority-med{border-left:4px solid var(--med);padding-left:8px}
.priority-low{border-left:4px solid var(--low);padding-left:8px}
/* focus */
:focus{outline:3px solid rgba(0,102,204,.12);outline-offset:2px}
.small-muted a{color:var(--accent)}
/* accessibility high-contrast safe text sizes */
.time-display{font-size:20px}
</style>
<body>
<header class="header" role="banner">
  <div class="brand">
    <div class="logo" aria-hidden="true">PS</div>
    <div>
      <div style="font-weight:700">Pocket Sprint Planner</div>
      <div class="small-muted" style="margin-top:2px">Focused micro-sprints with quick notes & retrospectives</div>
    </div>
  </div>
  <div class="h-actions">
    <button id="helpBtn" class="icon-btn" title="Keyboard shortcuts (H)" aria-label="Show keyboard shortcuts (H)">⌨️</button>
    <button id="newSprintBtn" class="btn" title="New Sprint (N)" aria-label="New Sprint (N)">New Sprint</button>
  </div>
</header>

<main class="container" role="main">
  <section class="left">
    <div class="card" aria-labelledby="current-sprint-title">
      <div id="current-sprint-title" class="section-title">Current Sprint</div>
      <div id="no-sprint" class="small-muted">No active sprint. Start a new sprint to begin.</div>

      <div id="sprintArea" class="hidden" aria-live="polite">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <div>
            <div id="sprintTitle" style="font-weight:700"></div>
            <div class="small-muted" id="sprintGoal"></div>
          </div>
          <div class="kv"><span id="distractionCount">0</span> distractions</div>
        </div>

        <div style="margin-top:12px" class="tasks" role="list" id="taskList" aria-label="Sprint tasks"></div>

        <div class="add-row" style="margin-top:8px">
          <input id="newTaskText" class="input task-text" placeholder="Quick task (T)" aria-label="New task text" />
          <select id="newTaskPriority" class="input" aria-label="Priority">
            <option value="High">High</option>
            <option value="Med" selected>Med</option>
            <option value="Low">Low</option>
          </select>
          <select id="newTaskContext" class="input" aria-label="Context">
            <option value="">Context</option>
            <option>Work</option>
            <option>Home</option>
            <option>Errand</option>
          </select>
          <button id="addTaskBtn" class="btn small" title="Add task (Enter)" aria-label="Add task">Add</button>
        </div>
      </div>
    </div>

    <div class="card" aria-labelledby="history-title">
      <div id="history-title" class="section-title">History</div>
      <div class="search-row" style="margin-bottom:8px">
        <input id="historySearch" class="input" placeholder="Search history..." aria-label="Search history"/>
        <input id="fromDate" type="date" class="input" aria-label="From date"/>
        <input id="toDate" type="date" class="input" aria-label="To date"/>
        <select id="scoreFilter" class="input" aria-label="Score filter">
          <option value="">All scores</option>
          <option value=">=1">Score ≥ 1</option>
          <option value="<1">Score &lt; 1</option>
        </select>
        <button id="toggleHistoryBtn" class="icon-btn" aria-pressed="false" title="Toggle history panel (H)">☰</button>
      </div>
      <div id="historyList" class="history-list" aria-live="polite"></div>
      <div class="kv" style="margin-top:8px">
        <div class="controls-inline">
          <button id="exportAllBtn" class="btn small">Export All (.json)</button>
          <label class="icon-btn" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
            Import <input id="importFile" type="file" accept="application/json" style="display:none" aria-label="Import history JSON"/>
          </label>
          <button id="clearHistoryBtn" class="icon-btn" title="Clear history">Clear</button>
        </div>
      </div>
    </div>
  </section>

  <aside class="right">
    <div class="card" aria-labelledby="timer-title">
      <div id="timer-title" class="section-title">Timer</div>
      <div class="timer" role="region" aria-label="Sprint timer" id="timerRegion">
        <div class="timer-visual">
          <div class="ring" aria-hidden="true">
            <svg id="timerRing" width="120" height="120" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="50" stroke="var(--ring-bg)" stroke-width="12" fill="none"/>
              <circle id="prog" cx="60" cy="60" r="50" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="0" fill="none" />
            </svg>
            <div class="time-display" id="timeDisplay" aria-live="polite" aria-atomic="true">00:00</div>
          </div>
        </div>
        <div style="flex:1">
          <div class="kv">Duration:
            <select id="durationSelect" class="input" aria-label="Select duration">
              <option value="25">25 min</option>
              <option value="30">30 min</option>
              <option value="45">45 min</option>
              <option value="60">60 min</option>
              <option value="90">90 min</option>
            </select>
          </div>

          <div style="margin-top:8px" class="timer-buttons">
            <button id="startBtn" class="btn small" aria-pressed="false" title="Start (S)">Start</button>
            <button id="pauseBtn" class="icon-btn small" disabled title="Pause/Resume (P)">Pause</button>
            <button id="stopBtn" class="icon-btn small" disabled title="Stop">Stop</button>
            <button id="distractBtn" class="btn small" title="Log distraction (D)" aria-live="polite">Log D</button>
          </div>
          <div style="margin-top:8px" class="small-muted">Mute: <input type="checkbox" id="muteChk" aria-label="Mute end alert"/></div>
        </div>
      </div>
    </div>

    <div class="card" aria-labelledby="distractions-title">
      <div id="distractions-title" class="section-title">Distractions <span id="liveDistCount" class="badge">0</span></div>
      <div class="distractions-list" role="log" id="distractionLog" aria-live="polite"></div>
      <div style="margin-top:8px" class="small-muted">Press <strong>D</strong> or click to log during a sprint.</div>
    </div>

    <div class="card" aria-labelledby="notes-title">
      <div id="notes-title" class="section-title">Quick Notes <button id="notesPreviewToggle" class="icon-btn small" title="Toggle preview (N)">Preview</button></div>
      <div class="quicknotes">
        <textarea id="quickNotes" aria-label="Quick notes" placeholder="Jot quick thoughts or plan..."></textarea>
        <div id="notesPreview" class="preview hidden" aria-hidden="true"></div>
        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
          <div class="small-muted">Auto-saves as you type</div>
          <div>
            <button id="exportNotesBtn" class="btn small">Export .txt</button>
            <button id="clearNotesBtn" class="icon-btn small">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </aside>
</main>

<div class="footer small-muted card" role="contentinfo">
  <div>Data stored locally. Exports & imports available.</div>
  <div>Storage key: <span class="badge">pocketSprint:v1</span></div>
</div>

<!-- Help overlay -->
<div id="helpOverlay" class="help-overlay" role="dialog" aria-hidden="true" aria-label="Keyboard shortcuts">
  <div class="help-card" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Keyboard Shortcuts</div>
      <button id="closeHelp" class="icon-btn" aria-label="Close help">✕</button>
    </div>
    <div style="margin-top:12px">
      <ul>
        <li><strong>S</strong> — Start sprint</li>
        <li><strong>P</strong> — Pause/Resume</li>
        <li><strong>T</strong> — New task (focus input)</li>
        <li><strong>D</strong> — Log distraction</li>
        <li><strong>N</strong> — Toggle Quick Notes preview / focus</li>
        <li><strong>H</strong> — Toggle this help / history</li>
      </ul>
    </div>
  </div>
</div>

<!-- New Sprint Modal -->
<div id="modal" class="modal" role="dialog" aria-hidden="true" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-card" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="modalTitle" style="font-weight:700">New Sprint</div>
      <button id="closeModal" class="icon-btn" aria-label="Close new sprint">✕</button>
    </div>
    <form id="newSprintForm" style="margin-top:12px">
      <div style="display:flex;flex-direction:column;gap:8px">
        <label>
          Title
          <input id="modalTitleInput" class="input" required aria-required="true" />
        </label>
        <label>
          Duration
          <select id="modalDuration" class="input">
            <option value="25">25</option><option value="30">30</option><option value="45">45</option><option value="60">60</option><option value="90">90</option>
          </select>
        </label>
        <label>
          Goal / Notes
          <textarea id="modalGoal" class="input" rows="3"></textarea>
        </label>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="submit" class="btn">Create</button>
          <button type="button" id="cancelModal" class="icon-btn">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Retrospective modal -->
<div id="retroModal" class="modal" role="dialog" aria-hidden="true" aria-modal="true" aria-labelledby="retroTitle">
  <div class="modal-card" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="retroTitle" style="font-weight:700">Retrospective Summary</div>
      <button id="closeRetro" class="icon-btn" aria-label="Close retrospective">✕</button>
    </div>
    <div id="retroContent" style="margin-top:12px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="saveRetroBtn" class="btn">Save to History</button>
      <button id="cancelRetroBtn" class="icon-btn">Close</button>
    </div>
  </div>
</div>

<script>
/*
 Pocket Sprint Planner - single-file implementation
 Data saved under key: pocketSprint:v1
*/

(function(){
const KEY='pocketSprint:v1', HISTORY_CAP=200;
let db = { sprints:[], currentSprint:null, quickNotes:{updatedISO:null,content:''}, settings:{shortcuts:{start:'S',pause:'P',newTask:'T',distract:'D',notes:'N',history:'H'},muted:false,theme:'light'} };
const el = id => document.getElementById(id);
const qs = sel => document.querySelector(sel);
const save = ()=> {
  try{
    localStorage.setItem(KEY, JSON.stringify(db));
  }catch(e){
    alert('Error saving to storage: '+(e && e.message));
  }
};
const load = ()=>{
  try{
    const raw = localStorage.getItem(KEY);
    if(raw) db = JSON.parse(raw);
  }catch(e){
    console.error('Load error',e);
  }
};
load();

/* Utilities */
const uid = ()=> Date.now().toString()+Math.random().toString(36).slice(2,6);
const isoNow = ()=> new Date().toISOString();
const fmtTime = s => {
  s = Math.max(0,Math.round(s));
  const m = Math.floor(s/60), sec = s%60;
  return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
};
const clampHistory = ()=>{
  if(db.sprints.length>HISTORY_CAP) db.sprints = db.sprints.slice(db.sprints.length-HISTORY_CAP);
  save();
};

/* UI refs */
const startBtn = el('startBtn'), pauseBtn=el('pauseBtn'), stopBtn=el('stopBtn'), durationSelect=el('durationSelect'),
  timeDisplay=el('timeDisplay'), prog=el('prog'), modal=el('modal'), modalTitleInput=el('modalTitleInput'),
  newSprintBtn=el('newSprintBtn'), newSprintForm=el('newSprintForm'), modalDuration=el('modalDuration'),
  modalGoal=el('modalGoal'), closeModal=el('closeModal'), cancelModal=el('cancelModal'),
  noSprint=el('no-sprint'), sprintArea=el('sprintArea'), sprintTitle=el('sprintTitle'), sprintGoal=el('sprintGoal'),
  taskList=el('taskList'), newTaskText=el('newTaskText'), addTaskBtn=el('addTaskBtn'),
  newTaskPriority=el('newTaskPriority'), newTaskContext=el('newTaskContext'),
  distractBtn=el('distractBtn'), distractionLog=el('distractionLog'), liveDistCount=el('liveDistCount'),
  distractionCount=el('distractionCount'), historyList=el('historyList'),
  exportAllBtn=el('exportAllBtn'), importFile=el('importFile'), clearHistoryBtn=el('clearHistoryBtn'),
  quickNotes=el('quickNotes'), notesPreviewToggle=el('notesPreviewToggle'), notesPreview=el('notesPreview'),
  exportNotesBtn=el('exportNotesBtn'), clearNotesBtn=el('clearNotesBtn'),
  helpOverlay=el('helpOverlay'), helpBtn=el('helpBtn'), closeHelp=el('closeHelp'),
  retroModal=el('retroModal'), retroContent=el('retroContent'), saveRetroBtn=el('saveRetroBtn'), closeRetro=el('closeRetro'),
  cancelRetroBtn=el('cancelRetroBtn'), muteChk=el('muteChk'),
  historySearch=el('historySearch'), fromDate=el('fromDate'), toDate=el('toDate'), scoreFilter=el('scoreFilter'),
  toggleHistoryBtn=el('toggleHistoryBtn');

let timerInterval=null, tickLeft=0, totalSeconds=0, paused=false;

/* Rendering */
function renderApp(){
  // current sprint
  if(db.currentSprint){
    noSprint.classList.add('hidden'); sprintArea.classList.remove('hidden');
    sprintTitle.textContent = db.currentSprint.title || 'Sprint';
    sprintGoal.textContent = db.currentSprint.goal || '';
    distractionCount.textContent = (db.currentSprint.distractions||[]).length;
    liveDistCount.textContent = (db.currentSprint.distractions||[]).length;
    renderTasks();
    // set timer display according to remaining
    if(db.currentSprint.endISO && db.currentSprint.startISO){
      const elapsed = Math.round((Date.now() - new Date(db.currentSprint.startISO).getTime())/1000);
      const dur = db.currentSprint.durationMin*60;
      tickLeft = Math.max(0,dur - elapsed);
      totalSeconds = dur;
      updateTimerVisual();
    } else {
      totalSeconds = db.currentSprint.durationMin*60;
      tickLeft = totalSeconds;
      updateTimerVisual();
    }
    startBtn.setAttribute('aria-pressed', db.currentSprint.running? 'true':'false');
    pauseBtn.disabled = !db.currentSprint.running;
    stopBtn.disabled = !db.currentSprint.running && !db.currentSprint.startISO;
  }else{
    noSprint.classList.remove('hidden'); sprintArea.classList.add('hidden');
  }
  // quick notes
  quickNotes.value = db.quickNotes.content || '';
  notesPreview.classList.add('hidden');
  muteChk.checked = db.settings.muted || false;
  save();
  renderHistory();
}
function renderTasks(){
  taskList.innerHTML='';
  const tasks = db.currentSprint.tasks || [];
  tasks.sort((a,b)=> (a.order||0)-(b.order||0));
  tasks.forEach((t,idx)=>{
    const div = document.createElement('div');
    div.className='task-row card';
    div.setAttribute('role','listitem');
    div.setAttribute('draggable','true');
    div.dataset.id = t.id;
    div.ariaChecked = !!t.done;
    if(t.priority==='High') div.classList.add('priority-high');
    if(t.priority==='Med') div.classList.add('priority-med');
    if(t.priority==='Low') div.classList.add('priority-low');

    div.innerHTML=`
      <div class="handle" tabindex="0" aria-grabbed="false" title="Drag to reorder" aria-label="Drag handle">≡</div>
      <input type="checkbox" ${t.done? 'checked':''} class="task-done" aria-label="Mark task done">
      <div class="task-text"><input class="input task-input" value="${escapeHtml(t.text||'')}" aria-label="Task text"/></div>
      <select class="input priority" aria-label="Priority">
        <option ${t.priority==='High'?'selected':''}>High</option>
        <option ${t.priority==='Med'?'selected':''}>Med</option>
        <option ${t.priority==='Low'?'selected':''}>Low</option>
      </select>
      <select class="input context" aria-label="Context">
        <option ${t.context===''?'selected':''} value="">Context</option>
        <option ${t.context==='Work'?'selected':''}>Work</option>
        <option ${t.context==='Home'?'selected':''}>Home</option>
        <option ${t.context==='Errand'?'selected':''}>Errand</option>
      </select>
      <div class="task-controls">
        <button class="icon-btn move-up" title="Move up" aria-label="Move up">↑</button>
        <button class="icon-btn move-down" title="Move down" aria-label="Move down">↓</button>
        <button class="icon-btn delete-task" title="Delete" aria-label="Delete task">✕</button>
      </div>
    `;
    // wire events
    const chk = div.querySelector('.task-done');
    chk.addEventListener('change', e=>{
      t.done = chk.checked;
      div.ariaChecked = t.done;
      save(); renderApp();
    });
    const textInp = div.querySelector('.task-input');
    textInp.addEventListener('input', e=>{ t.text = textInp.value; save(); });
    const pr = div.querySelector('.priority');
    pr.addEventListener('change', e=>{ t.priority = pr.value; save(); renderApp(); });
    const ctx = div.querySelector('.context');
    ctx.addEventListener('change', e=>{ t.context = ctx.value; save(); });
    div.querySelector('.delete-task').addEventListener('click', e=>{
      db.currentSprint.tasks = db.currentSprint.tasks.filter(x=>x.id!==t.id); save(); renderApp();
    });
    div.querySelector('.move-up').addEventListener('click', e=>{
      const i = db.currentSprint.tasks.findIndex(x=>x.id===t.id);
      if(i>0){ db.currentSprint.tasks.splice(i,1); db.currentSprint.tasks.splice(i-1,0,t); save(); renderApp(); }
    });
    div.querySelector('.move-down').addEventListener('click', e=>{
      const i = db.currentSprint.tasks.findIndex(x=>x.id===t.id);
      if(i<db.currentSprint.tasks.length-1){ db.currentSprint.tasks.splice(i,1); db.currentSprint.tasks.splice(i+1,0,t); save(); renderApp(); }
    });

    // drag events
    div.addEventListener('dragstart', ev=>{
      ev.dataTransfer.setData('text/plain', t.id);
      ev.currentTarget.classList.add('dragging');
    });
    div.addEventListener('dragend', ev=>{
      ev.currentTarget.classList.remove('dragging');
    });
    div.addEventListener('dragover', ev=>{
      ev.preventDefault();
      ev.currentTarget.classList.add('drag-over');
    });
    div.addEventListener('dragleave', ev=>{
      ev.currentTarget.classList.remove('drag-over');
    });
    div.addEventListener('drop', ev=>{
      ev.preventDefault();
      const id = ev.dataTransfer.getData('text/plain');
      const from = db.currentSprint.tasks.findIndex(x=>x.id===id);
      const to = db.currentSprint.tasks.findIndex(x=>x.id===t.id);
      if(from>-1 && to>-1 && from!==to){
        const [m] = db.currentSprint.tasks.splice(from,1);
        db.currentSprint.tasks.splice(to,0,m);
        save(); renderApp();
      }
    });

    taskList.appendChild(div);
  });
}

/* Timer visual update */
function updateTimerVisual(){
  timeDisplay.textContent = fmtTime(tickLeft);
  const circumference = 2*Math.PI*50; // r=50
  const pct = totalSeconds? (tickLeft/totalSeconds):0;
  prog.style.strokeDashoffset = (1-pct)*circumference;
}

/* Timer control */
function startSprintFrom(data){
  // data: {title,durationMin,goal,tasks}
  const sprint = {
    id: uid(), title: data.title||'Sprint', durationMin: Number(data.durationMin||25),
    startISO: new Date().toISOString(), endISO:null, tasks: data.tasks||[], distractions:[], goal: data.goal||'', running:true
  };
  db.currentSprint = sprint;
  save(); renderApp();
  // start countdown
  totalSeconds = sprint.durationMin*60;
  tickLeft = totalSeconds;
  paused=false;
  startInterval();
}
function startInterval(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=> {
    if(paused) return;
    tickLeft--;
    // announcer: announce at 60s remaining and every 10s under 30s
    if(tickLeft===60 || (tickLeft<=30 && tickLeft%10===0)){
      announceToSR('Time remaining ' + fmtTime(tickLeft));
    }
    updateTimerVisual();
    if(tickLeft<=0){
      endSprintAuto();
    }
  },1000);
  // UI states
  startBtn.setAttribute('aria-pressed','true');
  pauseBtn.disabled=false;
  stopBtn.disabled=false;
}
function pauseResume(){
  if(!db.currentSprint) return;
  paused = !paused;
  pauseBtn.textContent = paused? 'Resume':'Pause';
  pauseBtn.setAttribute('aria-pressed', paused? 'true':'false');
  announceToSR(paused? 'Paused':'Resumed');
  db.currentSprint.running = !paused;
  save();
}
function stopSprintManual(){
  if(!db.currentSprint) return;
  endSprint('stopped');
}
function endSprintAuto(){
  if(!db.currentSprint) return;
  endSprint('finished');
}
function endSprint(reason){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  // compute summary
  const sprint = db.currentSprint;
  sprint.endISO = new Date().toISOString();
  sprint.running = false;
  // compute score
  const completed = (sprint.tasks||[]).filter(t=>t.done).length;
  const distractions = (sprint.distractions||[]).length;
  sprint.score = +(completed / (1 + distractions));
  // attach quickNotes snapshot
  sprint.quickNotesSnapshot = db.quickNotes.content;
  // show retro modal
  showRetro(sprint);
}

/* Distractions */
function logDistraction(note){
  if(!db.currentSprint) return;
  const item = { tsISO: isoNow(), note: note||'', avoidable:false };
  db.currentSprint.distractions.push(item); save();
  renderDistractions();
  renderApp();
}
function renderDistractions(){
  distractionLog.innerHTML='';
  const list = (db.currentSprint && db.currentSprint.distractions) || [];
  list.forEach((d,i)=>{
    const div = document.createElement('div');
    div.className='distraction-item';
    div.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:600">${new Date(d.tsISO).toLocaleTimeString()}</div>
        <div class="small-muted">${escapeHtml(d.note||'')}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="icon-btn mark-avoid">${d.avoidable? 'Avoidable':'Mark Avoid'}</button>
        <button class="icon-btn add-note">✎</button>
      </div>
    `;
    div.querySelector('.mark-avoid').addEventListener('click', e=>{
      d.avoidable = !d.avoidable; save(); renderDistractions();
    });
    div.querySelector('.add-note').addEventListener('click', e=>{
      const n = prompt('Add follow-up note', d.note||'')||'';
      d.note = n; save(); renderDistractions();
    });
    distractionLog.appendChild(div);
  });
  liveDistCount.textContent = list.length;
  if(db.currentSprint) distractionCount.textContent = list.length;
}

/* Retro */
function showRetro(sprint){
  retroModal.setAttribute('aria-hidden','false');
  retroContent.innerHTML = `
    <div class="kv">Title: <strong>${escapeHtml(sprint.title)}</strong></div>
    <div class="kv">Duration: <strong>${sprint.durationMin} min</strong></div>
    <div class="kv">Started: ${new Date(sprint.startISO).toLocaleString()}</div>
    <div class="kv">Ended: ${new Date(sprint.endISO).toLocaleString()}</div>
    <div style="margin-top:8px">Tasks completed: <strong>${(sprint.tasks||[]).filter(t=>t.done).length}</strong></div>
    <div>Distractions: <strong>${(sprint.distractions||[]).length}</strong></div>
    <div style="margin-top:8px">Distraction timestamps:</div>
    <ul>${(sprint.distractions||[]).map(d=>'<li>'+escapeHtml(new Date(d.tsISO).toLocaleString()+' - '+(d.note||''))+'</li>').join('')}</ul>
    <div style="margin-top:8px">Focus score: <strong>${sprint.score.toFixed(2)}</strong></div>
  `;
  // do not auto-save to history until user confirms Save to History
}

/* History */
function renderHistory(){
  historyList.innerHTML='';
  const q = historySearch.value.trim().toLowerCase();
  const from = fromDate.value? new Date(fromDate.value):null;
  const to = toDate.value? new Date(toDate.value):null;
  const scoreF = scoreFilter.value;
  db.sprints.slice().reverse().forEach(s=>{
    // filters
    if(q){
      const content = (s.title+' '+s.goal+' '+(s.tasks||[]).map(t=>t.text).join(' ')).toLowerCase();
      if(!content.includes(q)) return;
    }
    if(from && new Date(s.startISO) < from) return;
    if(to && new Date(s.startISO) > new Date(to.getTime()+24*3600*1000)) return;
    if(scoreF){
      if(scoreF==='>=1' && s.score<1) return;
      if(scoreF==='<1' && s.score>=1) return;
    }
    const div = document.createElement('div');
    div.className='history-item';
    div.innerHTML = `
      <div>
        <div style="font-weight:700">${escapeHtml(s.title)}</div>
        <div class="small-muted">${new Date(s.startISO).toLocaleString()} • ${s.durationMin} min • score ${s.score.toFixed(2)}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="icon-btn expand" aria-expanded="false">Details</button>
        <button class="icon-btn export-s" title="Export sprint">⤓</button>
      </div>
    `;
    const detailsBtn = div.querySelector('.expand');
    const exportBtn = div.querySelector('.export-s');
    let expanded=false; let detailsDiv=null;
    detailsBtn.addEventListener('click', e=>{
      expanded = !expanded;
      detailsBtn.setAttribute('aria-expanded', expanded.toString());
      if(expanded){
        detailsDiv = document.createElement('div');
        detailsDiv.style.marginTop='8px';
        detailsDiv.innerHTML = `
          <div class="small-muted">Goal: ${escapeHtml(s.goal||'')}</div>
          <div style="margin-top:8px"><strong>Tasks</strong>
            <ul>${(s.tasks||[]).map(t=>'<li>'+escapeHtml((t.done? '✓ ':'')+t.text+' ['+t.priority+(t.context? ' • '+t.context:'')+']')+'</li>').join('')}</ul>
          </div>
          <div style="margin-top:8px"><strong>Distractions</strong>
            <ul>${(s.distractions||[]).map(d=>'<li>'+escapeHtml(new Date(d.tsISO).toLocaleString()+' • '+(d.avoidable? 'Avoidable':'Unavoidable')+' • '+(d.note||''))+'</li>').join('')}</ul>
          </div>
          <div style="margin-top:8px"><strong>Notes snapshot</strong>
            <div class="preview">${escapeHtml(s.quickNotesSnapshot||'')}</div>
          </div>
        `;
        div.appendChild(detailsDiv);
      } else {
        if(detailsDiv) detailsDiv.remove();
      }
    });
    exportBtn.addEventListener('click', e=>{
      downloadJSON(s, `sprint-${s.id}.json`);
    });
    historyList.appendChild(div);
  });
}

/* Quick Notes markdown-lite preview */
function renderPreview(){
  const md = (db.quickNotes.content||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const withBold = md.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  const withItal = withBold.replace(/\*(.+?)\*/g,'<em>$1</em>');
  const withBullets = withItal.replace(/^\s*[-*]\s+(.*)$/gm,'• $1');
  notesPreview.innerHTML = withBullets;
}

/* Export / Import */
function downloadJSON(obj, filename='export.json'){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      // validate basic shape
      if(!data.sprints || !Array.isArray(data.sprints)) throw new Error('Invalid file: missing sprints array');
      db.sprints = (db.sprints || []).concat(data.sprints).slice(-HISTORY_CAP);
      save(); renderApp(); alert('Import OK');
    }catch(err){
      alert('Import failed: '+err.message);
    }
  };
  reader.readAsText(file);
}

/* Helpers */
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function announceToSR(msg){
  const live = document.createElement('div'); live.className='visually-hidden'; live.setAttribute('aria-live','polite'); live.textContent=msg;
  document.body.appendChild(live);
  setTimeout(()=>live.remove(),2000);
}

/* Modal focus trap */
function trapFocus(modalEl){
  const focusable = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
  const nodes = modalEl.querySelectorAll(focusable);
  if(!nodes.length) return ()=>{};
  const first = nodes, last = nodes[nodes.length-1];
  function keyHandler(e){
    if(e.key==='Tab'){
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    } else if(e.key==='Escape'){ closeModalFunc(); }
  }
  modalEl.addEventListener('keydown', keyHandler);
  return ()=> modalEl.removeEventListener('keydown', keyHandler);
}

/* Event wiring */
newSprintBtn.addEventListener('click', e=>{
  openModal();
});
function openModal(){
  modal.setAttribute('aria-hidden','false');
  setTimeout(()=> modalTitleInput.focus(),50);
  window._trap = trapFocus(modal);
}
function closeModalFunc(){
  modal.setAttribute('aria-hidden','true');
  if(window._trap) window._trap();
  newSprintBtn.focus();
}
closeModal.addEventListener('click', closeModalFunc);
cancelModal.addEventListener('click', closeModalFunc);
newSprintForm.addEventListener('submit', e=>{
  e.preventDefault();
  const title = modalTitleInput.value.trim() || 'Sprint';
  const durationMin = Number(modalDuration.value||25);
  const goal = modalGoal.value.trim();
  startSprintFrom({title,durationMin,goal,tasks:[]});
  closeModalFunc();
});

/* Add task */
addTaskBtn.addEventListener('click', addTask);
newTaskText.addEventListener('keydown', e=>{ if(e.key==='Enter') { e.preventDefault(); addTask(); }});
function addTask(){
  if(!db.currentSprint){
    alert('Start a sprint first');
    return;
  }
  const text = newTaskText.value.trim();
  if(!text) return;
  const t = { id: uid(), text, priority: newTaskPriority.value, context: newTaskContext.value||'', done:false, order: (db.currentSprint.tasks||[]).length };
  db.currentSprint.tasks = db.currentSprint.tasks || [];
  db.currentSprint.tasks.push(t);
  newTaskText.value=''; save(); renderApp();
}

/* Distract button */
distractBtn.addEventListener('click', ()=>{
  if(!db.currentSprint){ alert('No active sprint'); return; }
  const note = prompt('Distraction note (optional)')||'';
  logDistraction(note);
});

/* Timer buttons */
startBtn.addEventListener('click', ()=>{
  if(!db.currentSprint){
    // open modal prefilled with duration selection
    modalDuration.value = durationSelect.value;
    openModal();
    setTimeout(()=> modalTitleInput.focus(),60);
  } else {
    // resume or start if not started
    if(!db.currentSprint.startISO){
      db.currentSprint.startISO = new Date().toISOString();
      db.currentSprint.running = true;
      totalSeconds = db.currentSprint.durationMin*60;
      tickLeft = totalSeconds;
      save();
      startInterval();
    } else {
      // if paused or stopped, start/resume
      if(!db.currentSprint.running){ db.currentSprint.running = true; paused=false; startInterval(); save(); }
      else { /* already running */ }
    }
  }
});
pauseBtn.addEventListener('click', pauseResume);
stopBtn.addEventListener('click', ()=>{
  if(confirm('End sprint now?')) stopSprintManual();
});

/* Retro modal controls */
saveRetroBtn.addEventListener('click', ()=>{
  if(!db.currentSprint) return;
  // push into history
  db.sprints = db.sprints || [];
  db.sprints.push(db.currentSprint);
  db.currentSprint = null;
  clampHistory();
  retroModal.setAttribute('aria-hidden','true');
  renderApp();
});
closeRetro.addEventListener('click', ()=> retroModal.setAttribute('aria-hidden','true'));
cancelRetroBtn.addEventListener('click', ()=> retroModal.setAttribute('aria-hidden','true'));

/* Import / Export */
exportAllBtn.addEventListener('click', ()=> downloadJSON(db, 'pocketSprint-history.json'));
importFile.addEventListener('change', e=>{
  const f = e.target.files;
  if(f) importJSONFile(f);
  importFile.value='';
});
clearHistoryBtn.addEventListener('click', ()=>{
  if(confirm('Clear entire history?')){ db.sprints=[]; save(); renderApp(); }
});

/* Quick notes */
let notesSaveTimeout=null;
quickNotes.addEventListener('input', e=>{
  if(notesSaveTimeout) clearTimeout(notesSaveTimeout);
  notesSaveTimeout = setTimeout(()=> {
    db.quickNotes.content = quickNotes.value;
    db.quickNotes.updatedISO = isoNow();
    save();
    notesSaveTimeout=null;
  },500);
});
notesPreviewToggle.addEventListener('click', ()=>{
  notesPreview.classList.toggle('hidden');
  notesPreviewToggle.setAttribute('aria-pressed', notesPreview.classList.contains('hidden')? 'false':'true');
  if(!notesPreview.classList.contains('hidden')){
    db.quickNotes.content = quickNotes.value; save(); renderPreview(); notesPreview.setAttribute('aria-hidden','false');
  } else notesPreview.setAttribute('aria-hidden','true');
});
exportNotesBtn.addEventListener('click', ()=>{
  const blob = new Blob([quickNotes.value||''],{type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'quicknotes.txt'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
clearNotesBtn.addEventListener('click', ()=>{ if(confirm('Clear quick notes?')){ quickNotes.value=''; db.quickNotes.content=''; db.quickNotes.updatedISO = isoNow(); save(); renderPreview(); } });

/* Help overlay */
helpBtn.addEventListener('click', ()=> toggleHelp());
closeHelp.addEventListener('click', ()=> toggleHelp());
function toggleHelp(){
  const open = helpOverlay.getAttribute('aria-hidden')==='false';
  helpOverlay.setAttribute('aria-hidden', (!open).toString());
  if(!open) { helpOverlay.querySelector('.help-card button, .help-card').focus(); }
}

/* Keyboard shortcuts - ignore when in text input */
document.addEventListener('keydown', e=>{
  if(e.ctrlKey||e.metaKey||e.altKey) return;
  const tag = document.activeElement && document.activeElement.tagName;
  const inInput = tag==='INPUT' || tag==='TEXTAREA' || document.activeElement.isContentEditable;
  const k = e.key.toUpperCase();
  if(inInput) {
    if(k==='H' && e.altKey){ toggleHelp(); e.preventDefault(); }
    return;
  }
  if(k===db.settings.shortcuts.start) { startBtn.click(); e.preventDefault(); }
  if(k===db.settings.shortcuts.pause) { pauseBtn.click(); e.preventDefault(); }
  if(k===db.settings.shortcuts.newTask) { newTaskText.focus(); e.preventDefault(); }
  if(k===db.settings.shortcuts.distract) { distractBtn.click(); e.preventDefault(); }
  if(k===db.settings.shortcuts.notes) { if(notesPreview.classList.contains('hidden')) { notesPreview.classList.remove('hidden'); renderPreview(); } quickNotes.focus(); e.preventDefault(); }
  if(k===db.settings.shortcuts.history) { toggleHistoryBtn.click(); e.preventDefault(); }
  if(k==='H'){ toggleHelp(); e.preventDefault(); }
});

/* Toggle history panel visibility */
toggleHistoryBtn.addEventListener('click', ()=>{
  const expanded = toggleHistoryBtn.getAttribute('aria-pressed') === 'true';
  toggleHistoryBtn.setAttribute('aria-pressed', (!expanded).toString());
  // simple visual: scroll history into view or hide
  if(!expanded) historyList.scrollIntoView({behavior:'smooth'});
});

/* History filters */
historySearch.addEventListener('input', renderHistory);
fromDate.addEventListener('change', renderHistory);
toDate.addEventListener('change', renderHistory);
scoreFilter.addEventListener('change', renderHistory);

/* Storage atomic save already used in save() */

/* Service worker registration via blob (caching this file) */
if('serviceWorker' in navigator){
  try{
    const swCode = `
      const CACHE='pocket-sprint-cache-v1';
      self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))); });
    `;
    const swBlob = new Blob([swCode], {type:'application/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{/*fail safe*/});
  }catch(e){ console.warn('SW reg failed',e); }
}

/* Storage load on start */
renderApp();

/* If there is an existing currentSprint in storage and running, resume timer accordingly */
if(db.currentSprint && db.currentSprint.startISO && db.currentSprint.running){
  const elapsed = Math.round((Date.now() - new Date(db.currentSprint.startISO).getTime())/1000);
  totalSeconds = db.currentSprint.durationMin*60;
  tickLeft = Math.max(0, totalSeconds - elapsed);
  startInterval();
  renderDistractions();
}

/* If current sprint exists but not running, show it */
if(db.currentSprint){
  renderDistractions();
}

/* Save on unload to be safe */
window.addEventListener('beforeunload', save);

/* Accessibility: ensure buttons and inputs are tabbable already via native markup */

/* Simple error handling on localStorage quota full */
window.addEventListener('error', function(e){ if(e && e.message && e.message.toLowerCase().includes('quota')) alert('Storage quota exceeded. Export your history and clear space.'); });

/* Helpers for import/export single sprint via history item handled in renderHistory */

/* Expose limited functions for testing (not necessary in prod) */
window._pocketSprint = {
  db, save, startSprintFrom, logDistraction
};

})();
</script>
</body>
</html>
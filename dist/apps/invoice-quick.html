<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-11-17T13:30:54.397157Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Invoice Quick</title>
<style>
  :root {
    --color-bg-light: #f9f9f9;
    --color-bg-dark: #121212;
    --color-text-light: #222;
    --color-text-dark: #eee;
    --color-gray: #888;
    --color-blue: #2a6df4;
    --color-green: #2a9d8f;
    --color-red: #e63946;
    --color-yellow: #f4a261;
    --color-error: #d62828;
    --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  }
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: var(--font-family);
    background: var(--color-bg-light);
    color: var(--color-text-light);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  body.dark {
    background: var(--color-bg-dark);
    color: var(--color-text-dark);
  }
  header {
    background: var(--color-blue);
    color: white;
    padding: 1rem;
    text-align: center;
    font-weight: 700;
    font-size: 1.5rem;
    user-select: none;
  }
  main {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    max-width: 900px;
    margin: 0 auto;
    padding: 0.5rem 1rem 1rem;
  }
  #dashboard {
    display: flex;
    justify-content: space-around;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  .dash-item {
    background: var(--color-yellow);
    color: var(--color-bg-light);
    border-radius: 6px;
    padding: 0.5rem 1rem;
    margin: 0.25rem;
    flex: 1 1 120px;
    text-align: center;
    font-weight: 600;
  }
  body.dark .dash-item {
    background: var(--color-green);
    color: var(--color-text-dark);
  }
  #search-filter {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  #search-filter input[type="text"] {
    flex: 1 1 250px;
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    border: 1px solid var(--color-gray);
    border-radius: 4px;
  }
  #invoice-list-container {
    flex: 1 1 auto;
    overflow-y: auto;
    border: 1px solid var(--color-gray);
    border-radius: 6px;
    background: var(--color-bg-light);
    min-height: 180px;
  }
  body.dark #invoice-list-container {
    background: #222;
    border-color: #444;
  }
  #invoice-list {
    list-style: none;
    margin: 0; padding: 0;
  }
  #invoice-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--color-gray);
    cursor: grab;
    user-select: none;
  }
  body.dark #invoice-list li {
    border-color: #444;
  }
  #invoice-list li[aria-selected="true"] {
    background: var(--color-blue);
    color: white;
  }
  #invoice-list li.dragging {
    opacity: 0.5;
  }
  .invoice-info {
    flex: 1 1 auto;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
    font-size: 0.9rem;
  }
  .invoice-info > span {
    white-space: nowrap;
  }
  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.4rem;
    display: inline-block;
    vertical-align: middle;
  }
  .status-draft {
    background: gray;
  }
  .status-sent {
    background: var(--color-blue);
  }
  .status-paid {
    background: var(--color-green);
  }
  .invoice-actions {
    display: flex;
    gap: 0.5rem;
  }
  button {
    background: var(--color-blue);
    border: none;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
  }
  button:focus {
    outline: 2px solid var(--color-yellow);
    outline-offset: 2px;
  }
  button.delete {
    background: var(--color-red);
  }
  button.export {
    background: var(--color-green);
  }
  button:disabled {
    background: var(--color-gray);
    cursor: default;
  }
  #paid-dropzone {
    margin: 0.5rem 0;
    padding: 0.5rem;
    border: 2px dashed var(--color-green);
    border-radius: 6px;
    color: var(--color-green);
    text-align: center;
    font-weight: 600;
    user-select: none;
  }
  body.dark #paid-dropzone {
    border-color: #4caf50;
    color: #4caf50;
  }
  form {
    background: var(--color-bg-light);
    border: 1px solid var(--color-gray);
    border-radius: 6px;
    padding: 1rem;
    margin-top: 1rem;
    max-width: 600px;
  }
  body.dark form {
    background: #222;
    border-color: #444;
  }
  form > div {
    margin-bottom: 0.8rem;
  }
  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  input[type="text"],
  input[type="number"],
  input[type="date"],
  select,
  textarea {
    width: 100%;
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    border: 1px solid var(--color-gray);
    border-radius: 4px;
    box-sizing: border-box;
  }
  body.dark input[type="text"],
  body.dark input[type="number"],
  body.dark input[type="date"],
  body.dark select,
  body.dark textarea {
    background: #333;
    border-color: #555;
    color: var(--color-text-dark);
  }
  .error-message {
    color: var(--color-error);
    font-size: 0.85rem;
    margin-top: 0.2rem;
  }
  .form-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .form-row > div {
    flex: 1 1 45%;
  }
  .totals {
    font-weight: 700;
    font-size: 1.1rem;
    margin-top: 0.5rem;
    display: flex;
    justify-content: space-between;
  }
  .status-select {
    width: 100%;
  }
  #dark-mode-toggle {
    position: fixed;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--color-blue);
    border: none;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    user-select: none;
  }
  #dark-mode-toggle:focus {
    outline: 2px solid var(--color-yellow);
    outline-offset: 2px;
  }
  /* Modal styles */
  #modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  #modal-overlay.active {
    display: flex;
  }
  #modal {
    background: var(--color-bg-light);
    color: var(--color-text-light);
    max-width: 700px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    box-sizing: border-box;
    position: relative;
  }
  body.dark #modal {
    background: #222;
    color: var(--color-text-dark);
  }
  #modal-close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    font-size: 1.5rem;
    color: inherit;
    cursor: pointer;
  }
  #modal-close:focus {
    outline: 2px solid var(--color-yellow);
    outline-offset: 2px;
  }
  #printable-invoice {
    font-family: var(--font-family);
    color: var(--color-text-light);
  }
  body.dark #printable-invoice {
    color: var(--color-text-dark);
  }
  #printable-invoice h2 {
    margin-top: 0;
  }
  #printable-invoice table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  #printable-invoice th,
  #printable-invoice td {
    border: 1px solid var(--color-gray);
    padding: 0.5rem;
    text-align: left;
  }
  #printable-invoice tfoot td {
    font-weight: 700;
  }
  @media print {
    body *:not(#printable-invoice):not(#printable-invoice *) {
      display: none !important;
    }
    #printable-invoice {
      display: block !important;
      margin: 0;
      padding: 0;
      color: black !important;
      background: white !important;
    }
  }
  @media (max-width: 600px) {
    .form-row {
      flex-direction: column;
    }
    .form-row > div {
      flex: 1 1 100%;
    }
    #dashboard {
      flex-direction: column;
      align-items: center;
    }
    .dash-item {
      width: 90%;
      margin: 0.25rem auto;
    }
  }
</style>
</head>
<body>
<header>Invoice Quick</header>
<button id="dark-mode-toggle" aria-pressed="false" aria-label="Toggle dark mode">Dark Mode</button>
<main>
  <section id="dashboard" aria-label="Invoice summary dashboard">
    <div class="dash-item" id="total-invoices" tabindex="0" aria-live="polite">Invoices: 0</div>
    <div class="dash-item" id="total-outstanding" tabindex="0" aria-live="polite">Outstanding: $0.00</div>
    <div class="dash-item" id="total-paid" tabindex="0" aria-live="polite">Paid: $0.00</div>
  </section>
  <section id="search-filter" aria-label="Search and filter invoices">
    <input type="text" id="search-input" placeholder="Search by client or invoice #" aria-label="Search invoices by client name or invoice number" />
  </section>
  <section id="paid-dropzone" tabindex="0" aria-label="Drag invoices here to mark as paid" role="region">
    Drag invoices here to mark as Paid
  </section>
  <section id="invoice-list-container" aria-label="List of invoices" tabindex="0">
    <ul id="invoice-list" role="listbox" aria-multiselectable="false" tabindex="0"></ul>
  </section>
  <form id="invoice-form" aria-label="Create or edit invoice form" novalidate>
    <h2 id="form-title">Create Invoice</h2>
    <div>
      <label for="client-name">Client Name <span aria-hidden="true">*</span></label>
      <input type="text" id="client-name" name="clientName" required autocomplete="off" />
      <div class="error-message" id="error-client-name" aria-live="assertive"></div>
    </div>
    <div>
      <label for="service-description">Service Description <span aria-hidden="true">*</span></label>
      <textarea id="service-description" name="serviceDescription" rows="2" required></textarea>
      <div class="error-message" id="error-service-description" aria-live="assertive"></div>
    </div>
    <div class="form-row">
      <div>
        <label for="hourly-rate">Hourly Rate ($) <span aria-hidden="true">*</span></label>
        <input type="number" id="hourly-rate" name="hourlyRate" min="0" step="0.01" required inputmode="decimal" />
        <div class="error-message" id="error-hourly-rate" aria-live="assertive"></div>
      </div>
      <div>
        <label for="hours-worked">Hours Worked <span aria-hidden="true">*</span></label>
        <input type="number" id="hours-worked" name="hoursWorked" min="0" step="0.01" required inputmode="decimal" />
        <div class="error-message" id="error-hours-worked" aria-live="assertive"></div>
      </div>
    </div>
    <div>
      <label for="due-date">Due Date <span aria-hidden="true">*</span></label>
      <input type="date" id="due-date" name="dueDate" required />
      <div class="error-message" id="error-due-date" aria-live="assertive"></div>
    </div>
    <div>
      <label for="tax-rate">Tax Rate (%)</label>
      <input type="number" id="tax-rate" name="taxRate" min="0" max="100" step="0.01" inputmode="decimal" value="10" />
    </div>
    <div class="totals" aria-live="polite" aria-atomic="true">
      <span>Subtotal: $<span id="subtotal">0.00</span></span>
      <span>Tax: $<span id="tax-amount">0.00</span></span>
      <span>Total: $<span id="total-amount">0.00</span></span>
    </div>
    <div>
      <label for="status-select">Status</label>
      <select id="status-select" name="status">
        <option value="draft">Draft</option>
        <option value="sent">Sent</option>
        <option value="paid">Paid</option>
      </select>
    </div>
    <div style="margin-top:1rem; display:flex; gap:0.5rem; flex-wrap: wrap;">
      <button type="submit" id="save-invoice-btn">Save Invoice</button>
      <button type="button" id="reset-form-btn">New Invoice</button>
    </div>
  </form>
</main>

<div id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
  <div id="modal">
    <button id="modal-close" aria-label="Close modal">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // Constants and selectors
  const STORAGE_KEY = "invoices_data";

  // Elements
  const invoiceListEl = document.getElementById("invoice-list");
  const searchInputEl = document.getElementById("search-input");
  const paidDropzoneEl = document.getElementById("paid-dropzone");
  const darkModeToggleBtn = document.getElementById("dark-mode-toggle");
  const modalOverlay = document.getElementById("modal-overlay");
  const modalContent = document.getElementById("modal-content");
  const modalCloseBtn = document.getElementById("modal-close");

  // Dashboard elements
  const totalInvoicesEl = document.getElementById("total-invoices");
  const totalOutstandingEl = document.getElementById("total-outstanding");
  const totalPaidEl = document.getElementById("total-paid");

  // Form elements
  const invoiceForm = document.getElementById("invoice-form");
  const formTitle = document.getElementById("form-title");
  const clientNameInput = document.getElementById("client-name");
  const serviceDescInput = document.getElementById("service-description");
  const hourlyRateInput = document.getElementById("hourly-rate");
  const hoursWorkedInput = document.getElementById("hours-worked");
  const dueDateInput = document.getElementById("due-date");
  const taxRateInput = document.getElementById("tax-rate");
  const subtotalEl = document.getElementById("subtotal");
  const taxAmountEl = document.getElementById("tax-amount");
  const totalAmountEl = document.getElementById("total-amount");
  const statusSelect = document.getElementById("status-select");
  const saveInvoiceBtn = document.getElementById("save-invoice-btn");
  const resetFormBtn = document.getElementById("reset-form-btn");

  // Error message elements
  const errorClientName = document.getElementById("error-client-name");
  const errorServiceDesc = document.getElementById("error-service-description");
  const errorHourlyRate = document.getElementById("error-hourly-rate");
  const errorHoursWorked = document.getElementById("error-hours-worked");
  const errorDueDate = document.getElementById("error-due-date");

  // State
  let invoices = [];
  let filteredInvoices = [];
  let editingInvoiceId = null;
  let selectedInvoiceIndex = -1;
  let dragSrcIndex = null;

  // Utility functions
  function formatCurrency(num) {
    return num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function todayYYYYMMDD() {
    const d = new Date();
    return d.toISOString().slice(0,10).replace(/-/g,"");
  }

  function generateInvoiceNumber() {
    // Find max #### for today and increment
    const datePart = todayYYYYMMDD();
    const todayInvoices = invoices.filter(inv => inv.invoiceNumber && inv.invoiceNumber.startsWith("INV-" + datePart));
    let maxNum = 0;
    todayInvoices.forEach(inv => {
      const parts = inv.invoiceNumber.split("-");
      if(parts.length === 3){
        const num = parseInt(parts[2],10);
        if(!isNaN(num) && num > maxNum) maxNum = num;
      }
    });
    const nextNum = (maxNum + 1).toString().padStart(4,"0");
    return `INV-${datePart}-${nextNum}`;
  }

  function saveInvoicesToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
  }

  function loadInvoicesFromStorage() {
    const data = localStorage.getItem(STORAGE_KEY);
    if(data){
      try {
        invoices = JSON.parse(data);
      } catch {
        invoices = [];
      }
    } else {
      invoices = [];
    }
  }

  function validateForm() {
    let valid = true;
    clearErrors();

    if(!clientNameInput.value.trim()){
      errorClientName.textContent = "Client name is required.";
      valid = false;
    }
    if(!serviceDescInput.value.trim()){
      errorServiceDesc.textContent = "Service description is required.";
      valid = false;
    }
    if(hourlyRateInput.value === "" || Number(hourlyRateInput.value) < 0){
      errorHourlyRate.textContent = "Hourly rate must be zero or positive.";
      valid = false;
    }
    if(hoursWorkedInput.value === "" || Number(hoursWorkedInput.value) < 0){
      errorHoursWorked.textContent = "Hours worked must be zero or positive.";
      valid = false;
    }
    if(!dueDateInput.value){
      errorDueDate.textContent = "Due date is required.";
      valid = false;
    }
    return valid;
  }

  function clearErrors() {
    errorClientName.textContent = "";
    errorServiceDesc.textContent = "";
    errorHourlyRate.textContent = "";
    errorHoursWorked.textContent = "";
    errorDueDate.textContent = "";
  }

  function calculateTotals() {
    const rate = parseFloat(hourlyRateInput.value) || 0;
    const hours = parseFloat(hoursWorkedInput.value) || 0;
    const taxPercent = parseFloat(taxRateInput.value) || 0;
    const subtotal = rate * hours;
    const tax = subtotal * taxPercent / 100;
    const total = subtotal + tax;
    subtotalEl.textContent = formatCurrency(subtotal);
    taxAmountEl.textContent = formatCurrency(tax);
    totalAmountEl.textContent = formatCurrency(total);
    return {subtotal, tax, total};
  }

  function clearForm() {
    invoiceForm.reset();
    subtotalEl.textContent = "0.00";
    taxAmountEl.textContent = "0.00";
    totalAmountEl.textContent = "0.00";
    statusSelect.value = "draft";
    editingInvoiceId = null;
    formTitle.textContent = "Create Invoice";
    clearErrors();
  }

  function renderInvoiceList() {
    invoiceListEl.innerHTML = "";
    filteredInvoices.forEach((inv, i) => {
      const li = document.createElement("li");
      li.setAttribute("role", "option");
      li.setAttribute("tabindex", "-1");
      li.dataset.index = i;
      li.draggable = true;
      li.id = `invoice-item-${i}`;
      if(i === selectedInvoiceIndex) {
        li.setAttribute("aria-selected", "true");
        li.tabIndex = 0;
        li.focus();
      } else {
        li.removeAttribute("aria-selected");
      }
      // Status color
      let statusClass = "status-draft";
      if(inv.status === "sent") statusClass = "status-sent";
      else if(inv.status === "paid") statusClass = "status-paid";

      li.innerHTML = `
        <div class="invoice-info" aria-label="Invoice ${inv.invoiceNumber} for ${inv.clientName}">
          <span><strong>${inv.invoiceNumber || "(No #)"}</strong></span>
          <span>${inv.clientName}</span>
          <span>${inv.serviceDescription}</span>
          <span>$${formatCurrency(inv.hourlyRate)} / hr</span>
          <span>${formatCurrency(inv.hoursWorked)} hrs</span>
          <span>Due: ${inv.dueDate}</span>
          <span><span class="status-indicator ${statusClass}" aria-hidden="true"></span>${inv.status}</span>
        </div>
        <div class="invoice-actions">
          <button type="button" class="edit-btn" aria-label="Edit invoice ${inv.invoiceNumber}">Edit</button>
          <button type="button" class="export-btn" aria-label="Export invoice ${inv.invoiceNumber}">Export</button>
          <button type="button" class="delete-btn" aria-label="Delete invoice ${inv.invoiceNumber}">Delete</button>
        </div>
      `;
      invoiceListEl.appendChild(li);
    });
    updateDashboard();
  }

  function updateDashboard() {
    totalInvoicesEl.textContent = `Invoices: ${invoices.length}`;
    const outstanding = invoices
      .filter(inv => inv.status !== "paid")
      .reduce((sum, inv) => sum + (inv.subtotal || 0) + (inv.tax || 0), 0);
    const paid = invoices
      .filter(inv => inv.status === "paid")
      .reduce((sum, inv) => sum + (inv.subtotal || 0) + (inv.tax || 0), 0);
    totalOutstandingEl.textContent = `Outstanding: $${formatCurrency(outstanding)}`;
    totalPaidEl.textContent = `Paid: $${formatCurrency(paid)}`;
  }

  function filterInvoices() {
    const query = searchInputEl.value.trim().toLowerCase();
    if(!query) {
      filteredInvoices = invoices.slice();
    } else {
      filteredInvoices = invoices.filter(inv =>
        (inv.clientName && inv.clientName.toLowerCase().includes(query)) ||
        (inv.invoiceNumber && inv.invoiceNumber.toLowerCase().includes(query))
      );
    }
    selectedInvoiceIndex = -1;
    renderInvoiceList();
  }

  function fillFormWithInvoice(inv) {
    clientNameInput.value = inv.clientName || "";
    serviceDescInput.value = inv.serviceDescription || "";
    hourlyRateInput.value = inv.hourlyRate != null ? inv.hourlyRate : "";
    hoursWorkedInput.value = inv.hoursWorked != null ? inv.hoursWorked : "";
    dueDateInput.value = inv.dueDate || "";
    taxRateInput.value = inv.taxRate != null ? inv.taxRate : "10";
    statusSelect.value = inv.status || "draft";
    calculateTotals();
  }

  function getFormData() {
    return {
      clientName: clientNameInput.value.trim(),
      serviceDescription: serviceDescInput.value.trim(),
      hourlyRate: parseFloat(hourlyRateInput.value) || 0,
      hoursWorked: parseFloat(hoursWorkedInput.value) || 0,
      dueDate: dueDateInput.value,
      taxRate: parseFloat(taxRateInput.value) || 0,
      subtotal: 0,
      tax: 0,
      total: 0,
      status: statusSelect.value,
      invoiceNumber: null,
      id: null,
      createdAt: null,
      updatedAt: null
    };
  }

  function saveInvoice() {
    if(!validateForm()) return false;
    const data = getFormData();
    const totals = calculateTotals();
    data.subtotal = totals.subtotal;
    data.tax = totals.tax;
    data.total = totals.total;
    if(editingInvoiceId) {
      // Update existing
      const idx = invoices.findIndex(inv => inv.id === editingInvoiceId);
      if(idx !== -1) {
        data.invoiceNumber = invoices[idx].invoiceNumber || generateInvoiceNumber();
        data.id = editingInvoiceId;
        data.createdAt = invoices[idx].createdAt;
        data.updatedAt = new Date().toISOString();
        invoices[idx] = data;
      }
    } else {
      // New invoice
      data.invoiceNumber = generateInvoiceNumber();
      data.id = crypto.randomUUID();
      data.createdAt = new Date().toISOString();
      data.updatedAt = data.createdAt;
      invoices.push(data);
    }
    saveInvoicesToStorage();
    filterInvoices();
    clearForm();
    return true;
  }

  function deleteInvoiceById(id) {
    const idx = invoices.findIndex(inv => inv.id === id);
    if(idx !== -1) {
      invoices.splice(idx, 1);
      saveInvoicesToStorage();
      filterInvoices();
    }
  }

  function exportInvoiceHTML(inv) {
    const html = `
      <div id="printable-invoice" role="document" aria-label="Invoice ${inv.invoiceNumber}">
        <h2>Invoice ${inv.invoiceNumber}</h2>
        <p><strong>Client:</strong> ${inv.clientName}</p>
        <p><strong>Service Description:</strong> ${inv.serviceDescription}</p>
        <p><strong>Due Date:</strong> ${inv.dueDate}</p>
        <table>
          <thead>
            <tr>
              <th>Hourly Rate</th>
              <th>Hours Worked</th>
              <th>Subtotal</th>
              <th>Tax Rate</th>
              <th>Tax Amount</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>$${formatCurrency(inv.hourlyRate)}</td>
              <td>${formatCurrency(inv.hoursWorked)}</td>
              <td>$${formatCurrency(inv.subtotal)}</td>
              <td>${formatCurrency(inv.taxRate)}%</td>
              <td>$${formatCurrency(inv.tax)}</td>
              <td>$${formatCurrency(inv.total)}</td>
            </tr>
          </tbody>
        </table>
        <p><strong>Status:</strong> ${inv.status}</p>
      </div>
    `;
    return html;
  }

  function openModal(contentHTML) {
    modalContent.innerHTML = contentHTML;
    modalOverlay.classList.add("active");
    modalOverlay.focus();
  }

  function closeModal() {
    modalOverlay.classList.remove("active");
    modalContent.innerHTML = "";
    invoiceListEl.focus();
  }

  // Event handlers
  invoiceForm.addEventListener("input", () => {
    calculateTotals();
  });

  invoiceForm.addEventListener("submit", e => {
    e.preventDefault();
    if(saveInvoice()) {
      resetFormBtn.focus();
    }
  });

  resetFormBtn.addEventListener("click", () => {
    clearForm();
    clientNameInput.focus();
  });

  searchInputEl.addEventListener("input", () => {
    filterInvoices();
  });

  invoiceListEl.addEventListener("click", e => {
    if(e.target.classList.contains("edit-btn")) {
      const li = e.target.closest("li");
      const idx = Number(li.dataset.index);
      const inv = filteredInvoices[idx];
      if(inv) {
        editingInvoiceId = inv.id;
        fillFormWithInvoice(inv);
        formTitle.textContent = `Edit Invoice (${inv.invoiceNumber})`;
        clientNameInput.focus();
      }
    } else if(e.target.classList.contains("delete-btn")) {
      const li = e.target.closest("li");
      const idx = Number(li.dataset.index);
      const inv = filteredInvoices[idx];
      if(inv) {
        if(confirm(`Delete invoice ${inv.invoiceNumber}? This action cannot be undone.`)) {
          deleteInvoiceById(inv.id);
          editingInvoiceId = null;
          clearForm();
        }
      }
    } else if(e.target.classList.contains("export-btn")) {
      const li = e.target.closest("li");
      const idx = Number(li.dataset.index);
      const inv = filteredInvoices[idx];
      if(inv) {
        const printableHTML = exportInvoiceHTML(inv);
        openModal(printableHTML + `<button id="print-btn" style="margin-top:1rem;">Print</button>`);
        document.getElementById("print-btn").addEventListener("click", () => {
          window.print();
        });
      }
    }
  });

  // Keyboard navigation in invoice list
  invoiceListEl.addEventListener("keydown", e => {
    if(filteredInvoices.length === 0) return;
    if(e.key === "ArrowDown") {
      e.preventDefault();
      if(selectedInvoiceIndex < filteredInvoices.length - 1) selectedInvoiceIndex++;
      else selectedInvoiceIndex = 0;
      renderInvoiceList();
    } else if(e.key === "ArrowUp") {
      e.preventDefault();
      if(selectedInvoiceIndex > 0) selectedInvoiceIndex--;
      else selectedInvoiceIndex = filteredInvoices.length - 1;
      renderInvoiceList();
    } else if(e.key === "Delete") {
      if(selectedInvoiceIndex >= 0 && selectedInvoiceIndex < filteredInvoices.length) {
        e.preventDefault();
        const inv = filteredInvoices[selectedInvoiceIndex];
        if(inv && confirm(`Delete invoice ${inv.invoiceNumber}? This action cannot be undone.`)) {
          deleteInvoiceById(inv.id);
          selectedInvoiceIndex = -1;
          clearForm();
        }
      }
    } else if(e.key === "Enter") {
      if(selectedInvoiceIndex >= 0 && selectedInvoiceIndex < filteredInvoices.length) {
        e.preventDefault();
        const inv = filteredInvoices[selectedInvoiceIndex];
        if(inv) {
          editingInvoiceId = inv.id;
          fillFormWithInvoice(inv);
          formTitle.textContent = `Edit Invoice (${inv.invoiceNumber})`;
          clientNameInput.focus();
        }
      }
    }
  });

  // Modal close handlers
  modalCloseBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", e => {
    if(e.target === modalOverlay) closeModal();
  });
  window.addEventListener("keydown", e => {
    if(e.key === "Escape" && modalOverlay.classList.contains("active")) {
      closeModal();
    }
  });

  // Dark mode toggle
  function applyDarkMode(enabled) {
    if(enabled) {
      document.body.classList.add("dark");
      darkModeToggleBtn.setAttribute("aria-pressed", "true");
      darkModeToggleBtn.textContent = "Light Mode";
    } else {
      document.body.classList.remove("dark");
      darkModeToggleBtn.setAttribute("aria-pressed", "false");
      darkModeToggleBtn.textContent = "Dark Mode";
    }
  }
  function loadDarkModeSetting() {
    const val = localStorage.getItem("invoice_quick_dark_mode");
    return val === "true";
  }
  function saveDarkModeSetting(enabled) {
    localStorage.setItem("invoice_quick_dark_mode", enabled ? "true" : "false");
  }
  darkModeToggleBtn.addEventListener("click", () => {
    const enabled = !document.body.classList.contains("dark");
    applyDarkMode(enabled);
    saveDarkModeSetting(enabled);
  });

  // Drag and drop for invoice list reordering
  invoiceListEl.addEventListener("dragstart", e => {
    const li = e.target.closest("li");
    if(!li) return;
    dragSrcIndex = Number(li.dataset.index);
    li.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/plain", dragSrcIndex);
  });
  invoiceListEl.addEventListener("dragend", e => {
    const li = e.target.closest("li");
    if(li) li.classList.remove("dragging");
    dragSrcIndex = null;
  });
  invoiceListEl.addEventListener("dragover", e => {
    e.preventDefault();
    const li = e.target.closest("li");
    if(!li) return;
    const dragTargetIndex = Number(li.dataset.index);
    if(dragSrcIndex === null || dragSrcIndex === dragTargetIndex) return;
    // Reorder filteredInvoices array
    const movedItem = filteredInvoices.splice(dragSrcIndex, 1);
    filteredInvoices.splice(dragTargetIndex, 0, movedItem);
    // Reflect reorder in main invoices array by id order
    invoices = filteredInvoices.slice();
    saveInvoicesToStorage();
    selectedInvoiceIndex = dragTargetIndex;
    renderInvoiceList();
  });

  // Drag to paid dropzone
  paidDropzoneEl.addEventListener("dragover", e => {
    e.preventDefault();
    paidDropzoneEl.style.backgroundColor = "rgba(42,157,143,0.2)";
  });
  paidDropzoneEl.addEventListener("dragleave", e => {
    paidDropzoneEl.style.backgroundColor = "";
  });
  paidDropzoneEl.addEventListener("drop", e => {
    e.preventDefault();
    paidDropzoneEl.style.backgroundColor = "";
    const idxStr = e.dataTransfer.getData("text/plain");
    const idx = Number(idxStr);
    if(isNaN(idx) || idx < 0 || idx >= filteredInvoices.length) return;
    const inv = filteredInvoices[idx];
    if(inv && inv.status !== "paid") {
      const mainIdx = invoices.findIndex(i => i.id === inv.id);
      if(mainIdx !== -1) {
        invoices[mainIdx].status = "paid";
        invoices[mainIdx].updatedAt = new Date().toISOString();
        saveInvoicesToStorage();
        filterInvoices();
      }
    }
  });

  // Keyboard support for paid dropzone (focus + enter sets selected invoice to paid)
  paidDropzoneEl.addEventListener("keydown", e => {
    if(e.key === "Enter" && selectedInvoiceIndex >= 0 && selectedInvoiceIndex < filteredInvoices.length) {
      e.preventDefault();
      const inv = filteredInvoices[selectedInvoiceIndex];
      if(inv && inv.status !== "paid") {
        const mainIdx = invoices.findIndex(i => i.id === inv.id);
        if(mainIdx !== -1) {
          invoices[mainIdx].status = "paid";
          invoices[mainIdx].updatedAt = new Date().toISOString();
          saveInvoicesToStorage();
          filterInvoices();
        }
      }
    }
  });

  // Initialization
  function init() {
    loadInvoicesFromStorage();
    filteredInvoices = invoices.slice();
    renderInvoiceList();
    clearForm();
    filterInvoices();
    // Dark mode
    applyDarkMode(loadDarkModeSetting());
  }

  init();
})();
</script>
</body>
</html>
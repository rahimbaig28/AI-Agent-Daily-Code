<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-12-18T01:25:55.773722Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Accessible Clipboard Helper</title>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#555; --accent:#0066cc; --focus:#ff9800;
    --panel-bg:#f7f7f8; --high-contrast-bg:#000; --high-contrast-fg:#fff;
    --radius:8px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;font-size:16px;color:var(--fg);background:var(--bg);}
  a.skip{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
  a.skip:focus{left:8px;top:8px;width:auto;height:auto;padding:8px;background:#fff;border:2px solid var(--accent);z-index:1000}
  header{display:flex;gap:.5rem;align-items:center;padding:10px;border-bottom:1px solid #e3e3e3;background:var(--panel-bg)}
  header h1{font-size:1.1rem;margin:0}
  .toolbar{display:flex;gap:.4rem;align-items:center;margin-left:auto}
  .toolbar button, .toolbar input[type="search"], .chip{font-size:0.95rem;padding:.4rem .6rem;border-radius:6px;border:1px solid #ccc;background:#fff;color:var(--fg)}
  .toolbar button:focus, .toolbar input:focus, .chip:focus{outline:3px solid var(--focus);outline-offset:2px}
  .toolbar input[type="search"]{min-width:180px}
  main{display:flex;flex-direction:column;height:calc(100vh - 64px)}
  .layout{display:flex;flex:1;gap:12px;padding:12px}
  .pane{background:var(--panel-bg);border-radius:var(--radius);padding:12px;box-sizing:border-box}
  .list-pane{flex:1;min-width:240px;max-width:480px;display:flex;flex-direction:column;gap:8px}
  .detail-pane{flex:2;min-width:260px;display:flex;flex-direction:column;gap:8px}
  .controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .shortcuts-legend{font-size:0.9rem;color:var(--muted);margin-left:8px}
  ul.snippets{list-style:none;margin:0;padding:0;overflow:auto;border-radius:6px}
  li.item{margin:0 0.25rem 0.25rem 0;padding:0}
  button.item-btn{display:block;text-align:left;width:100%;padding:.7rem;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer}
  button.item-btn:focus{outline:3px solid var(--focus);outline-offset:2px}
  .item-title{font-weight:700}
  .item-meta{font-size:.85rem;color:var(--muted)}
  .truncated{display:block;color:var(--muted);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .placeholder{flex:1;display:flex;align-items:center;justify-content:center;color:var(--muted);padding:18px}
  .detail{padding:12px;border:1px solid #ddd;background:#fff;border-radius:6px;min-height:200px;overflow:auto}
  .detail:focus{outline:3px solid var(--focus);outline-offset:2px}
  .detail .title{font-size:1.1rem;font-weight:700;margin:0 0 .4rem 0}
  .meta-row{font-size:.85rem;color:var(--muted);margin-bottom:.6rem}
  .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem}
  button.small{padding:.4rem .6rem;font-size:.95rem;border-radius:6px}
  .editor{display:flex;flex-direction:column;gap:.5rem}
  label{font-size:.9rem}
  input[type="text"], textarea, select{padding:.5rem;border:1px solid #bbb;border-radius:6px;font:inherit}
  textarea{min-height:120px;resize:vertical}
  .preview{border:1px dashed #ccc;padding:10px;border-radius:6px;background:#fff;min-height:60px;overflow:auto}
  .preview.small{font-size:0.9rem}
  .preview.medium{font-size:1.05rem}
  .preview.large{font-size:1.3rem}
  .high-contrast{background:var(--high-contrast-bg);color:var(--high-contrast-fg)}
  .tags{display:flex;gap:.25rem;flex-wrap:wrap;margin-top:.4rem}
  .chip{cursor:pointer}
  .chip[aria-pressed="true"]{background:var(--accent);color:#fff;border-color:var(--accent)}
  footer{padding:8px;border-top:1px solid #e3e3e3;background:var(--panel-bg);font-size:.9rem;display:flex;align-items:center;justify-content:space-between}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .announce{min-height:1.2em}
  /* Focus visible style required */
  :focus{outline-offset:3px}
  /* Responsive */
  @media(min-width:900px){
    main{flex-direction:row}
    .layout{flex-direction:row}
  }
  /* Buttons */
  button{background:#fff;border:1px solid #bbb;padding:.45rem .6rem;border-radius:6px;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .danger{border-color:#c33;color:#c33}
  .success{border-color:#0a8;color:#0a8}
  /* Shortcuts overlay */
  .overlay{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border:2px solid #333;padding:16px;border-radius:8px;z-index:2000;max-width:90%;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .overlay h2{margin:0 0 .5rem 0}
  .overlay button{margin-top:8px}
  /* Large focus outlines and target sizes for touch */
  button,input,textarea{min-height:36px}
</style>
</head>
<body>
<a href="#main" class="skip">Skip to content</a>
<header role="banner" aria-label="Application header">
  <h1 id="app-title">Accessible Clipboard Helper</h1>
  <div class="toolbar" role="toolbar" aria-label="Top toolbar">
    <label for="search" class="sr-only">Search snippets</label>
    <input id="search" type="search" placeholder="Search (/) " aria-label="Search snippets" />
    <button id="contrastToggle" title="Toggle high contrast (H)" aria-pressed="false">Contrast (H)</button>
    <button id="fontDec" title="Decrease font size (-)">A-</button>
    <button id="fontInc" title="Increase font size (+)">A+</button>
    <button id="newBtn" class="small" title="New snippet (N)">New (N)</button>
    <button id="helpBtn" title="Shortcuts and help (?)">Help (?)</button>
    <div class="shortcuts-legend" aria-hidden="true">Shortcuts: N New · C Copy · S Share · H Contrast · M Multi-line · / Search</div>
  </div>
</header>

<main id="main" tabindex="-1" role="main" aria-labelledby="app-title">
  <div class="layout">
    <section class="pane list-pane" aria-label="Saved snippets">
      <div class="controls">
        <div id="count" class="sr-only" aria-live="polite"></div>
        <label for="tagFilter" class="sr-only">Filter by tag</label>
        <div id="tagBar" aria-hidden="false" style="display:flex;gap:.25rem;align-items:center"></div>
        <div style="flex:1"></div>
        <button id="exportBtn" title="Export all snippets as JSON">Export</button>
        <button id="importBtn" title="Import snippets from JSON">Import</button>
        <input id="importArea" class="sr-only" aria-hidden="true" />
      </div>
      <ul id="list" class="snippets" role="list" aria-label="Snippet list"></ul>
    </section>

    <section class="pane detail-pane" aria-label="Snippet detail">
      <div id="detailAnnounce" class="sr-only" aria-live="polite"></div>
      <div id="assertive" class="sr-only" aria-live="assertive"></div>
      <div id="detailArea" class="detail" tabindex="-1" aria-labelledby="detailTitle" role="region">
        <div id="noSelection" class="placeholder">No snippet selected. Press N to create one or select from the list.</div>
        <!-- Detail content injected here -->
      </div>
    </section>
  </div>

  <footer>
    <div>Use keyboard shortcuts: <strong>N</strong> New · <strong>C</strong> Copy · <strong>S</strong> Share · <strong>H</strong> Contrast · <strong>M</strong> Toggle multi-line · <strong>/</strong> Search</div>
    <div>Storage: <span id="storageStatus">ready</span></div>
  </footer>
</main>

<!-- Shortcuts overlay -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="overlayTitle" hidden>
  <h2 id="overlayTitle">Keyboard Shortcuts</h2>
  <div>
    <ul>
      <li><strong>N</strong>: New snippet</li>
      <li><strong>Enter</strong> (on item): Open</li>
      <li><strong>Delete</strong>: Delete focused item</li>
      <li><strong>/</strong>: Focus search</li>
      <li><strong>H</strong>: Toggle high-contrast</li>
      <li><strong>+</strong>/<strong>-</strong>: Increase/Decrease preview font</li>
      <li><strong>M</strong>: Toggle multi-line input</li>
      <li><strong>C</strong>: Copy open snippet</li>
      <li><strong>S</strong>: Share open snippet (sets URL hash)</li>
      <li><strong>Ctrl/Cmd+S</strong>: Save while editing</li>
      <li><strong>Esc</strong>: Close editor/overlay</li>
    </ul>
  </div>
  <button id="overlayClose">Close</button>
</div>

<script>
/* Accessible Clipboard Helper - Single-file app
   Structure:
     - State & storage wrapper
     - DOM refs & render functions
     - Accessibility helpers (announce, focus manage)
     - Event handlers & keyboard shortcuts
     - Hash/share handling
*/

/* ---------- Utilities & Storage ---------- */
const STORAGE_KEY = 'ach.snippets.v1';
const PREF_KEY = 'ach.prefs.v1';
const uid = ()=>('id-'+Math.random().toString(36).slice(2,9));
const nowISO = ()=>new Date().toISOString();

function safeParse(s){try{return JSON.parse(s||'null')}catch(e){return null}}
function loadAll(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return safeParse(raw) || [];
  }catch(e){
    announceAssertive('localStorage unavailable. Export your data as JSON to save it.');
    return [];
  }
}
function saveAll(list){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    return true;
  }catch(e){
    announceAssertive('Saving failed: localStorage may be full or unavailable.');
    return false;
  }
}
function loadPrefs(){ return safeParse(localStorage.getItem(PREF_KEY)) || {font:'medium',contrast:false,multiline:false} }
function savePrefs(p){ localStorage.setItem(PREF_KEY, JSON.stringify(p)); }

/* ---------- State ---------- */
let state = {
  snippets: loadAll(),
  selectedId: null,
  focusedListIndex: 0,
  prefs: loadPrefs(),
  filter: '',
  tagFilter: null
};

/* ---------- DOM refs ---------- */
const listEl = document.getElementById('list');
const detailArea = document.getElementById('detailArea');
const noSelection = document.getElementById('noSelection');
const searchInput = document.getElementById('search');
const contrastToggle = document.getElementById('contrastToggle');
const fontInc = document.getElementById('fontInc');
const fontDec = document.getElementById('fontDec');
const newBtn = document.getElementById('newBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const overlay = document.getElementById('overlay');
const overlayClose = document.getElementById('overlayClose');
const helpBtn = document.getElementById('helpBtn');
const tagBar = document.getElementById('tagBar');
const storageStatus = document.getElementById('storageStatus');
const detailAnnounce = document.getElementById('detailAnnounce');
const assertive = document.getElementById('assertive');
const contrastBodyClass = 'high-contrast';

/* ---------- Accessibility helpers ---------- */
function announce(message){ detailAnnounce.textContent = message; }
function announceAssertive(message){ assertive.textContent = message; }
function focusTrapInto(container){ // simple: focus first focusable
  const f = container.querySelector('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])');
  if(f) f.focus();
}
function setFocusToDetail(){ detailArea.setAttribute('tabindex','-1'); detailArea.focus(); }

/* ---------- Rendering ---------- */
function saveAndRefresh(){
  if(!saveAll(state.snippets)) storageStatus.textContent = 'save-failed';
  else storageStatus.textContent = 'saved';
  renderList();
  renderTags();
}

function renderList(){
  // filter
  const q = state.filter && state.filter.toLowerCase();
  const tagFilter = state.tagFilter;
  const items = state.snippets.filter(s=>{
    if(tagFilter && !(s.tags||[]).includes(tagFilter)) return false;
    if(!q) return true;
    return (s.title||'').toLowerCase().includes(q) || (s.content||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q) || (s.tags||[]).join(' ').toLowerCase().includes(q);
  });
  listEl.innerHTML = '';
  if(items.length===0){
    const li = document.createElement('li'); li.className='item';
    li.innerHTML = '<div class="placeholder">No snippets found.</div>';
    listEl.appendChild(li);
    return;
  }
  items.forEach((s,i)=>{
    const li = document.createElement('li'); li.className='item';
    const btn = document.createElement('button');
    btn.className='item-btn';
    btn.type='button';
    btn.dataset.id = s.id;
    btn.setAttribute('aria-describedby','ts-'+s.id);
    btn.innerHTML = `<div class="item-title">${escapeHtml(s.title||'(untitled)')}</div>
      <div class="truncated">${escapeHtml((s.content||'').replace(/\n/g,' '))}</div>
      <div id="ts-${s.id}" class="item-meta">${new Date(s.created).toLocaleString()}</div>`;
    btn.addEventListener('click',()=>openSnippet(s.id));
    btn.addEventListener('keydown',listKeyHandler);
    li.appendChild(btn);
    listEl.appendChild(li);
  });
}

function renderTags(){
  tagBar.innerHTML = '';
  const allTags = new Set();
  state.snippets.forEach(s=>(s.tags||[]).forEach(t=>allTags.add(t)));
  if(allTags.size===0) return;
  allTags.forEach(t=>{
    const b = document.createElement('button');
    b.className='chip';
    b.textContent = t;
    b.setAttribute('aria-pressed', state.tagFilter===t ? 'true':'false');
    b.addEventListener('click',()=>{ state.tagFilter = state.tagFilter===t?null:t; renderList(); renderTags(); announce('Filter by tag '+(state.tagFilter||'none')); });
    tagBar.appendChild(b);
  });
}

function renderDetail(id){
  const s = state.snippets.find(x=>x.id===id);
  if(!s){
    noSelection.style.display='block';
    detailArea.setAttribute('aria-labelledby','detailTitle');
    detailArea.innerHTML = '<div class="placeholder">Snippet not found.</div>';
    return;
  }
  noSelection.style.display='none';
  detailArea.innerHTML = '';
  // container
  const h = document.createElement('h2'); h.id='detailTitle'; h.className='title'; h.textContent = s.title || '(untitled)';
  const meta = document.createElement('div'); meta.className='meta-row'; meta.textContent = `Created: ${new Date(s.created).toLocaleString()} · Tags: ${(s.tags||[]).join(', ') || '—'}`;
  const desc = document.createElement('div'); desc.className='sr-only'; desc.textContent = s.description || '';
  const preview = document.createElement('div'); preview.className='preview '+(s.font||state.prefs.font||'medium'); preview.id='previewPane'; preview.tabIndex=0;
  preview.textContent = s.content || '';
  if(state.prefs.contrast) preview.classList.add('high-contrast');
  const actions = document.createElement('div'); actions.className='actions';
  const copyBtn = document.createElement('button'); copyBtn.className='small'; copyBtn.textContent='Copy (C)'; copyBtn.addEventListener('click',()=>copyContent(s));
  const editBtn = document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit'; editBtn.addEventListener('click',()=>openEditor(s));
  const shareBtn = document.createElement('button'); shareBtn.className='small'; shareBtn.textContent='Share (S)'; shareBtn.addEventListener('click',()=>shareSnippet(s));
  const delBtn = document.createElement('button'); delBtn.className='small danger'; delBtn.textContent='Delete'; delBtn.addEventListener('click',()=>deleteSnippet(s.id));
  actions.append(copyBtn, editBtn, shareBtn, delBtn);
  detailArea.append(h, meta, desc, preview, actions);
  // live announce
  announce('Snippet opened: '+(s.title||'untitled'));
  setFocusToDetail();
}

/* ---------- Editor & Create ---------- */
function openEditor(snippet){
  const isNew = !snippet;
  const s = isNew ? {id:uid(),title:'',content:'',description:'',tags:[],created:nowISO(),font:state.prefs.font} : JSON.parse(JSON.stringify(snippet));
  detailArea.innerHTML = '';
  const form = document.createElement('form'); form.className='editor';
  form.setAttribute('aria-label', isNew ? 'Create snippet' : 'Edit snippet');
  // title
  const lTitle = document.createElement('label'); lTitle.textContent='Title'; lTitle.htmlFor='eTitle';
  const inTitle = document.createElement('input'); inTitle.id='eTitle'; inTitle.type='text'; inTitle.value=s.title; inTitle.required=true;
  // multiline toggle
  const multBtn = document.createElement('button'); multBtn.type='button'; multBtn.className='small'; multBtn.textContent = state.prefs.multiline ? 'Multi-line (on) (M)' : 'Single-line (M)';
  multBtn.addEventListener('click',()=>{ state.prefs.multiline=!state.prefs.multiline; multBtn.textContent = state.prefs.multiline ? 'Multi-line (on) (M)' : 'Single-line (M)'; savePrefs(state.prefs); renderPreview(); });
  // content
  const lContent = document.createElement('label'); lContent.textContent='Content'; lContent.htmlFor='eContent';
  const inContent = document.createElement(state.prefs.multiline ? 'textarea':'input'); inContent.id='eContent'; inContent.value=s.content; inContent.required=true;
  if(!state.prefs.multiline) inContent.type='text';
  // description
  const lDesc = document.createElement('label'); lDesc.textContent='Description (optional)'; lDesc.htmlFor='eDesc';
  const inDesc = document.createElement('textarea'); inDesc.id='eDesc'; inDesc.value = s.description || '';
  // tags
  const lTags = document.createElement('label'); lTags.textContent='Tags (comma separated)'; lTags.htmlFor='eTags';
  const inTags = document.createElement('input'); inTags.id='eTags'; inTags.type='text'; inTags.value = (s.tags||[]).join(', ');
  // preview + read aloud
  const previewLabel = document.createElement('label'); previewLabel.textContent='Live preview';
  const preview = document.createElement('div'); preview.id='editorPreview'; preview.className='preview '+(s.font||state.prefs.font||'medium'); preview.textContent = inContent.value || '';
  const readBtn = document.createElement('button'); readBtn.type='button'; readBtn.className='small'; readBtn.textContent='Read aloud';
  readBtn.addEventListener('click', ()=>{ speakText(preview.textContent); });
  // save/cancel
  const saveBtn = document.createElement('button'); saveBtn.type='submit'; saveBtn.className='small success'; saveBtn.textContent='Save (Ctrl/Cmd+S)';
  const cancelBtn = document.createElement('button'); cancelBtn.type='button'; cancelBtn.className='small'; cancelBtn.textContent='Cancel (Esc)'; cancelBtn.addEventListener('click', ()=>{ closeEditorRestoreFocus(snippet?snippet.id:null); });
  // handlers
  function renderPreview(){ preview.className='preview '+(s.font||state.prefs.font||'medium'); if(state.prefs.contrast) preview.classList.add('high-contrast'); preview.textContent = inContent.value || ''; }
  inContent.addEventListener('input', renderPreview);
  inTitle.addEventListener('keydown', editorKeyHandler);
  inContent.addEventListener('keydown', editorKeyHandler);
  inDesc.addEventListener('keydown', editorKeyHandler);
  form.append(lTitle,inTitle,multBtn,lContent,inContent,lDesc,inDesc,lTags,inTags,previewLabel,preview,readBtn, document.createElement('div'), saveBtn,cancelBtn);
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    if(!inTitle.value.trim() || !inContent.value.trim()){
      announceAssertive('Title and content cannot be empty.');
      return;
    }
    s.title = inTitle.value.trim();
    s.content = inContent.value;
    s.description = inDesc.value || '';
    s.tags = inTags.value.split(',').map(t=>t.trim()).filter(Boolean);
    s.font = state.prefs.font;
    if(isNew){
      s.created = nowISO();
      state.snippets.unshift(s);
      state.selectedId = s.id;
      saveAndRefresh();
      announce('Snippet saved');
      renderDetail(s.id);
    }else{
      const idx = state.snippets.findIndex(x=>x.id===s.id);
      if(idx>-1) state.snippets[idx]=s;
      saveAndRefresh();
      announce('Snippet updated');
      renderDetail(s.id);
    }
  });
  detailArea.append(form);
  // focus management
  inTitle.focus();
  // Ctrl/Cmd+S in editor handled globally by keydown
}

function closeEditorRestoreFocus(idToSelect){
  if(idToSelect){
    state.selectedId = idToSelect;
    renderDetail(idToSelect);
    // restore focus to list item
    const btn = listEl.querySelector(`button[data-id="${idToSelect}"]`);
    if(btn) btn.focus();
  }else{
    // after creating new, focus new button
    newBtn.focus();
    detailArea.innerHTML = '<div class="placeholder">No snippet selected. Press N to create one or select from the list.</div>';
  }
}

/* ---------- Copy & Share ---------- */
async function copyContent(s){
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(s.content || '');
    }else{
      // fallback
      const ta = document.createElement('textarea'); ta.value = s.content || ''; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
    }
    announce('Copied to clipboard');
  }catch(e){
    announceAssertive('Copy failed: '+ (e && e.message || 'unknown error'));
  }
}

function shareSnippet(s){
  const t = encodeURIComponent((s.title||'').slice(0,80));
  const h = `#share=${s.id}&t=${t}`;
  history.replaceState(null,'',h);
  announce('Share URL set in address bar');
}

/* ---------- CRUD ---------- */
function openSnippet(id){
  state.selectedId = id;
  renderDetail(id);
  // focus management: highlight the list button visually via focus
  const btn = listEl.querySelector(`button[data-id="${id}"]`);
  if(btn) btn.focus();
}

function deleteSnippet(id){
  const ok = confirm('Delete this snippet? This cannot be undone.');
  if(!ok) return;
  const idx = state.snippets.findIndex(s=>s.id===id);
  if(idx>-1) state.snippets.splice(idx,1);
  if(state.selectedId===id) { state.selectedId = null; detailArea.innerHTML = '<div class="placeholder">No snippet selected.</div>'; }
  saveAndRefresh();
  announce('Snippet deleted');
}

/* ---------- Export/Import ---------- */
function exportJSON(){
  const data = JSON.stringify(state.snippets, null, 2);
  // create downloadable blob
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'snippets.json'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); document.body.removeChild(a); },1000);
  announce('Export started');
}
function importJSONViaPrompt(){
  const text = prompt('Paste JSON of snippets to import (will merge).');
  if(!text) return;
  try{
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('Invalid format');
    // merge: keep unique ids; if id exists, skip
    const existing = new Set(state.snippets.map(s=>s.id));
    arr.forEach(s=>{
      if(!s.id) s.id = uid();
      if(existing.has(s.id)) return;
      state.snippets.push(s);
    });
    saveAndRefresh();
    announce('Import completed');
  }catch(e){
    announceAssertive('Import failed: invalid JSON');
  }
}

/* ---------- Keyboard handlers ---------- */
function globalKeyHandler(e){
  const active = document.activeElement;
  const inInput = active && (active.tagName==='INPUT' || active.tagName==='TEXTAREA' || active.isContentEditable);
  // help overlay toggle
  if(e.key==='?' || (e.key==='/' && (e.shiftKey||false) && e.target===document.body) ){
    // handled below for '/', avoid double
  }
  // Ignore when typing unless shortcut allowed
  if(!inInput){
    if(e.key==='n' || e.key==='N'){ e.preventDefault(); createNew(); return; }
    if(e.key==='h' || e.key==='H'){ toggleContrast(); return; }
    if(e.key==='m' || e.key==='M'){ toggleMultiline(); return; }
    if(e.key==='/'){ e.preventDefault(); searchInput.focus(); return; }
    if(e.key==='?' || e.key==='/' && e.shiftKey){ showOverlay(); return; }
    if(e.key==='+' || e.key==='='){ adjustFont('up'); return; }
    if(e.key==='-'){ adjustFont('down'); return; }
    if(e.key==='c' || e.key==='C'){ if(state.selectedId) { const s = state.snippets.find(x=>x.id===state.selectedId); if(s) copyContent(s); } return; }
    if(e.key==='s' || e.key==='S'){ if(state.selectedId){ const s = state.snippets.find(x=>x.id===state.selectedId); if(s) shareSnippet(s); } return; }
  } else {
    // inside input: allow Ctrl/Cmd+S and Esc special handling when editing
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
      // try to submit if in a form
      const form = active.closest('form');
      if(form){ e.preventDefault(); form.dispatchEvent(new Event('submit',{cancelable:true})); }
    }
  }
  // overlay close with Esc
  if(e.key==='Escape'){
    if(!overlay.hidden){ hideOverlay(); return; }
    // If editor open (form in detailArea), cancel it
    const form = detailArea.querySelector('form.editor');
    if(form){ // emulate cancel
      form.querySelector('button[type="button"]')?.click();
    }
  }
}

function listKeyHandler(e){
  const items = Array.from(listEl.querySelectorAll('button.item-btn'));
  if(items.length===0) return;
  const idx = items.indexOf(e.currentTarget);
  if(e.key==='ArrowDown'){ e.preventDefault(); const next = items[(idx+1)%items.length]; next.focus(); }
  if(e.key==='ArrowUp'){ e.preventDefault(); const prev = items[(idx-1+items.length)%items.length]; prev.focus(); }
  if(e.key==='Enter'){ e.preventDefault(); e.currentTarget.click(); }
  if(e.key==='Delete'){ e.preventDefault(); const id = e.currentTarget.dataset.id; const ok = confirm('Delete this snippet?'); if(ok) deleteSnippet(id); }
}

function editorKeyHandler(e){
  // prevent global shortcuts except allowed ones handled in globalKeyHandler via submit
  if(e.key==='Escape'){ e.preventDefault(); const cancel = detailArea.querySelector('button[type="button"]'); if(cancel) cancel.click(); }
}

/* ---------- Helpers ---------- */
function createNew(){ openEditor(null); }
function toggleContrast(){
  state.prefs.contrast = !state.prefs.contrast;
  savePrefs(state.prefs);
  document.querySelectorAll('.preview').forEach(p=>{ if(state.prefs.contrast) p.classList.add('high-contrast'); else p.classList.remove('high-contrast'); });
  contrastToggle.setAttribute('aria-pressed', state.prefs.contrast ? 'true':'false');
  announce('Contrast '+(state.prefs.contrast?'enabled':'disabled'));
}
function toggleMultiline(){
  state.prefs.multiline = !state.prefs.multiline;
  savePrefs(state.prefs);
  announce('Input mode '+(state.prefs.multiline?'multi-line':'single-line'));
}
function adjustFont(dir){
  const order = ['small','medium','large'];
  let idx = order.indexOf(state.prefs.font || 'medium');
  if(dir==='up') idx = Math.min(order.length-1, idx+1);
  else idx = Math.max(0, idx-1);
  state.prefs.font = order[idx];
  savePrefs(state.prefs);
  document.querySelectorAll('.preview').forEach(p=>{ p.classList.remove('small','medium','large'); p.classList.add(state.prefs.font); });
  announce('Font size '+state.prefs.font);
}

/* ---------- Speech ---------- */
function speakText(text){
  if(!('speechSynthesis' in window)){ announceAssertive('Speech not supported in this browser.'); return; }
  const ut = new SpeechSynthesisUtterance(text);
  speechSynthesis.cancel();
  speechSynthesis.speak(ut);
  announce('Reading aloud');
}

/* ---------- Escape helpers ---------- */
function showOverlay(){ overlay.hidden = false; overlay.setAttribute('aria-hidden','false'); overlay.querySelector('#overlayClose').focus(); }
function hideOverlay(){ overlay.hidden = true; overlay.setAttribute('aria-hidden','true'); helpBtn.focus(); }

/* ---------- Hash/share handling ---------- */
function handleHashOnLoad(){
  const h = location.hash.slice(1);
  if(!h) return;
  const m = h.match(/share=([^&]+)(?:&t=([^&]+))?/);
  if(!m) return;
  const id = decodeURIComponent(m[1]);
  const s = state.snippets.find(x=>x.id===id);
  if(s){
    state.selectedId = s.id;
    renderDetail(s.id);
    announce('Shared snippet opened');
  }else{
    announceAssertive('Shared snippet not found in local storage.');
    // show read-only view with the title if provided
    const title = m[2] ? decodeURIComponent(m[2]) : 'Shared snippet';
    detailArea.innerHTML = `<div class="placeholder">Shared snippet (${escapeHtml(title)}) not found locally. You may import JSON to restore it.</div>`;
  }
}

/* ---------- No-JS fallback message (if JS disabled this won't run) ---------- */
/* ---------- Events & init ---------- */
searchInput.addEventListener('input', (e)=>{ state.filter = e.target.value; renderList(); });
contrastToggle.addEventListener('click', toggleContrast);
fontInc.addEventListener('click', ()=>adjustFont('up'));
fontDec.addEventListener('click', ()=>adjustFont('down'));
newBtn.addEventListener('click', ()=>createNew());
exportBtn.addEventListener('click', ()=>exportJSON());
importBtn.addEventListener('click', ()=>importJSONViaPrompt());
overlayClose.addEventListener('click', hideOverlay);
helpBtn.addEventListener('click', showOverlay);

// Global keyboard
window.addEventListener('keydown', globalKeyHandler);

// Initialize UI
function init(){
  // Apply prefs
  document.querySelectorAll('.preview').forEach(p=>p.classList.add(state.prefs.font||'medium'));
  if(state.prefs.contrast) document.querySelectorAll('.preview').forEach(p=>p.classList.add('high-contrast'));
  contrastToggle.setAttribute('aria-pressed', state.prefs.contrast ? 'true':'false');

  renderList();
  renderTags();
  storageStatus.textContent = 'ready';
  handleHashOnLoad();
  // Focus management: ensure tab order natural
  // announce initial count
  const count = state.snippets.length;
  document.getElementById('count').textContent = `${count} snippets`;
}
init();

/* ---------- Small helpers ---------- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- Edge-case handling: localStorage checks ---------- */
try{
  const testKey = '__ach_test';
  localStorage.setItem(testKey,'1'); localStorage.removeItem(testKey);
}catch(e){
  announceAssertive('localStorage is unavailable; export your data often.');
}

/* ---------- No-JS fallback note (progressive enhancement):
   If JS is disabled, this file will render header and basic markup;
   for full app JS is required. We preserve an accessible message.
   (This comment is only in-source; no UI element needed.)
*/

/* ---------- Final: attach simple ARIA live clearers to avoid stale messages ---------- */
setInterval(()=>{ detailAnnounce.textContent=''; assertive.textContent=''; }, 12000);
</script>
</body>
</html>
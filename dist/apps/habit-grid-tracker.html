<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-12-29T04:49:07.866545Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Habit Grid Tracker</title>
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#555;
  --accent:#3b82f6; --gap:10px; --radius:10px;
}
[data-theme="dark"]{
  --bg:#0b0d10; --card:#0f1114; --text:#e6eef8; --muted:#a8b3c7; --accent:#7cc0ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
body{background:var(--bg);color:var(--text);padding:18px;display:flex;align-items:flex-start;justify-content:center;}
.app{width:100%;max-width:980px;}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;}
.title{display:flex;flex-direction:column;}
h1{font-size:1.2rem;margin:0}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--card);border:1px solid rgba(0,0,0,0.06);padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--text)}
.small{padding:6px 8px;font-size:0.9rem}
.icon{width:14px;height:14px;display:inline-block;margin-right:6px;vertical-align:-2px}
.grid-wrap{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
.grid-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.weekbar{display:flex;gap:8px;align-items:center}
.week-pill{font-size:0.85rem;padding:6px 8px;border-radius:999px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent);color:var(--muted)}
.header-stats{font-size:0.9rem;color:var(--muted)}
.container{display:grid;grid-template-columns:260px 1fr;gap:12px;align-items:start}
@media (max-width:820px){.container{grid-template-columns:1fr}}
.habit-list{padding:6px;display:flex;flex-direction:column;gap:8px}
.habit-card{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px}
.habit-meta{flex:1;min-width:0}
.habit-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
.habit-streak{font-size:0.8rem;color:var(--muted)}
.color-dot{width:18px;height:18px;border-radius:50%;flex:0 0 18px;border:2px solid rgba(0,0,0,0.06)}
.add-habit{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px}
.grid{display:grid;gap:6px;align-items:start}
.grid header{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px}
.header-day{font-size:0.78rem;color:var(--muted);text-align:center}
.habit-row{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;align-items:center;border-top:1px dashed rgba(0,0,0,0.04);padding-top:8px}
.cell{height:44px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;outline:none}
.cell[aria-checked="true"]{box-shadow:inset 0 0 0 2px rgba(255,255,255,0.06)}
.cell .dot{width:26px;height:26px;border-radius:50%;opacity:0;transform:scale(0.6);transition:all .18s}
.cell[aria-checked="true"] .dot{opacity:1;transform:scale(1)}
.cell:focus{box-shadow:0 0 0 3px rgba(59,130,246,0.18)}
.today{box-shadow:0 0 12px rgba(124, 195, 255, 0.35)}
.controls-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.footer{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px;color:var(--muted);font-size:0.9rem}
.modal-backdrop{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,0.35);z-index:60}
.modal{background:var(--card);padding:14px;border-radius:12px;width:min(520px,94%);box-shadow:0 8px 30px rgba(2,6,23,0.2)}
.modal.show{display:block}
.form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.form-row input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
.form-row input[type="color"]{width:48px;height:38px;border:0;background:transparent;cursor:pointer}
.hidden{display:none}
kbd{background:#eef2ff;border-radius:6px;padding:2px 6px;font-size:0.75rem}
.live{position:fixed;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
.print-hide{display:inline-block}
@media print{
  body{padding:0}
  .print-hide{display:none}
  .grid-wrap{box-shadow:none;border-radius:0;padding:6mm}
  .cell{height:20mm;border-radius:4px}
  .habit-name{font-weight:700}
  .header-day{font-weight:700}
  .modal-backdrop,.controls,.header,.footer{display:none}
  @page{size:A4}
  .grid{page-break-inside:avoid}
}
/* high contrast */
@media (prefers-contrast: more){
  :root{--accent:#ffd23f}
  .cell{outline:3px solid var(--accent)}
}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header" role="banner">
    <div class="title">
      <h1>Habit Grid Tracker</h1>
      <div class="header-stats" id="weeklyPercent">Weekly completion: 0%</div>
    </div>
    <div class="controls print-hide" aria-hidden="false">
      <button class="btn small" id="addBtn" title="Add habit (A)">+ Add Habit</button>
      <button class="btn small" id="bulkBtn" title="Bulk: yesterday+today">Bulk ✓</button>
      <button class="btn small" id="resetWeekBtn" title="Reset this week">Reset Week</button>
      <button class="btn small" id="exportBtn" title="Export JSON">Export</button>
      <button class="btn small" id="shareBtn" title="Copy share link">Share</button>
      <button class="btn small" id="themeBtn" title="Toggle theme">Theme</button>
    </div>
  </div>

  <div class="grid-wrap" role="region" aria-label="Habit grid">
    <div class="grid-head">
      <div class="weekbar">
        <div class="week-pill">Showing: Current week + past 3 weeks</div>
      </div>
      <div class="header-stats" id="streakLive">Streaks: —</div>
    </div>

    <div class="container">
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:600">Habits</div>
          <div style="font-size:0.85rem;color:var(--muted)"><span id="habitCount">0</span>/8</div>
        </div>
        <div class="habit-list" id="habitList" role="list"></div>
        <div class="add-habit print-hide">
          <button class="btn small" id="quickAdd">Quick Add</button>
        </div>
      </div>

      <div>
        <div class="grid" role="grid" aria-label="Habit days grid" id="grid">
          <header id="dayHeaders" aria-hidden="false"></header>
          <div id="rows"></div>
        </div>

        <div class="controls-row print-hide" style="margin-top:12px">
          <div style="display:flex;gap:6px">
            <button class="btn small" id="yesterdayToday">Check Yesterday+Today</button>
            <button class="btn small" id="clearModalBtn">Reset Week (Confirm)</button>
          </div>
          <div style="margin-left:auto;color:var(--muted)">Navigate: Arrows • Enter toggle • Esc close modals</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="muted">Up to 8 habits • Habit name max 500 chars</div>
      <div style="color:var(--muted)">Keyboard: Tab to focus cells</div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <form class="modal" id="habitForm" onsubmit="return false;" aria-labelledby="modalTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div id="modalTitle" style="font-weight:700">Add / Edit Habit</div>
      <button type="button" class="btn" id="closeModal">Close</button>
    </div>
    <div class="form-row">
      <input id="habitName" type="text" maxlength="500" placeholder="Habit name (max 500 chars)" aria-label="Habit name" required/>
      <input id="habitColor" type="color" title="Choose color" aria-label="Habit color"/>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="saveHabit" type="submit">Save</button>
      <button class="btn" id="deleteHabit" type="button">Delete</button>
    </div>
  </form>
</div>

<div class="live" aria-live="polite" id="liveRegion">Ready</div>

<script>
/*
  Habit Grid Tracker - Single file, <= ~1000 LOC
  Features implemented per spec: 7x4 grid, up to 8 habits, localStorage, URL hash share,
  keyboard navigation, modals, streaks, export, print-friendly, themes, ARIA.
*/

(function(){
const MAX_HABITS=8, WEEKS=4, DAYS=7;
const LS_KEY='habit-grid-v1';
const THEME_KEY='habit-grid-theme';
const app=document.getElementById('app');
const modal=document.getElementById('modal');
const form=document.getElementById('habitForm');
const habitNameInput=document.getElementById('habitName');
const habitColorInput=document.getElementById('habitColor');
const habitList=document.getElementById('habitList');
const rowsDiv=document.getElementById('rows');
const dayHeaders=document.getElementById('dayHeaders');
const addBtn=document.getElementById('addBtn');
const quickAdd=document.getElementById('quickAdd');
const closeModal=document.getElementById('closeModal');
const saveHabit=document.getElementById('saveHabit');
const deleteHabit=document.getElementById('deleteHabit');
const bulkBtn=document.getElementById('bulkBtn');
const resetWeekBtn=document.getElementById('resetWeekBtn');
const ytdyBtn=document.getElementById('yesterdayToday');
const exportBtn=document.getElementById('exportBtn');
const shareBtn=document.getElementById('shareBtn');
const themeBtn=document.getElementById('themeBtn');
const weeklyPercent=document.getElementById('weeklyPercent');
const habitCount=document.getElementById('habitCount');
const liveRegion=document.getElementById('liveRegion');
const streakLive=document.getElementById('streakLive');

let state={habits:[],cells:{},meta:{}}; // cells keyed habitId: [bool*28]
let editId=null;
let focused = {r:0,c:0}; // focus tracking for arrows
// compute base date: current week contains "today". Grid shows current week + past 3 weeks => 4 weeks total (28 days)
// We'll layout columns = 7 (days Mon..Sun), rows = habits, weeks in time axis are vertical slices by week: easiest: create ordered days array length 28, index 0 oldest day (3 weeks ago Monday) -> last index todaySunday? But spec: "7x4 grid (days x weeks) showing current week + past 3 weeks" meaning 7 columns (days) and 4 rows (weeks). However they asked grid layout days x weeks; they also request habit rows. To match UI we will show columns = 7 days and for each habit a row with 7*4=28 cells across 4 weeks. Implement header days repeated for 7 columns; each habit-row will contain 28 cells grouped visually as 4 groups of 7 but as grid we render 7 columns repeated? For simplicity we render each habit row as 28 cells (grid-template-columns: repeat(28, minmax(0,1fr))) but CSS earlier uses 7 columns; to keep responsiveness we instead display 7 columns per week stacked vertically: We'll render 7 columns and stack 4 week-rows (so each habit row is 4 rows of 7 columns).*/

// Utility
const uid = (n=6)=>Math.random().toString(36).slice(2,2+n);
const randColor=()=>{ const h=Math.floor(Math.random()*360); return `hsl(${h} 80% 55%)`;}
const today = new Date(); // don't print date per instruction

// initialize days matrix: we'll compute array weeks[weekIndex][dayIndex] -> Date
function buildDays(){
  // find start of current week (Mon) for "current week"
  const now = new Date();
  const day = (now.getDay()+6)%7; // 0=Mon..6=Sun
  const startOfCurrentWeek = new Date(now); startOfCurrentWeek.setHours(0,0,0,0);
  startOfCurrentWeek.setDate(now.getDate()-day);
  const weeks=[];
  for(let w=3;w>=0;w--){
    const wk=[];
    for(let d=0;d<7;d++){
      const dt=new Date(startOfCurrentWeek);
      dt.setDate(startOfCurrentWeek.getDate() - 7*(3-w) + d);
      wk.push(dt);
    }
    weeks.push(wk);
  }
  return weeks; // 4 arrays of 7
}
const WEEPS = buildDays();

// persist/load
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function loadState(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){ try{ state = JSON.parse(raw); }catch(e){ state={habits:[],cells:{},meta:{}} }}
  // if no habits seed defaults
  if(!state.habits || state.habits.length===0){
    const defaults=["Exercise","Read","Meditate","Sleep"];
    state.habits = defaults.slice(0,4).map((n,i)=>({id:uid(4),name:n,color:randColor()}));
    state.cells = {};
    state.habits.forEach(h=> state.cells[h.id]=Array(28).fill(false));
    saveState();
  }
}
loadState();

// theme
function applyTheme(t){
  if(t==='dark') document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.removeAttribute('data-theme');
  localStorage.setItem(THEME_KEY,t);
}
applyTheme(localStorage.getItem(THEME_KEY)||'light');

// Render day headers (7 days, we show day names Mon..Sun)
const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
function renderDayHeaders(){
  dayHeaders.innerHTML='';
  for(let w=0;w<4;w++){
    const weekLabel = document.createElement('div');
    weekLabel.style.display='contents';
    for(let d=0;d<7;d++){
      const th = document.createElement('div');
      th.className='header-day';
      th.textContent = dayNames[d] + (w===3 ? ' • Current' : '');
      th.setAttribute('aria-hidden','true');
      dayHeaders.appendChild(th);
    }
  }
}
renderDayHeaders();

// Render habits list and grid
function render(){
  habitList.innerHTML='';
  rowsDiv.innerHTML='';
  habitCount.textContent = state.habits.length;
  // habit list
  state.habits.forEach(h=>{
    const item = document.createElement('div');
    item.className='habit-card';
    item.setAttribute('role','listitem');
    const dot=document.createElement('div'); dot.className='color-dot'; dot.style.background=h.color;
    const meta=document.createElement('div'); meta.className='habit-meta';
    const name=document.createElement('div'); name.className='habit-name'; name.textContent=h.name;
    const streak = document.createElement('div'); streak.className='habit-streak'; streak.id='streak-'+h.id;
    meta.appendChild(name); meta.appendChild(streak);
    const editBtn=document.createElement('button'); editBtn.className='btn small'; editBtn.textContent='Edit';
    editBtn.onclick=()=>openModal(h.id);
    item.appendChild(dot); item.appendChild(meta); item.appendChild(editBtn);
    habitList.appendChild(item);
  });

  // grid rows per habit
  state.habits.forEach((h,ri)=>{
    const container=document.createElement('div');
    container.style.marginBottom='8px';
    // label
    const label=document.createElement('div');
    label.style.display='flex'; label.style.justifyContent='space-between'; label.style.alignItems='center';
    const name=document.createElement('div'); name.textContent=h.name; name.style.fontWeight='600';
    const streakSummary=document.createElement('div'); streakSummary.style.fontSize='0.9rem'; streakSummary.style.color='var(--muted)';
    streakSummary.id='summary-'+h.id;
    label.appendChild(name); label.appendChild(streakSummary);
    container.appendChild(label);
    // grid for 4 weeks x 7 days => 28 cells arranged as 4 rows of 7 columns
    const grid=document.createElement('div');
    grid.className='habit-row';
    grid.style.display='grid';
    grid.style.gridTemplateColumns=`repeat(7,1fr)`;
    grid.style.gridAutoRows='auto';
    grid.style.gap='6px';
    grid.setAttribute('role','row');
    // create 28 cells but visually group by week: we'll create 4 groups of 7 separated by a small margin
    for(let w=0;w<4;w++){
      const weekWrap=document.createElement('div');
      weekWrap.style.display='contents';
      for(let d=0;d<7;d++){
        const idx = w*7 + d;
        const cell=document.createElement('button');
        cell.className='cell';
        cell.setAttribute('role','gridcell');
        cell.setAttribute('tabindex','0');
        cell.setAttribute('data-habit',h.id);
        cell.setAttribute('data-idx',idx);
        cell.setAttribute('aria-checked', state.cells[h.id] && state.cells[h.id][idx] ? 'true' : 'false');
        cell.title = h.name + ' — ' + WEEPS[w][d].toDateString();
        // dot
        const dot=document.createElement('div'); dot.className='dot';
        dot.style.background = h.color;
        cell.appendChild(dot);
        // today highlight
        const isToday = sameDay(WEEPS[w][d], new Date());
        if(isToday) cell.classList.add('today');
        // events
        cell.addEventListener('click', (e)=> toggleCell(h.id, idx, cell) );
        cell.addEventListener('keydown', (e)=> cellKeyHandler(e, h.id, idx, cell));
        grid.appendChild(cell);
      }
      // small spacer between week groups visually: add a 6px transparent element except after last week
      if(w<3){
        const sep=document.createElement('div');
        sep.style.width='6px';
        sep.style.height='1px';
        sep.style.gridColumn=`span 0`;
      }
    }
    container.appendChild(grid);
    rowsDiv.appendChild(container);
  });
  updateStats();
}

// helpers
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();
}

function toggleCell(hid, idx, el){
  if(!state.cells[hid]) state.cells[hid]=Array(28).fill(false);
  state.cells[hid][idx] = !state.cells[hid][idx];
  el.setAttribute('aria-checked', state.cells[hid][idx] ? 'true' : 'false');
  saveState();
  updateStats();
  liveRegion.textContent = `${getHabitById(hid).name} ${state.cells[hid][idx] ? 'checked' : 'unchecked'}.`;
}

function cellKeyHandler(e, hid, idx, el){
  if(e.key==='Enter' || e.key===' '){
    e.preventDefault(); toggleCell(hid, idx, el);
    return;
  }
  if(e.key==='ArrowRight' || e.key==='ArrowLeft' || e.key==='ArrowUp' || e.key==='ArrowDown'){
    e.preventDefault();
    // navigate in flat 28 grid per habit: navigate by index across 28 cells
    const total = 28;
    let next = idx;
    if(e.key==='ArrowRight') next = Math.min(total-1, idx+1);
    if(e.key==='ArrowLeft') next = Math.max(0, idx-1);
    if(e.key==='ArrowUp') next = Math.max(0, idx-7);
    if(e.key==='ArrowDown') next = Math.min(total-1, idx+7);
    // find the cell element
    const sel = document.querySelector(`.cell[data-habit="${hid}"][data-idx="${next}"]`);
    if(sel){ sel.focus(); }
  }
}

// CRUD
function openModal(id){
  editId = id||null;
  modal.style.display='grid';
  modal.setAttribute('aria-hidden','false');
  if(editId){
    const h=getHabitById(editId);
    habitNameInput.value=h.name;
    habitColorInput.value = h.color;
    deleteHabit.style.display='inline-block';
  } else {
    habitNameInput.value='';
    habitColorInput.value=randColor();
    deleteHabit.style.display='none';
  }
  habitNameInput.focus();
}
function closeModalFn(){
  modal.style.display='none';
  modal.setAttribute('aria-hidden','true');
  editId=null;
}
addBtn.addEventListener('click', ()=> { if(state.habits.length<MAX_HABITS) openModal(); else alert('Max habits reached'); });
quickAdd.addEventListener('click', ()=> { if(state.habits.length<MAX_HABITS){ state.habits.push({id:uid(4),name:'New Habit',color:randColor()}); state.cells[ state.habits[state.habits.length-1].id ] = Array(28).fill(false); saveState(); render(); }});
closeModal.addEventListener('click', closeModalFn);
document.addEventListener('keydown', (e)=> {
  if(e.key==='Escape'){ if(modal.style.display==='grid') closeModalFn(); }
  if(e.key==='a' && (e.ctrlKey||e.metaKey)===false && document.activeElement.tagName!=='INPUT'){ /* alt: add */ }
});
saveHabit.addEventListener('click', ()=>{
  const name = habitNameInput.value.trim().slice(0,500);
  const color = habitColorInput.value || randColor();
  if(!name) return alert('Name required');
  if(editId){
    const h = getHabitById(editId);
    h.name = name; h.color = color;
  } else {
    if(state.habits.length>=MAX_HABITS) return alert('Max habits reached');
    const id=uid(4);
    state.habits.push({id,name,color});
    state.cells[id]=Array(28).fill(false);
  }
  saveState(); render(); closeModalFn();
});
deleteHabit.addEventListener('click', ()=>{
  if(!editId) return;
  if(!confirm('Delete habit?')) return;
  state.habits = state.habits.filter(h=>h.id!==editId);
  delete state.cells[editId];
  saveState(); render(); closeModalFn();
});

function getHabitById(id){ return state.habits.find(h=>h.id===id) || null; }

// Stats
function updateStats(){
  // weekly completion % = across all habits for current week (last 7 days) count checked / (habits*7)
  const totalCells = state.habits.length * 7;
  let checked=0;
  state.habits.forEach(h=>{
    const arr = state.cells[h.id] || Array(28).fill(false);
    for(let i=21;i<28;i++) if(arr[i]) checked++;
  });
  const pct = totalCells? Math.round( (checked/totalCells)*100 ):0;
  weeklyPercent.textContent = `Weekly completion: ${pct}%`;
  // streaks per habit (current and max)
  const streaks = state.habits.map(h=>{
    const arr = state.cells[h.id] || Array(28).fill(false);
    // current streak: count backwards from last index while true
    let curr=0; for(let i=27;i>=0;i--){ if(arr[i]) curr++; else break;}
    // max streak contiguous anywhere
    let max=0, cur=0;
    for(let i=0;i<28;i++){ if(arr[i]){ cur++; if(cur>max) max=cur } else cur=0; }
    // update UI
    const el = document.getElementById('streak-'+h.id);
    if(el) el.textContent = `Current: ${curr} • Max: ${max}`;
    const sum = document.getElementById('summary-'+h.id);
    if(sum) sum.textContent = `Curr:${curr} / Max:${max}`;
    return {name:h.name,curr,max};
  });
  const liveText = streaks.map(s=>`${s.name}: ${s.curr}/${s.max}`).join(' • ');
  streakLive.textContent = liveText || '—';
  liveRegion.textContent = `Streaks updated.`;
}

// Bulk & reset
bulkBtn.addEventListener('click', ()=> { bulkYesterdayToday(); });
ytdyBtn.addEventListener('click', ()=> { bulkYesterdayToday(); });
function bulkYesterdayToday(){
  // set yesterday and today checked for all habits where index exists
  // find indices of yesterday and today in our 28-day array
  const flatDates = [];
  for(let w=0;w<4;w++) for(let d=0;d<7;d++) flatDates.push(WEEPS[w][d]);
  const now = new Date();
  now.setHours(0,0,0,0);
  const yesterday = new Date(now); yesterday.setDate(now.getDate()-1);
  const idxToday = flatDates.findIndex(dt=>sameDay(dt,now));
  const idxYest = flatDates.findIndex(dt=>sameDay(dt,yesterday));
  state.habits.forEach(h=>{
    if(!state.cells[h.id]) state.cells[h.id]=Array(28).fill(false);
    if(idxYest>=0) state.cells[h.id][idxYest]=true;
    if(idxToday>=0) state.cells[h.id][idxToday]=true;
  });
  saveState(); render();
}

resetWeekBtn.addEventListener('click', ()=>{
  if(!confirm('Reset only current week (last 7 days)?')) return;
  // zero indices 21..27
  state.habits.forEach(h=>{
    if(!state.cells[h.id]) state.cells[h.id]=Array(28).fill(false);
    for(let i=21;i<28;i++) state.cells[h.id][i]=false;
  });
  saveState(); render();
});

// Export
exportBtn.addEventListener('click', ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='habit-data.txt'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
});

// Share via hash
shareBtn.addEventListener('click', ()=> {
  const payload = {habits:state.habits, cells:state.cells};
  const str = btoa(encodeURIComponent(JSON.stringify(payload)));
  const url = location.origin + location.pathname + '#' + str;
  navigator.clipboard?.writeText(url).then(()=> alert('Share link copied to clipboard'));
});

// On load: parse hash if present
function loadFromHash(){
  const h = location.hash.slice(1);
  if(!h) return;
  try{
    const json = decodeURIComponent(atob(h));
    const payload = JSON.parse(json);
    if(payload && payload.habits && payload.cells){
      // overwrite current
      state.habits = payload.habits.slice(0,MAX_HABITS);
      state.cells = payload.cells;
      saveState();
      render();
      alert('Loaded shared habits from URL');
    }
  }catch(e){}
}
loadFromHash();

// theme toggle
themeBtn.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : 'light';
  const next = cur==='dark' ? 'light' : 'dark';
  applyTheme(next);
});

// keyboard: open add modal with A
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase()==='a' && document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA'){
    e.preventDefault(); if(state.habits.length<MAX_HABITS) openModal(); else alert('Max habits reached');
  }
});

// accessibility: ensure modal Escape closes handled above

// initialize DOM and render
render();

// ensure cells have aria-checked attribute on load
document.querySelectorAll('.cell').forEach(c=>{
  c.setAttribute('aria-checked', c.getAttribute('aria-checked') || 'false');
});

// handle clicking outside modal to close
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModalFn(); });

// Provide copy-on-load hash to override localStorage if requested (done above)

})();
</script>
</body>
</html>
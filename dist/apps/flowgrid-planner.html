<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2026-01-08T01:41:59.480975Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="UTF-8">
<title>FlowGrid Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --bg: #f5f5f7;
  --bg-alt: #ffffff;
  --bg-elevated: #ffffff;
  --fg: #111111;
  --fg-muted: #555555;
  --border-subtle: #dddddd;
  --accent: #2563eb;
  --accent-soft: rgba(37,99,235,0.12);
  --danger: #dc2626;
  --shadow-soft: 0 2px 6px rgba(15,23,42,0.08);
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --priority-high: #dc2626;
  --priority-med: #f97316;
  --priority-low: #16a34a;
  --status-pending: #6b7280;
  --status-progress: #2563eb;
  --status-done: #059669;
  --focus-ring: 0 0 0 2px rgba(37,99,235,0.5);
  --grid-gap: 8px;
  --transition-fast: 150ms ease-out;
  --toolbar-h: 44px;
  --footer-h: 52px;
}

[data-theme="dark"] {
  --bg: #020617;
  --bg-alt: #020617;
  --bg-elevated: #020617;
  --fg: #e5e7eb;
  --fg-muted: #9ca3af;
  --border-subtle: #1f2937;
  --accent: #60a5fa;
  --accent-soft: rgba(96,165,250,0.16);
  --shadow-soft: 0 2px 10px rgba(0,0,0,0.5);
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top left, #e5e7eb, #f9fafb);
  color: var(--fg);
  -webkit-font-smoothing: antialiased;
}

[data-theme="dark"] body {
  background: radial-gradient(circle at top left, #0b1120, #020617);
}

.app-root {
  min-height: 100vh;
  display: flex;
  align-items: stretch;
  justify-content: center;
  padding: 12px;
}

.app-shell {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 1200px;
  max-height: 100vh;
  border-radius: var(--radius-lg);
  background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(249,250,251,0.96));
  box-shadow: var(--shadow-soft);
  overflow: hidden;
}

[data-theme="dark"] .app-shell {
  background: radial-gradient(circle at top left, #020617, #020617);
}

.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  border-bottom: 1px solid var(--border-subtle);
  min-height: var(--toolbar-h);
  background: linear-gradient(90deg, rgba(37,99,235,0.04), transparent);
}

[data-theme="dark"] .app-header {
  background: linear-gradient(90deg, rgba(37,99,235,0.12), transparent);
}

.app-title-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

.app-title {
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  font-size: 14px;
}

.app-badge {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid var(--border-subtle);
  color: var(--fg-muted);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.stats {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--fg-muted);
}

.stats span {
  white-space: nowrap;
}

.completion-bar-wrap {
  width: 90px;
  height: 6px;
  border-radius: 999px;
  background: rgba(148,163,184,0.25);
  overflow: hidden;
}

.completion-bar {
  height: 100%;
  width: 0%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #2563eb);
  transition: width 120ms ease-out;
}

.header-controls {
  display: flex;
  align-items: center;
  gap: 6px;
}

button,
input,
select,
textarea {
  font-family: inherit;
}

.btn {
  border-radius: 999px;
  border: 1px solid var(--border-subtle);
  background: rgba(255,255,255,0.8);
  color: var(--fg);
  padding: 5px 10px;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
}

[data-theme="dark"] .btn {
  background: rgba(15,23,42,0.9);
}

.btn-icon {
  width: 16px;
  height: 16px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
}

.btn-ghost {
  background: transparent;
}

.btn-accent {
  border-color: transparent;
  background: linear-gradient(135deg, #2563eb, #4f46e5);
  color: #ffffff;
}

.btn-toggle-active {
  border-color: var(--accent);
  background: var(--accent-soft);
}

.btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.btn:hover {
  transform: translateY(-0.5px);
  box-shadow: 0 0 0 1px rgba(148,163,184,0.4);
}

.btn-accent:hover {
  box-shadow: 0 8px 16px rgba(37,99,235,0.45);
}

.main {
  display: flex;
  flex: 1;
  min-height: 0;
  background: radial-gradient(circle at top left, rgba(37,99,235,0.06), transparent);
}

[data-theme="dark"] .main {
  background: radial-gradient(circle at top left, rgba(37,99,235,0.22), transparent);
}

.main-inner {
  display: grid;
  grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
  gap: 0;
  width: 100%;
}

/* Focus mode */
.focus-mode .main-inner {
  grid-template-columns: 0 minmax(0,1fr);
}

.side-panel {
  border-right: 1px solid var(--border-subtle);
  padding: 10px 10px 8px;
  overflow-y: auto;
  background: linear-gradient(180deg, rgba(248,250,252,0.9), rgba(248,250,252,0.96));
}

[data-theme="dark"] .side-panel {
  background: linear-gradient(180deg, rgba(15,23,42,0.9), rgba(15,23,42,0.96));
}

.section {
  margin-bottom: 10px;
}

.section-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--fg-muted);
  margin-bottom: 6px;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px;
}

label {
  font-size: 11px;
  color: var(--fg-muted);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 2px;
}

input[type="text"],
input[type="date"],
select,
textarea {
  width: 100%;
  border-radius: var(--radius-md);
  border: 1px solid var(--border-subtle);
  padding: 6px 8px;
  font-size: 12px;
  background: rgba(255,255,255,0.9);
  color: var(--fg);
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
}

[data-theme="dark"] input[type="text"],
[data-theme="dark"] input[type="date"],
[data-theme="dark"] select,
[data-theme="dark"] textarea {
  background: rgba(15,23,42,0.9);
}

input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: none;
  border-color: var(--accent);
  box-shadow: var(--focus-ring);
}

textarea {
  resize: vertical;
  min-height: 40px;
  max-height: 90px;
}

.inline-row {
  display: flex;
  gap: 6px;
}

.inline-row > * {
  flex: 1;
}

.error-text {
  font-size: 11px;
  color: var(--danger);
  margin-top: 2px;
}

.invalid-field {
  border-color: var(--danger) !important;
}

.hint {
  font-size: 11px;
  color: var(--fg-muted);
}

.filter-bar {
  display: grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap: 6px;
  margin-bottom: 8px;
}

.filter-row {
  display: flex;
  gap: 4px;
}

.filter-row > * {
  flex: 1;
}

.filter-small {
  font-size: 11px;
  padding: 4px 6px;
  border-radius: 999px;
  border: 1px solid var(--border-subtle);
  background: rgba(255,255,255,0.8);
  color: var(--fg-muted);
}

[data-theme="dark"] .filter-small {
  background: rgba(15,23,42,0.9);
}

.filter-toggle {
  white-space: nowrap;
}

.search-box-wrap {
  margin-bottom: 6px;
}

.search-input {
  width: 100%;
  padding-left: 22px;
  position: relative;
}

.search-wrap {
  position: relative;
}

.search-icon {
  position: absolute;
  left: 7px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
  color: var(--fg-muted);
}

.main-board {
  padding: 8px 8px 6px;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* Grid */
.grid-header-row {
  display: grid;
  grid-template-columns: 80px repeat(4, minmax(0,1fr));
  gap: var(--grid-gap);
  margin-bottom: 4px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--fg-muted);
}

.grid-header-cell {
  padding: 4px 6px;
  border-radius: var(--radius-md);
}

.grid-wrapper {
  position: relative;
  flex: 1;
  min-height: 0;
}

.grid-body {
  display: grid;
  grid-template-columns: 80px repeat(4, minmax(0,1fr));
  gap: var(--grid-gap);
  height: 100%;
}

.grid-priority-label {
  font-size: 11px;
  padding: 4px 6px;
  border-radius: var(--radius-md);
  align-self: stretch;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  color: var(--fg-muted);
}

.grid-cell {
  border-radius: var(--radius-md);
  background: rgba(248,250,252,0.9);
  border: 1px solid rgba(148,163,184,0.4);
  padding: 4px;
  display: flex;
  flex-direction: column;
  min-height: 70px;
  max-height: calc(100vh - 210px);
}

[data-theme="dark"] .grid-cell {
  background: rgba(15,23,42,0.95);
  border-color: rgba(51,65,85,0.9);
}

.grid-cell-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 10px;
  color: var(--fg-muted);
  margin-bottom: 4px;
}

.grid-cell-body {
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding-right: 2px;
}

.grid-cell-body::-webkit-scrollbar {
  width: 4px;
}

.grid-cell-body::-webkit-scrollbar-thumb {
  background: rgba(148,163,184,0.7);
  border-radius: 999px;
}

/* Task card */
.task-card {
  border-radius: var(--radius-md);
  background: #ffffff;
  padding: 4px 6px;
  border: 1px solid rgba(148,163,184,0.6);
  font-size: 12px;
  display: flex;
  flex-direction: column;
  gap: 2px;
  cursor: pointer;
  transition: box-shadow var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast), background var(--transition-fast), opacity 120ms ease-out;
}

[data-theme="dark"] .task-card {
  background: rgba(15,23,42,0.97);
  border-color: rgba(75,85,99,0.95);
}

.task-card-header {
  display: flex;
  align-items: center;
  gap: 4px;
}

.task-title {
  font-weight: 600;
  flex: 1;
  min-width: 0;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

.task-title.done {
  text-decoration: line-through;
  opacity: 0.7;
}

.priority-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  flex-shrink: 0;
}

.tag-pill {
  border-radius: 999px;
  background: rgba(148,163,184,0.15);
  color: var(--fg-muted);
  font-size: 10px;
  padding: 1px 6px;
  max-width: 80px;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

.status-pill {
  border-radius: 999px;
  font-size: 10px;
  padding: 1px 6px;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  background: rgba(148,163,184,0.15);
  color: var(--fg-muted);
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 999px;
}

.task-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 4px;
}

.task-desc-preview {
  font-size: 11px;
  color: var(--fg-muted);
  max-height: 28px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.status-cycle-btn {
  border-radius: 999px;
  border: none;
  background: transparent;
  padding: 2px 4px;
  font-size: 10px;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  color: var(--fg-muted);
}

.status-cycle-btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.task-card:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.task-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(15,23,42,0.25);
  border-color: var(--accent);
}

/* Done visual */
.task-card.done {
  opacity: 0.6;
  background: rgba(226,232,240,0.7);
}

[data-theme="dark"] .task-card.done {
  background: rgba(31,41,55,0.9);
}

/* Focus mode dimming */
.focus-mode .grid-cell {
  opacity: 0.18;
}

.focus-mode .grid-cell.focused-cell {
  opacity: 1;
  box-shadow: 0 0 0 1px rgba(129,140,248,0.9), 0 0 32px rgba(79,70,229,0.7);
  z-index: 1;
  position: relative;
}

/* Responsive narrow layout */
@media (max-width: 800px) {
  .app-shell {
    max-height: none;
  }
  .main-inner {
    grid-template-columns: minmax(0,1fr);
  }
  .side-panel {
    border-right: none;
    border-bottom: 1px solid var(--border-subtle);
  }
  .grid-header-row {
    display: none;
  }
  .grid-body {
    display: block;
  }
  .time-section {
    border-radius: var(--radius-md);
    margin-bottom: 8px;
    border: 1px solid var(--border-subtle);
    background: rgba(248,250,252,0.9);
    overflow: hidden;
  }
  [data-theme="dark"] .time-section {
    background: rgba(15,23,42,0.96);
    border-color: rgba(51,65,85,0.9);
  }
  .time-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 8px;
    cursor: pointer;
    font-size: 12px;
  }
  .time-section-body {
    padding: 6px;
    display: grid;
    grid-template-columns: 70px minmax(0,1fr);
    gap: 6px;
  }
  .time-section.collapsed .time-section-body {
    display: none;
  }
  .grid-priority-label {
    background: transparent;
    border: none;
  }
  .grid-cell {
    max-height: 220px;
  }
}

/* Footer */
.app-footer {
  border-top: 1px solid var(--border-subtle);
  min-height: var(--footer-h);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 6px 10px;
  background: linear-gradient(90deg, transparent, rgba(37,99,235,0.04));
  font-size: 11px;
  color: var(--fg-muted);
}

[data-theme="dark"] .app-footer {
  background: linear-gradient(90deg, transparent, rgba(37,99,235,0.2));
}

.footer-left,
.footer-right {
  display: flex;
  align-items: center;
  gap: 6px;
}

.footer-note {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Modals */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 12px;
  z-index: 40;
}

.modal-backdrop.active {
  display: flex;
}

.modal {
  max-width: 520px;
  width: 100%;
  max-height: 90vh;
  background: var(--bg-alt);
  border-radius: var(--radius-lg);
  box-shadow: 0 20px 45px rgba(15,23,42,0.45);
  padding: 12px 12px 10px;
  display: flex;
  flex-direction: column;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.modal-title {
  font-size: 14px;
  font-weight: 600;
}

.modal-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  padding-right: 2px;
  font-size: 13px;
}

.modal-body textarea {
  min-height: 140px;
  max-height: 260px;
}

.modal-footer {
  margin-top: 8px;
  display: flex;
  justify-content: flex-end;
  gap: 6px;
}

.modal-close-btn {
  border-radius: 999px;
  border: none;
  background: transparent;
  width: 24px;
  height: 24px;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--fg-muted);
}

.modal-close-btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.modal-message {
  margin-top: 6px;
  font-size: 12px;
}

/* Help content */
.help-list {
  padding-left: 16px;
  margin: 4px 0 8px;
  font-size: 13px;
}

.help-list li {
  margin-bottom: 2px;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 12px;
  right: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  background: rgba(15,23,42,0.95);
  color: #f9fafb;
  box-shadow: 0 10px 25px rgba(15,23,42,0.7);
  opacity: 0;
  transform: translateY(10px);
  pointer-events: none;
  transition: opacity 160ms ease-out, transform 160ms ease-out;
  z-index: 50;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  * {
    scroll-behavior: auto !important;
    animation: none !important;
    transition: none !important;
  }
}
</style>
</head>
<body>
<div class="app-root" id="appRoot">
  <div class="app-shell" role="application" aria-label="FlowGrid Planner">
    <header class="app-header">
      <div class="app-title-group">
        <div class="app-title">FlowGrid Planner</div>
        <div class="app-badge">Time Ã— Priority</div>
      </div>
      <div class="header-right">
        <div class="stats" aria-live="polite">
          <span id="statTotal">0 tasks</span>
          <span>Â·</span>
          <span id="statDone">0 done</span>
          <span>Â·</span>
          <span id="statPercent">0%</span>
          <div class="completion-bar-wrap" aria-hidden="true">
            <div class="completion-bar" id="completionBar"></div>
          </div>
        </div>
        <div class="header-controls">
          <button type="button" class="btn btn-ghost" id="focusModeToggle" aria-pressed="false">
            <span class="btn-icon">ðŸŽ¯</span>
            <span>Focus</span>
          </button>
          <button type="button" class="btn btn-ghost" id="themeToggle" aria-pressed="false" aria-label="Toggle theme">
            <span class="btn-icon" id="themeIcon">ðŸŒž</span>
          </button>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="main-inner" id="mainInner">
        <!-- Side panel -->
        <aside class="side-panel" aria-label="Task input and filters">
          <section class="section" aria-labelledby="taskFormTitle">
            <div class="section-title" id="taskFormTitle">New task</div>
            <form id="taskForm">
              <div class="form-grid">
                <div>
                  <label for="titleInput">Title *</label>
                  <input type="text" id="titleInput" autocomplete="off" required>
                  <div class="error-text" id="titleError" aria-live="polite"></div>
                </div>
                <div>
                  <label for="descInput">Description</label>
                  <textarea id="descInput"></textarea>
                </div>
                <div class="inline-row">
                  <div>
                    <label for="dateInput">Date</label>
                    <input type="date" id="dateInput">
                  </div>
                  <div>
                    <label for="timeBlockInput">Time block</label>
                    <select id="timeBlockInput">
                      <option value="Anytime">Anytime</option>
                      <option value="Morning">Morning</option>
                      <option value="Afternoon">Afternoon</option>
                      <option value="Evening">Evening</option>
                    </select>
                  </div>
                </div>
                <div class="inline-row">
                  <div>
                    <label for="priorityInput">Priority</label>
                    <select id="priorityInput">
                      <option value="High">High</option>
                      <option value="Medium" selected>Medium</option>
                      <option value="Low">Low</option>
                    </select>
                  </div>
                  <div>
                    <label for="tagInput">Tag</label>
                    <input type="text" id="tagInput" list="tagSuggestions" autocomplete="off">
                    <datalist id="tagSuggestions"></datalist>
                  </div>
                </div>
                <div class="inline-row">
                  <button type="submit" class="btn btn-accent" id="addTaskBtn">
                    <span class="btn-icon">ï¼‹</span>
                    <span>Add task</span>
                  </button>
                  <div class="hint">Ctrl/Cmd+Enter to add</div>
                </div>
              </div>
            </form>
          </section>

          <section class="section" aria-labelledby="filtersTitle">
            <div class="section-title" id="filtersTitle">Filters & search</div>
            <div class="search-box-wrap">
              <div class="search-wrap">
                <span class="search-icon">âŒ•</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Search title, notes, tagâ€¦">
              </div>
            </div>
            <div class="filter-bar">
              <div>
                <label for="filterDate">Date</label>
                <div class="filter-row">
                  <input type="date" id="filterDate">
                  <button type="button" class="btn filter-small" id="todayBtn">Today</button>
                </div>
              </div>
              <div>
                <label for="filterPriority">Priority</label>
                <select id="filterPriority">
                  <option value="All">All</option>
                  <option value="High">High</option>
                  <option value="Medium">Medium</option>
                  <option value="Low">Low</option>
                </select>
              </div>
              <div>
                <label for="filterStatus">Status</label>
                <select id="filterStatus">
                  <option value="All">All</option>
                  <option value="Pending">Pending</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Done">Done</option>
                  <option value="Active">Active (Pending + In Progress)</option>
                </select>
              </div>
              <div>
                <label for="filterTag">Tag</label>
                <input type="text" id="filterTag" placeholder="Any" autocomplete="off">
              </div>
            </div>
            <div class="filter-row">
              <button type="button" class="btn filter-small filter-toggle" id="hideDoneToggle" aria-pressed="false">
                <span>Hide done</span>
              </button>
            </div>
          </section>

          <section class="section">
            <div class="section-title">Hint</div>
            <div class="hint">
              Use the grid to plan your day by when and how important each task is. Arrow keys move between task cards.
            </div>
          </section>
        </aside>

        <!-- Main board -->
        <section class="main-board" aria-label="FlowGrid board">
          <div id="gridHeader" class="grid-header-container">
            <div class="grid-header-row" aria-hidden="true">
              <div class="grid-header-cell"></div>
              <div class="grid-header-cell">Anytime</div>
              <div class="grid-header-cell">Morning</div>
              <div class="grid-header-cell">Afternoon</div>
              <div class="grid-header-cell">Evening</div>
            </div>
          </div>
          <div class="grid-wrapper" id="gridWrapper">
            <!-- Grid or stacked sections inserted here -->
          </div>
        </section>
      </div>
    </main>

    <footer class="app-footer">
      <div class="footer-left">
        <button type="button" class="btn btn-ghost" id="exportBtn">
          <span class="btn-icon">â‡ª</span><span>Export JSON</span>
        </button>
        <button type="button" class="btn btn-ghost" id="importBtn">
          <span class="btn-icon">â‡©</span><span>Import JSON</span>
        </button>
        <button type="button" class="btn btn-ghost" id="copyLinkBtn">
          <span class="btn-icon">ðŸ”—</span><span>Copy view link</span>
        </button>
      </div>
      <div class="footer-right">
        <button type="button" class="btn btn-ghost" id="helpBtn">
          <span class="btn-icon">?</span><span>Help</span>
        </button>
        <button type="button" class="btn btn-ghost" id="clearBtn">
          <span class="btn-icon">ðŸ—‘</span><span>Clear data</span>
        </button>
        <div class="footer-note" aria-live="polite" id="footerNote">Local only Â· JSON export to share data</div>
      </div>
    </footer>
  </div>
</div>

<!-- Edit Task Modal -->
<div class="modal-backdrop" id="editModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <div class="modal-header">
      <div class="modal-title" id="editModalTitle">Edit task</div>
      <button type="button" class="modal-close-btn" data-close-modal="edit">
        âœ•
      </button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-grid">
          <div>
            <label for="editTitle">Title *</label>
            <input type="text" id="editTitle" required>
          </div>
          <div>
            <label for="editDesc">Description</label>
            <textarea id="editDesc"></textarea>
          </div>
          <div class="inline-row">
            <div>
              <label for="editDate">Date</label>
              <input type="date" id="editDate">
            </div>
            <div>
              <label for="editTimeBlock">Time block</label>
              <select id="editTimeBlock">
                <option value="Anytime">Anytime</option>
                <option value="Morning">Morning</option>
                <option value="Afternoon">Afternoon</option>
                <option value="Evening">Evening</option>
              </select>
            </div>
          </div>
          <div class="inline-row">
            <div>
              <label for="editPriority">Priority</label>
              <select id="editPriority">
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div>
              <label for="editStatus">Status</label>
              <select id="editStatus">
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Done">Done</option>
              </select>
            </div>
          </div>
          <div>
            <label for="editTag">Tag</label>
            <input type="text" id="editTag">
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-ghost" id="deleteTaskBtn">
        <span class="btn-icon">ðŸ—‘</span><span>Delete</span>
      </button>
      <button type="button" class="btn" data-close-modal="edit">Cancel</button>
      <button type="button" class="btn btn-accent" id="saveEditBtn">Save</button>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal-backdrop" id="exportModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle">
    <div class="modal-header">
      <div class="modal-title" id="exportModalTitle">Export JSON</div>
      <button type="button" class="modal-close-btn" data-close-modal="export">
        âœ•
      </button>
    </div>
    <div class="modal-body">
      <p class="hint">This includes your tasks and basic settings. Copy and store it somewhere safe.</p>
      <textarea id="exportTextarea" readonly></textarea>
      <div class="modal-message" id="exportMessage" aria-live="polite"></div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" data-close-modal="export">Close</button>
      <button type="button" class="btn btn-accent" id="copyExportBtn">Copy to clipboard</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div class="modal-backdrop" id="importModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="importModalTitle">
    <div class="modal-header">
      <div class="modal-title" id="importModalTitle">Import JSON</div>
      <button type="button" class="modal-close-btn" data-close-modal="import">
        âœ•
      </button>
    </div>
    <div class="modal-body">
      <p class="hint">Paste JSON exported from FlowGrid. Preview to validate before applying.</p>
      <textarea id="importTextarea"></textarea>
      <button type="button" class="btn btn-ghost" id="previewImportBtn">Preview import</button>
      <div class="modal-message" id="importPreview" aria-live="polite"></div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" data-close-modal="import">Cancel</button>
      <button type="button" class="btn btn-accent" id="applyImportBtn" disabled>Apply import</button>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div class="modal-backdrop" id="helpModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
    <div class="modal-header">
      <div class="modal-title" id="helpModalTitle">About FlowGrid Planner</div>
      <button type="button" class="modal-close-btn" data-close-modal="help">
        âœ•
      </button>
    </div>
    <div class="modal-body">
      <p><strong>FlowGrid Planner</strong> organizes tasks on a time Ã— priority grid so you can see what matters now.</p>
      <p><strong>Keyboard shortcuts</strong></p>
      <ul class="help-list">
        <li><strong>Ctrl/Cmd + Enter</strong>: Add task from the form</li>
        <li><strong>Tab / Shift+Tab</strong>: Move between controls and cards</li>
        <li><strong>Enter / Space</strong>: Activate focused buttons, toggle status</li>
        <li><strong>Arrow keys</strong>: Move between task cards in the grid</li>
        <li><strong>Esc</strong>: Close dialogs and overlays</li>
      </ul>
      <p><strong>Export / Import</strong></p>
      <ul class="help-list">
        <li><strong>Export JSON</strong>: Creates a JSON snapshot you can save or share.</li>
        <li><strong>Import JSON</strong>: Paste exported JSON, preview, then apply to replace current data.</li>
        <li>Only tasks and basic settings are stored; no data is sent to a server.</li>
      </ul>
      <p><strong>Share via link</strong></p>
      <ul class="help-list">
        <li><strong>Copy view link</strong> copies a URL that includes current filter settings (not your tasks).</li>
        <li>Anyone opening that link sees their own tasks but with the same view configuration.</li>
      </ul>
      <p><strong>Reset</strong></p>
      <p>
        <button type="button" class="btn btn-ghost" id="resetAppBtn">Reset all data</button>
        <span class="hint">Clears localStorage and reloads (confirmation required).</span>
      </p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" data-close-modal="help">Close</button>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(function() {
  const TIME_BLOCKS = ["Anytime", "Morning", "Afternoon", "Evening"];
  const PRIORITY_LEVELS = ["High", "Medium", "Low"];
  const STATUS_CYCLE = ["Pending", "In Progress", "Done"];
  const STORAGE_KEY = "flowgrid_planner_state_v1";

  let state = {
    tasks: [],
    filters: {
      date: todayISO(),
      priority: "All",
      status: "All",
      tag: "",
      hideDone: false
    },
    search: "",
    theme: "light",
    focusMode: false,
    focusCell: { timeBlock: currentTimeBlock(), priority: "High" }
  };

  let editTaskId = null;
  let importPreviewData = null;
  let focusedCardIndex = null;
  let cardOrder = [];

  const rootEl = document.documentElement;
  const gridWrapper = document.getElementById("gridWrapper");
  const gridHeaderContainer = document.getElementById("gridHeader");
  const statTotal = document.getElementById("statTotal");
  const statDone = document.getElementById("statDone");
  const statPercent = document.getElementById("statPercent");
  const completionBar = document.getElementById("completionBar");
  const tagSuggestions = document.getElementById("tagSuggestions");
  const footerNote = document.getElementById("footerNote");

  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function currentTimeBlock() {
    const h = new Date().getHours();
    if (h < 12) return "Morning";
    if (h < 17) return "Afternoon";
    return "Evening";
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        state.tasks = [createExampleTask()];
        state.filters.date = todayISO();
        return;
      }
      const stored = JSON.parse(raw);
      state = Object.assign({}, state, stored);
      state.filters = Object.assign({ date: todayISO(), priority: "All", status: "All", tag: "", hideDone: false }, state.filters || {});
      state.theme = state.theme || "light";
      state.search = state.search || "";
      state.focusMode = !!state.focusMode;
      state.focusCell = state.focusCell || { timeBlock: currentTimeBlock(), priority: "High" };
    } catch (e) {
      console.error("Failed to load state", e);
    }
  }

  function saveState() {
    try {
      const toSave = {
        tasks: state.tasks,
        filters: state.filters,
        theme: state.theme,
        focusMode: state.focusMode,
        focusCell: state.focusCell
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    } catch (e) {
      console.error("Failed to save state", e);
    }
  }

  function createExampleTask() {
    const now = Date.now();
    return {
      id: "example-" + now,
      title: "Add your first task",
      description: "Try organizing a real task with time block and priority.",
      date: todayISO(),
      timeBlock: currentTimeBlock(),
      priority: "High",
      status: "Pending",
      tag: "Example",
      createdAt: now
    };
  }

  function applyTheme() {
    rootEl.setAttribute("data-theme", state.theme === "dark" ? "dark" : "light");
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");
    if (state.theme === "dark") {
      themeToggle.setAttribute("aria-pressed", "true");
      themeIcon.textContent = "ðŸŒ™";
    } else {
      themeToggle.setAttribute("aria-pressed", "false");
      themeIcon.textContent = "ðŸŒž";
    }
  }

  function updateFilterControlsFromState() {
    document.getElementById("filterDate").value = state.filters.date || "";
    document.getElementById("filterPriority").value = state.filters.priority || "All";
    document.getElementById("filterStatus").value = state.filters.status || "All";
    document.getElementById("filterTag").value = state.filters.tag || "";
    document.getElementById("hideDoneToggle").setAttribute("aria-pressed", state.filters.hideDone ? "true" : "false");
    if (state.filters.hideDone) {
      document.getElementById("hideDoneToggle").classList.add("btn-toggle-active");
    } else {
      document.getElementById("hideDoneToggle").classList.remove("btn-toggle-active");
    }
    document.getElementById("searchInput").value = state.search || "";
  }

  function updateTaskFormDefaults() {
    document.getElementById("dateInput").value = state.filters.date || todayISO();
  }

  function encodeHash() {
    const f = state.filters;
    const params = [];
    if (f.date) params.push("d=" + encodeURIComponent(f.date));
    if (f.priority && f.priority !== "All") params.push("p=" + encodeURIComponent(f.priority.toLowerCase()));
    if (f.status && f.status !== "All") {
      const sMap = { "Pending": "pe", "In Progress": "ip", "Done": "do", "Active": "ac" };
      params.push("s=" + (sMap[f.status] || "pe"));
    }
    if (f.tag) params.push("t=" + encodeURIComponent(f.tag));
    if (f.hideDone) params.push("h=1");
    const hash = params.join("&");
    if (hash) {
      location.hash = hash;
    } else {
      history.replaceState(null, "", location.pathname + location.search);
    }
  }

  function decodeHash() {
    if (!location.hash) return;
    const trimmed = location.hash.replace(/^#/, "");
    if (!trimmed) return;
    const parts = trimmed.split("&");
    const f = Object.assign({}, state.filters);
    const revStatus = { pe: "Pending", ip: "In Progress", do: "Done", ac: "Active" };
    for (const part of parts) {
      const [k, v] = part.split("=");
      if (!k) continue;
      const val = decodeURIComponent(v || "");
      if (k === "d") f.date = val;
      else if (k === "p") {
        const mapP = { h: "High", m: "Medium", l: "Low" };
        f.priority = mapP[val] || "All";
      } else if (k === "s") {
        f.status = revStatus[val] || "All";
      } else if (k === "t") {
        f.tag = val;
      } else if (k === "h") {
        f.hideDone = val === "1";
      }
    }
    state.filters = f;
  }

  function toast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2200);
  }

  function priorityColor(priority) {
    if (priority === "High") return "var(--priority-high)";
    if (priority === "Medium") return "var(--priority-med)";
    return "var(--priority-low)";
  }

  function statusColor(status) {
    if (status === "Pending") return "var(--status-pending)";
    if (status === "In Progress") return "var(--status-progress)";
    return "var(--status-done)";
  }

  function filterTasksForView() {
    const { date, priority, status, tag, hideDone } = state.filters;
    const search = (state.search || "").trim().toLowerCase();
    return state.tasks.filter(task => {
      if (task.date !== date) return false;
      if (priority !== "All" && task.priority !== priority) return false;
      if (status === "Active") {
        if (!(task.status === "Pending" || task.status === "In Progress")) return false;
      } else if (status !== "All" && task.status !== status) {
        return false;
      }
      if (hideDone && task.status === "Done") return false;
      if (tag && (!task.tag || task.tag.toLowerCase() !== tag.toLowerCase())) return false;
      if (search) {
        const hay = (task.title || "") + " " + (task.description || "") + " " + (task.tag || "");
        if (!hay.toLowerCase().includes(search)) return false;
      }
      return true;
    });
  }

  function updateStats() {
    const tasks = state.tasks.filter(t => t.date === state.filters.date);
    const total = tasks.length;
    const done = tasks.filter(t => t.status === "Done").length;
    const pct = total ? Math.round(done * 100 / total) : 0;
    statTotal.textContent = total + (total === 1 ? " task" : " tasks");
    statDone.textContent = done + " done";
    statPercent.textContent = pct + "%";
    completionBar.style.width = pct + "%";
  }

  function updateTagSuggestions() {
    const tags = Array.from(new Set(state.tasks.map(t => t.tag).filter(Boolean)));
    tagSuggestions.innerHTML = "";
    tags.forEach(tag => {
      const opt = document.createElement("option");
      opt.value = tag;
      tagSuggestions.appendChild(opt);
    });
  }

  function renderGrid() {
    const tasks = filterTasksForView();
    const isNarrow = window.matchMedia("(max-width: 800px)").matches;
    cardOrder = [];
    focusedCardIndex = null;

    gridWrapper.innerHTML = "";
    gridHeaderContainer.style.display = isNarrow ? "none" : "block";

    const tasksByCell = {};
    for (const t of tasks) {
      const tb = TIME_BLOCKS.includes(t.timeBlock) ? t.timeBlock : "Anytime";
      const key = tb + "|" + t.priority;
      if (!tasksByCell[key]) tasksByCell[key] = [];
      tasksByCell[key].push(t);
    }
    for (const key in tasksByCell) {
      tasksByCell[key].sort((a, b) => a.createdAt - b.createdAt);
    }

    if (!isNarrow) {
      const grid = document.createElement("div");
      grid.className = "grid-body";
      for (const priority of PRIORITY_LEVELS) {
        const label = document.createElement("div");
        label.className = "grid-priority-label";
        label.textContent = priority;
        label.dataset.priorityLabel = priority;
        grid.appendChild(label);
        for (const tb of TIME_BLOCKS) {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          cell.setAttribute("data-time-block", tb);
          cell.setAttribute("data-priority", priority);
          const cellHeader = document.createElement("div");
          cellHeader.className = "grid-cell-header";
          const left = document.createElement("span");
          left.textContent = tb;
          const right = document.createElement("span");
          const arr = tasksByCell[`${tb}|${priority}`] || [];
          right.textContent = arr.length ? arr.length + "" : "";
          cellHeader.appendChild(left);
          cellHeader.appendChild(right);
          const body = document.createElement("div");
          body.className = "grid-cell-body";
          if (arr.length === 0) {
            const empty = document.createElement("div");
            empty.className = "hint";
            empty.textContent = "No tasks";
            empty.style.fontSize = "11px";
            empty.style.padding = "2px 0";
            body.appendChild(empty);
          } else {
            arr.forEach(task => {
              const card = buildTaskCard(task);
              body.appendChild(card);
            });
          }
          cell.appendChild(cellHeader);
          cell.appendChild(body);
          grid.appendChild(cell);
        }
      }
      gridWrapper.appendChild(grid);
      applyFocusCellHighlight();
    } else {
      TIME_BLOCKS.forEach(tb => {
        const section = document.createElement("div");
        section.className = "time-section";
        section.dataset.timeBlock = tb;
        section.classList.add("collapsed");
        const header = document.createElement("div");
        header.className = "time-section-header";
        header.tabIndex = 0;
        header.setAttribute("role", "button");
        header.setAttribute("aria-expanded", "false");
        const title = document.createElement("span");
        title.textContent = tb;
        const countSpan = document.createElement("span");
        const totalForTb = PRIORITY_LEVELS.reduce((acc, p) => {
          const arr = tasksByCell[`${tb}|${p}`] || [];
          return acc + arr.length;
        }, 0);
        countSpan.textContent = totalForTb ? totalForTb + " tasks" : "No tasks";
        header.appendChild(title);
        header.appendChild(countSpan);
        header.addEventListener("click", () => toggleSection(section, header));
        header.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            toggleSection(section, header);
          }
        });
        const body = document.createElement("div");
        body.className = "time-section-body";
        for (const priority of PRIORITY_LEVELS) {
          const label = document.createElement("div");
          label.className = "grid-priority-label";
          label.textContent = priority;
          body.appendChild(label);
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          cell.setAttribute("data-time-block", tb);
          cell.setAttribute("data-priority", priority);
          const cellBody = document.createElement("div");
          cellBody.className = "grid-cell-body";
          const arr = tasksByCell[`${tb}|${priority}`] || [];
          if (arr.length === 0) {
            const empty = document.createElement("div");
            empty.className = "hint";
            empty.textContent = "No tasks";
            empty.style.fontSize = "11px";
            empty.style.padding = "2px 0";
            cellBody.appendChild(empty);
          } else {
            arr.forEach(task => {
              const card = buildTaskCard(task);
              cellBody.appendChild(card);
            });
          }
          cell.appendChild(cellBody);
          body.appendChild(cell);
        }
        section.appendChild(header);
        section.appendChild(body);
        gridWrapper.appendChild(section);
      });
      const focusSection = gridWrapper.querySelector(`.time-section[data-time-block="${state.focusCell.timeBlock}"]`);
      if (focusSection) {
        const header = focusSection.querySelector(".time-section-header");
        focusSection.classList.remove("collapsed");
        header.setAttribute("aria-expanded", "true");
      }
      applyFocusCellHighlight();
    }
  }

  function toggleSection(section, header) {
    const collapsed = section.classList.toggle("collapsed");
    header.setAttribute("aria-expanded", collapsed ? "false" : "true");
  }

  function buildTaskCard(task) {
    const card = document.createElement("div");
    card.className = "task-card";
    if (task.status === "Done") card.classList.add("done");
    card.tabIndex = 0;
    card.dataset.taskId = task.id;
    cardOrder.push(task.id);

    const header = document.createElement("div");
    header.className = "task-card-header";
    const dot = document.createElement("span");
    dot.className = "priority-dot";
    dot.style.background = priorityColor(task.priority);
    const title = document.createElement("div");
    title.className = "task-title";
    title.textContent = task.title || "(Untitled)";
    if (task.status === "Done") title.classList.add("done");
    let tag = null;
    if (task.tag) {
      tag = document.createElement("span");
      tag.className = "tag-pill";
      tag.textContent = task.tag;
    }
    header.appendChild(dot);
    header.appendChild(title);
    if (tag) header.appendChild(tag);

    const meta = document.createElement("div");
    meta.className = "task-meta";
    const statusPill = document.createElement("span");
    statusPill.className = "status-pill";
    const sDot = document.createElement("span");
    sDot.className = "status-dot";
    sDot.style.background = statusColor(task.status);
    const sText = document.createElement("span");
    sText.textContent = task.status;
    statusPill.appendChild(sDot);
    statusPill.appendChild(sText);

    const statusBtn = document.createElement("button");
    statusBtn.type = "button";
    statusBtn.className = "status-cycle-btn";
    statusBtn.innerHTML = "âŸ³";
    statusBtn.title = "Advance status";

    statusBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      cycleStatus(task.id);
    });

    meta.appendChild(statusPill);
    meta.appendChild(statusBtn);

    const descPrev = document.createElement("div");
    descPrev.className = "task-desc-preview";
    if (task.description) {
      const firstLine = task.description.split(/\r?\n/);
      descPrev.textContent = firstLine;
    } else {
      descPrev.textContent = "";
    }

    card.appendChild(header);
    if (task.description) card.appendChild(descPrev);
    card.appendChild(meta);

    card.addEventListener("click", (e) => {
      if (e.target.closest("button")) return;
      openEditModal(task.id);
    });

    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openEditModal(task.id);
      } else if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(e.key)) {
        e.preventDefault();
        handleCardArrowNav(card, e.key);
      }
    });

    return card;
  }

  function applyFocusCellHighlight() {
    const mainInner = document.getElementById("mainInner");
    const toggle = document.getElementById("focusModeToggle");
    if (state.focusMode) {
      mainInner.classList.add("focus-mode");
      toggle.setAttribute("aria-pressed", "true");
      toggle.classList.add("btn-toggle-active");
    } else {
      mainInner.classList.remove("focus-mode");
      toggle.setAttribute("aria-pressed", "false");
      toggle.classList.remove("btn-toggle-active");
    }
    const cells = gridWrapper.querySelectorAll(".grid-cell");
    cells.forEach(c => c.classList.remove("focused-cell"));
    if (!state.focusMode) return;
    let bestCell = null;
    let selector = `.grid-cell[data-time-block="${state.focusCell.timeBlock}"][data-priority="High"]`;
    bestCell = gridWrapper.querySelector(selector);
    if (!bestCell) {
      selector = `.grid-cell[data-time-block="${state.focusCell.timeBlock}"][data-priority="Medium"]`;
      bestCell = gridWrapper.querySelector(selector);
    }
    if (!bestCell) {
      selector = `.grid-cell[data-time-block="${state.focusCell.timeBlock}"][data-priority="Low"]`;
      bestCell = gridWrapper.querySelector(selector);
    }
    if (!bestCell) {
      bestCell = gridWrapper.querySelector(".grid-cell");
    }
    if (bestCell) {
      bestCell.classList.add("focused-cell");
    }
  }

  function cycleFocusCell(direction) {
    const idx = TIME_BLOCKS.indexOf(state.focusCell.timeBlock);
    if (idx === -1) {
      state.focusCell.timeBlock = currentTimeBlock();
    } else {
      let nextIdx = direction === "next" ? idx + 1 : idx - 1;
      if (nextIdx < 0) nextIdx = TIME_BLOCKS.length - 1;
      if (nextIdx >= TIME_BLOCKS.length) nextIdx = 0;
      state.focusCell.timeBlock = TIME_BLOCKS[nextIdx];
    }
    saveState();
    applyFocusCellHighlight();
  }

  function handleCardArrowNav(cardEl, key) {
    const allCards = Array.from(gridWrapper.querySelectorAll(".task-card"));
    if (!allCards.length) return;
    const index = allCards.indexOf(cardEl);
    if (index === -1) return;
    const cell = cardEl.closest(".grid-cell");
    const tb = cell.getAttribute("data-time-block");
    const pr = cell.getAttribute("data-priority");

    let destCard = null;

    if (key === "ArrowUp" || key === "ArrowDown") {
      const siblingCards = Array.from(cell.querySelectorAll(".task-card"));
      const localIndex = siblingCards.indexOf(cardEl);
      if (key === "ArrowUp" && localIndex > 0) {
        destCard = siblingCards[localIndex - 1];
      } else if (key === "ArrowDown" && localIndex < siblingCards.length - 1) {
        destCard = siblingCards[localIndex + 1];
      }
    }

    if ((key === "ArrowLeft" || key === "ArrowRight") && !destCard) {
      const prIdx = PRIORITY_LEVELS.indexOf(pr);
      const tbIdx = TIME_BLOCKS.indexOf(tb);
      let targetCell = null;
      if (key === "ArrowLeft") {
        let newTbIdx = tbIdx - 1;
        if (newTbIdx < 0) newTbIdx = TIME_BLOCKS.length - 1;
        targetCell = gridWrapper.querySelector(`.grid-cell[data-time-block="${TIME_BLOCKS[newTbIdx]}"][data-priority="${pr}"]`);
      } else if (key === "ArrowRight") {
        let newTbIdx = tbIdx + 1;
        if (newTbIdx >= TIME_BLOCKS.length) newTbIdx = 0;
        targetCell = gridWrapper.querySelector(`.grid-cell[data-time-block="${TIME_BLOCKS[newTbIdx]}"][data-priority="${pr}"]`);
      }
      if (targetCell) {
        const targetCards = targetCell.querySelectorAll(".task-card");
        if (targetCards.length) {
          destCard = targetCards;
        }
      }
    }

    if (!destCard && (key === "ArrowUp" || key === "ArrowDown")) {
      const prIdx = PRIORITY_LEVELS.indexOf(pr);
      let targetPrIdx = prIdx;
      if (key === "ArrowUp") {
        targetPrIdx = prIdx - 1;
        if (targetPrIdx < 0) targetPrIdx = PRIORITY_LEVELS.length - 1;
      } else {
        targetPrIdx = prIdx + 1;
        if (targetPrIdx >= PRIORITY_LEVELS.length) targetPrIdx = 0;
      }
      const targetCell = gridWrapper.querySelector(`.grid-cell[data-time-block="${tb}"][data-priority="${PRIORITY_LEVELS[targetPrIdx]}"]`);
      if (targetCell) {
        const targetCards = targetCell.querySelectorAll(".task-card");
        if (targetCards.length) destCard = targetCards;
      }
    }

    if (destCard) {
      destCard.focus();
    }
  }

  function cycleStatus(taskId) {
    const idx = state.tasks.findIndex(t => t.id === taskId);
    if (idx === -1) return;
    const cur = state.tasks[idx].status || "Pending";
    const pos = STATUS_CYCLE.indexOf(cur);
    const next = STATUS_CYCLE[(pos + 1) % STATUS_CYCLE.length];
    state.tasks[idx].status = next;
    saveState();
    renderAll();
  }

  function openEditModal(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) return;
    editTaskId = taskId;
    document.getElementById("editTitle").value = task.title || "";
    document.getElementById("editDesc").value = task.description || "";
    document.getElementById("editDate").value = task.date || todayISO();
    document.getElementById("editTimeBlock").value = task.timeBlock || "Anytime";
    document.getElementById("editPriority").value = task.priority || "Medium";
    document.getElementById("editStatus").value = task.status || "Pending";
    document.getElementById("editTag").value = task.tag || "";
    openModal("edit");
  }

  function saveEdit() {
    if (!editTaskId) return;
    const idx = state.tasks.findIndex(t => t.id === editTaskId);
    if (idx === -1) return;
    const title = document.getElementById("editTitle").value.trim();
    if (!title) {
      toast("Title is required");
      return;
    }
    const task = state.tasks[idx];
    task.title = title;
    task.description = document.getElementById("editDesc").value;
    task.date = document.getElementById("editDate").value || todayISO();
    task.timeBlock = document.getElementById("editTimeBlock").value || "Anytime";
    task.priority = document.getElementById("editPriority").value || "Medium";
    task.status = document.getElementById("editStatus").value || "Pending";
    task.tag = document.getElementById("editTag").value.trim();
    saveState();
    closeModal("edit");
    renderAll();
  }

  function deleteCurrentTask() {
    if (!editTaskId) return;
    const task = state.tasks.find(t => t.id === editTaskId);
    if (!task) return;
    if (!confirm(`Delete task "${task.title}"?`)) return;
    state.tasks = state.tasks.filter(t => t.id !== editTaskId);
    saveState();
    closeModal("edit");
    renderAll();
  }

  function openModal(name) {
    const backdrop = document.getElementById(name + "ModalBackdrop");
    if (!backdrop) return;
    backdrop.classList.add("active");
    backdrop.setAttribute("aria-hidden", "false");
    const firstInput = backdrop.querySelector("input, textarea, button");
    if (firstInput) firstInput.focus();
  }

  function closeModal(name) {
    const backdrop = document.getElementById(name + "ModalBackdrop");
    if (!backdrop) return;
    backdrop.classList.remove("active");
    backdrop.setAttribute("aria-hidden", "true");
    editTaskId = null;
    if (name === "import") {
      importPreviewData = null;
      document.getElementById("importTextarea").value = "";
      document.getElementById("importPreview").textContent = "";
      document.getElementById("applyImportBtn").disabled = true;
    }
  }

  function handleGlobalEsc(e) {
    if (e.key === "Escape") {
      if (document.getElementById("editModalBackdrop").classList.contains("active")) closeModal("edit");
      else if (document.getElementById("exportModalBackdrop").classList.contains("active")) closeModal("export");
      else if (document.getElementById("importModalBackdrop").classList.contains("active")) closeModal("import");
      else if (document.getElementById("helpModalBackdrop").classList.contains("active")) closeModal("help");
    }
  }

  function exportJSON() {
    const data = {
      tasks: state.tasks,
      settings: {
        theme: state.theme
      }
    };
    const str = JSON.stringify(data, null, 2);
    document.getElementById("exportTextarea").value = str;
    document.getElementById("exportMessage").textContent = "";
    openModal("export");
  }

  async function copyExportToClipboard() {
    const text = document.getElementById("exportTextarea").value;
    if (!text) return;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        document.getElementById("exportMessage").textContent = "Copied to clipboard.";
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        document.getElementById("exportMessage").textContent = "Copied to clipboard.";
      }
    } catch (e) {
      document.getElementById("exportMessage").textContent = "Copy failed. Select and copy manually.";
    }
  }

  function previewImport() {
    const text = document.getElementById("importTextarea").value.trim();
    const previewEl = document.getElementById("importPreview");
    const applyBtn = document.getElementById("applyImportBtn");
    importPreviewData = null;
    applyBtn.disabled = true;
    if (!text) {
      previewEl.textContent = "Paste JSON first.";
      return;
    }
    try {
      const data = JSON.parse(text);
      if (!data.tasks || !Array.isArray(data.tasks)) {
        previewEl.textContent = "Invalid format: expected an object with a tasks array.";
        return;
      }
      const tasks = data.tasks;
      if (!tasks.length) {
        previewEl.textContent = "Valid JSON with 0 tasks.";
        importPreviewData = { tasks: [], settings: data.settings || {} };
        applyBtn.disabled = false;
        return;
      }
      const dates = tasks.map(t => t.date).filter(Boolean).sort();
      const earliest = dates;
      const latest = dates[dates.length - 1];
      previewEl.textContent = `OK: ${tasks.length} tasks. Dates from ${earliest} to ${latest}.`;
      importPreviewData = { tasks, settings: data.settings || {} };
      applyBtn.disabled = false;
    } catch (e) {
      previewEl.textContent = "Invalid JSON: " + e.message;
    }
  }

  function applyImport() {
    if (!importPreviewData) return;
    if (!confirm("Replace current tasks and settings with imported data?")) return;
    state.tasks = importPreviewData.tasks.map(t => ({
      id: t.id || ("t-" + Math.random().toString(36).slice(2)),
      title: t.title || "",
      description: t.description || "",
      date: t.date || todayISO(),
      timeBlock: t.timeBlock || "Anytime",
      priority: t.priority || "Medium",
      status: t.status || "Pending",
      tag: t.tag || "",
      createdAt: t.createdAt || Date.now()
    }));
    if (importPreviewData.settings && importPreviewData.settings.theme) {
      state.theme = importPreviewData.settings.theme === "dark" ? "dark" : "light";
    }
    saveState();
    applyTheme();
    closeModal("import");
    renderAll();
    toast("Import applied.");
  }

  function copyViewLink() {
    encodeHash();
    const url = location.href;
    (async () => {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
          toast("View link copied.");
        } else {
          const ta = document.createElement("textarea");
          ta.value = url;
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          toast("View link copied.");
        }
      } catch (e) {
        toast("Copy failed. Copy from address bar.");
      }
    })();
  }

  function resetApp() {
    if (!confirm("Reset FlowGrid? This clears all tasks and settings.")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  function clearData() {
    if (!confirm("Clear all tasks? Filters and theme will be kept.")) return;
    state.tasks = [];
    saveState();
    renderAll();
  }

  function handleAddTask(e) {
    e.preventDefault();
    const titleInput = document.getElementById("titleInput");
    const title = titleInput.value.trim();
    const titleError = document.getElementById("titleError");
    titleError.textContent = "";
    titleInput.classList.remove("invalid-field");
    if (!title) {
      titleError.textContent = "Title is required.";
      titleInput.classList.add("invalid-field");
      titleInput.focus();
      return;
    }
    const desc = document.getElementById("descInput").value;
    const date = document.getElementById("dateInput").value || todayISO();
    const timeBlock = document.getElementById("timeBlockInput").value || "Anytime";
    const priority = document.getElementById("priorityInput").value || "Medium";
    const tag = document.getElementById("tagInput").value.trim();
    const now = Date.now();
    const task = {
      id: "t-" + now.toString(36) + "-" + Math.random().toString(36).slice(2, 6),
      title,
      description: desc,
      date,
      timeBlock,
      priority,
      status: "Pending",
      tag,
      createdAt: now
    };
    state.tasks.push(task);
    saveState();
    titleInput.value = "";
    document.getElementById("descInput").value = "";
    document.getElementById("tagInput").value = "";
    titleInput.focus();
    updateTagSuggestions();
    renderAll();
  }

  function handleFiltersChange() {
    state.filters.date = document.getElementById("filterDate").value || todayISO();
    state.filters.priority = document.getElementById("filterPriority").value || "All";
    state.filters.status = document.getElementById("filterStatus").value || "All";
    state.filters.tag = document.getElementById("filterTag").value.trim();
    encodeHash();
    saveState();
    renderAll();
  }

  function handleSearchChange() {
    state.search = document.getElementById("searchInput").value;
    saveState();
    renderAll();
  }

  function handleHideDoneToggle() {
    state.filters.hideDone = !state.filters.hideDone;
    saveState();
    updateFilterControlsFromState();
    encodeHash();
    renderAll();
  }

  function handleTodayBtn() {
    state.filters.date = todayISO();
    document.getElementById("filterDate").value = state.filters.date;
    document.getElementById("dateInput").value = state.filters.date;
    encodeHash();
    saveState();
    renderAll();
  }

  function handleThemeToggle() {
    state.theme = state.theme === "dark" ? "light" : "dark";
    saveState();
    applyTheme();
  }

  function handleFocusToggle() {
    state.focusMode = !state.focusMode;
    saveState();
    applyFocusCellHighlight();
  }

  function handleKeyDownOnForm(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
      const form = document.getElementById("taskForm");
      if (document.activeElement && form.contains(document.activeElement)) {
        e.preventDefault();
        form.requestSubmit();
      }
    }
  }

  function renderAll() {
    updateFilterControlsFromState();
    updateTaskFormDefaults();
    updateStats();
    updateTagSuggestions();
    renderGrid();
  }

  function init() {
    decodeHash();
    loadState();
    applyTheme();
    updateFilterControlsFromState();
    updateTaskFormDefaults();
    renderAll();

    document.getElementById("taskForm").addEventListener("submit", handleAddTask);
    document.addEventListener("keydown", handleKeyDownOnForm);

    document.getElementById("filterDate").addEventListener("change", handleFiltersChange);
    document.getElementById("filterPriority").addEventListener("change", handleFiltersChange);
    document.getElementById("filterStatus").addEventListener("change", handleFiltersChange);
    document.getElementById("filterTag").addEventListener("input", handleFiltersChange);
    document.getElementById("hideDoneToggle").addEventListener("click", handleHideDoneToggle);
    document.getElementById("todayBtn").addEventListener("click", handleTodayBtn);

    document.getElementById("searchInput").addEventListener("input", handleSearchChange);

    document.getElementById("themeToggle").addEventListener("click", handleThemeToggle);
    document.getElementById("focusModeToggle").addEventListener("click", handleFocusToggle);

    document.getElementById("exportBtn").addEventListener("click", exportJSON);
    document.getElementById("copyExportBtn").addEventListener("click", copyExportToClipboard);
    document.getElementById("importBtn").addEventListener("click", () => openModal("import"));
    document.getElementById("previewImportBtn").addEventListener("click", previewImport);
    document.getElementById("applyImportBtn").addEventListener("click", applyImport);
    document.getElementById("copyLinkBtn").addEventListener("click", copyViewLink);
    document.getElementById("helpBtn").addEventListener("click", () => openModal("help"));
    document.getElementById("resetAppBtn").addEventListener("click", resetApp);
    document.getElementById("clearBtn").addEventListener("click", clearData);

    document.getElementById("deleteTaskBtn").addEventListener("click", deleteCurrentTask);
    document.getElementById("saveEditBtn").addEventListener("click", saveEdit);

    document.querySelectorAll("[data-close-modal]").forEach(btn => {
      btn.addEventListener("click", () => {
        const name = btn.getAttribute("data-close-modal");
        closeModal(name);
      });
    });

    document.getElementById("editModalBackdrop").addEventListener("click", (e) => {
      if (e.target === e.currentTarget) closeModal("edit");
    });
    document.getElementById("exportModalBackdrop").addEventListener("click", (e) => {
      if (e.target === e.currentTarget) closeModal("export");
    });
    document.getElementById("importModalBackdrop").addEventListener("click", (e) => {
      if (e.target === e.currentTarget) closeModal("import");
    });
    document.getElementById("helpModalBackdrop").addEventListener("click", (e) => {
      if (e.target === e.currentTarget) closeModal("help");
    });

    document.addEventListener("keydown", handleGlobalEsc);

    window.addEventListener("resize", () => {
      renderGrid();
    });

    document.addEventListener("keydown", (e) => {
      if (!state.focusMode) return;
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT")) return;
      if (e.key === "ArrowLeft") {
        cycleFocusCell("prev");
      } else if (e.key === "ArrowRight") {
        cycleFocusCell("next");
      }
    });

    footerNote.textContent = "Tasks stay in this browser Â· Use JSON to move them elsewhere";
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
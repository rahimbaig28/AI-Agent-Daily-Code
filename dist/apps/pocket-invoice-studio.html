<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-12-19T12:40:04.214336Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pocket Invoice Studio</title>
<style>
:root{--bg:#f8f9fa;--fg:#212529;--accent:#007bff;--success:#28a745;--warn:#ffc107;--error:#dc3545;--border:#dee2e6;--shadow:0 2px 4px rgba(0,0,0,.1);--focus:#007bff;--radius:6px;--pad:12px;--gap:8px;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:system-ui,-apple-system,sans-serif;font-size:14px;line-height:1.5;color:var(--fg);background:var(--bg);}
#app{display:flex;flex-direction:column;height:100vh;}
header{background:#fff;border-bottom:1px solid var(--border);padding:var(--pad);display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center;font-weight:600;}
header button{padding:6px 12px;border:1px solid var(--border);background:#fff;border-radius:var(--radius);cursor:pointer;font-size:14px;}
header button:focus{outline:2px solid var(--focus);outline-offset:2px;}
header button:hover{background:#f8f9fa;}
header button.active{background:var(--accent);color:#fff;border-color:var(--accent);}
#status{display:flex;gap:4px;align-items:center;font-size:12px;margin-left:auto;}
#status.online{color:var(--success);}#status.offline{color:var(--warn);}
main{display:flex;flex:1;overflow:hidden;}
.sidebar{width:280px;border-right:1px solid var(--border);overflow:auto;padding:var(--pad);background:#fff;}
.content{flex:1;padding:var(--pad);overflow:auto;display:flex;flex-direction:column;}
h2{margin:0 0 var(--pad) 0;font-size:16px;}
.client-list{max-height:200px;overflow:auto;}
.client-item{padding:8px;background:#f8f9fa;margin-bottom:4px;border-radius:var(--radius);cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.client-item:hover{background:#e9ecef;}
.client-item:focus{outline:2px solid var(--focus);outline-offset:2px;}
#add-client{padding:8px;border:1px solid var(--border);border-radius:var(--radius);background:#fff;width:100%;cursor:pointer;}
.invoice-header{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-bottom:var(--pad);}
.invoice-header input{padding:8px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;}
select{padding:8px;border:1px solid var(--border);border-radius:var(--radius);}
#lines{border-collapse:collapse;width:100%;margin-bottom:var(--pad);}
#lines th,#lines td{padding:8px;border-bottom:1px solid var(--border);text-align:left;}
#lines th{background:#f8f9fa;font-weight:600;}
.line-row{cursor:move;display:flex;align-items:center;gap:8px;}
.grabber{width:12px;height:12px;background:#007bff;border-radius:2px;cursor:grab;display:inline-block;}
.grabber:active{cursor:grabbing;}
.line-controls button{padding:4px 8px;margin-left:4px;border:1px solid var(--border);background:#fff;border-radius:3px;cursor:pointer;font-size:12px;}
input.qty,input.price,input.discount{width:60px;}
input.error{border-color:var(--error);}
.error-hint{color:var(--error);font-size:12px;display:block;}
#footer{display:flex;justify-content:space-between;align-items:center;padding:var(--pad) 0;background:#f8f9fa;border-top:1px solid var(--border);margin-top:auto;}
#totals{font-weight:600;font-size:16px;}
#undo,#redo{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:var(--radius);cursor:pointer;}
#dirty{display:inline-block;width:8px;height:8px;background:var(--warn);border-radius:50%;margin-left:4px;}
#sync-indicator{display:inline-block;width:8px;height:8px;background:var(--success);border-radius:50%;margin-left:4px;}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;}
.modal-content{background:#fff;padding:24px;border-radius:var(--radius);max-width:500px;width:90%;max-height:80vh;overflow:auto;}
.modal-content h3{margin-bottom:16px;}
.modal-content label{display:block;margin:8px 0 4px;}
.modal-content input,.modal-content textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;}
.modal-buttons{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}
#live-region{position:absolute;left:-9999px;}
@media print{#toolbar,#sidebar{display:none;}.content{padding:0;}#print-invoice{max-width:8.5in;margin:0 auto;font-size:12pt;}h1{font-size:24pt;text-align:center;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;text-align:left;}th{background:#eee;}}
@media (max-width:768px){.sidebar{display:none;}}
</style>
</head>
<body>
<div id="app" role="main" aria-label="Pocket Invoice Studio">
<header id="toolbar" role="toolbar" aria-label="Main toolbar">
<h1>Pocket Invoice Studio</h1>
<button id="new-invoice" tabindex="0" aria-label="New Invoice (Alt+N)">New</button>
<button id="save" tabindex="0" aria-label="Save (Alt+S)">Save</button>
<button id="export-json" tabindex="0" aria-label="Export JSON">Export</button>
<input type="file" id="import-json" accept=".json" style="display:none;" aria-label="Import JSON">
<button id="print" tabindex="0" aria-label="Print PDF (Ctrl+P)">Print</button>
<button id="reset" tabindex="0" aria-label="Reset App">Reset</button>
<div id="status" aria-live="polite">
<span id="online-status">●</span>
<span id="storage-status"></span>
<span id="dirty-indicator" style="display:none;">⚡</span>
</div>
</header>
<main>
<div class="sidebar" role="complementary" aria-label="Clients & Items">
<h2>Clients</h2>
<div class="client-list" id="client-list" role="listbox" aria-label="Client list"></div>
<button id="add-client" tabindex="0" aria-label="Add new client">+ Add Client</button>
<h2 style="margin-top:24px;">Saved Items</h2>
<div id="item-list" role="listbox" aria-label="Saved items"></div>
</div>
<div class="content">
<div class="invoice-header" role="form" aria-label="Invoice header">
<div>
<label for="invoice-number">Invoice #:</label>
<input id="invoice-number" type="text" readonly tabindex="-1">
</div>
<div>
<label for="client-select">Client:</label>
<select id="client-select" aria-label="Select client" tabindex="0"></select>
</div>
<div>
<label for="date">Date:</label>
<input id="date" type="date" tabindex="0">
</div>
<div>
<label for="due-date">Due Date:</label>
<input id="due-date" type="date" tabindex="0">
</div>
<div>
<label for="tax-percent">Tax %:</label>
<input id="tax-percent" type="number" min="0" max="100" step="0.1" tabindex="0">
</div>
<div>
<label for="status-select">Status:</label>
<select id="status-select" tabindex="0">
<option>Draft</option>
<option>Sent</option>
<option>Paid</option>
</select>
</div>
</div>
<div style="margin:var(--pad) 0;">
<textarea id="notes" placeholder="Notes..." rows="3" style="width:100%;padding:var(--pad);border:1px solid var(--border);border-radius:var(--radius);" tabindex="0" aria-label="Invoice notes"></textarea>
</div>
<table id="lines" role="grid" aria-label="Invoice line items">
<thead>
<tr><th style="width:20px;">↕</th><th>Description</th><th style="width:60px;">Qty</th><th style="width:80px;">Unit Price</th><th style="width:70px;">Disc %</th><th style="width:80px;">Total</th><th>Actions</th></tr>
</thead>
<tbody id="line-tbody"></tbody>
</table>
<div style="text-align:right;">
<button id="add-line" tabindex="0" aria-label="Add line item">+ Add Line</button>
<button id="send-invoice" tabindex="0" aria-label="Send Invoice">Send</button>
</div>
<div id="footer">
<div id="totals">
Subtotal: $<span id="subtotal">0.00</span> | Tax: $<span id="tax">0.00</span> | Total: $<span id="total">0.00</span>
</div>
<div>
<button id="undo" tabindex="0" aria-label="Undo (Ctrl+Z)">↶ Undo</button>
<button id="redo" tabindex="0" aria-label="Redo (Ctrl+Y)">↷ Redo</button>
</div>
</div>
</div>
</main>
<div id="client-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
<div class="modal-content">
<h3 id="modal-title">Add Client</h3>
<div>
<label for="client-name">Name:</label>
<input id="client-name" type="text">
</div>
<div>
<label for="client-company">Company:</label>
<input id="client-company" type="text">
</div>
<div>
<label for="client-email">Email:</label>
<input id="client-email" type="email">
</div>
<div>
<label for="client-phone">Phone:</label>
<input id="client-phone" type="tel">
</div>
<div>
<label for="client-address">Address:</label>
<textarea id="client-address" rows="3"></textarea>
</div>
<div class="modal-buttons">
<button id="cancel-client" tabindex="0">Cancel</button>
<button id="save-client" tabindex="0">Save</button>
</div>
</div>
</div>
<div id="confirm-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
<div class="modal-content">
<p id="confirm-text"></p>
<div class="modal-buttons">
<button id="confirm-no" tabindex="0">No</button>
<button id="confirm-yes" tabindex="0">Yes</button>
</div>
</div>
</div>
<div id="live-region" aria-live="polite" aria-atomic="true" aria-relevant="additions text"></div>
</div>
<script>
// Pocket Invoice Studio - Single-file offline-first invoicing app
// Data model and storage layer
const STORAGE_KEY = 'pocket-invoice-v1';
const MAX_HISTORY = 50;
let state = {
  metadata: {lastInvoiceNumber: 1, autoSave: true},
  clients: [],
  invoices: [],
  savedItems: [],
  currentInvoiceId: null,
  history: [],
  historyIndex: -1,
  isDirty: false
};

const dom = {
  app: document.getElementById('app'),
  toolbar: document.getElementById('toolbar'),
  clientList: document.getElementById('client-list'),
  clientSelect: document.getElementById('client-select'),
  invoiceNumber: document.getElementById('invoice-number'),
  date: document.getElementById('date'),
  dueDate: document.getElementById('due-date'),
  taxPercent: document.getElementById('tax-percent'),
  statusSelect: document.getElementById('status-select'),
  notes: document.getElementById('notes'),
  lineTbody: document.getElementById('line-tbody'),
  totals: {
    subtotal: document.getElementById('subtotal'),
    tax: document.getElementById('tax'),
    total: document.getElementById('total')
  },
  dirtyIndicator: document.getElementById('dirty-indicator'),
  onlineStatus: document.getElementById('online-status'),
  storageStatus: document.getElementById('storage-status'),
  liveRegion: document.getElementById('live-region')
};

let dragData = null;

// Storage utilities
function generateId(prefix = '') {
  return prefix + Date.now() + Math.random().toString(36).substr(2, 9);
}

function atomicSave() {
  const saveData = {
    ...state,
    historyIndex: state.historyIndex
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
  announce('Saved to storage');
  checkStorageQuota();
}

function loadState() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) {
      Object.assign(state, JSON.parse(data));
      state.history = state.history.slice(-MAX_HISTORY);
    } else {
      bootstrap();
    }
  } catch (e) {
    console.error('Load failed:', e);
    bootstrap();
  }
  render();
}

function bootstrap() {
  state.clients = [{
    id: generateId('c_'),
    name: 'John Doe',
    company: 'Sample Corp',
    email: 'john@example.com',
    phone: '(555) 123-4567',
    address: '123 Main St, Anytown, USA'
  }];
  state.savedItems = [{
    id: generateId('i_'),
    description: 'Consulting Hour',
    unitPrice: 100,
    qty: 1
  }];
  atomicSave();
}

// History management
function pushHistory(action) {
  // Truncate forward history
  state.history = state.history.slice(0, state.historyIndex + 1);
  state.history.push({action, state: {...state, history: undefined, historyIndex: undefined}});
  if (state.history.length > MAX_HISTORY) {
    state.history.shift();
  }
  state.historyIndex = state.history.length - 1;
  state.isDirty = true;
  updateDirtyIndicator();
  atomicSave();
}

function undo() {
  if (state.historyIndex > 0) {
    state.historyIndex--;
    Object.assign(state, state.history[state.historyIndex].state);
    render();
    announce('Undone');
  }
}

function redo() {
  if (state.historyIndex < state.history.length - 1) {
    state.historyIndex++;
    Object.assign(state, state.history[state.historyIndex].state);
    render();
    announce('Redone');
  }
}

// Model operations
function createNewInvoice() {
  const number = state.metadata.lastInvoiceNumber.toString().padStart(4, '0');
  const invoice = {
    id: generateId('inv_'),
    number,
    date: new Date().toISOString().split('T')[0],
    dueDate: '',
    clientId: '',
    items: [],
    taxPercent: 0,
    notes: '',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    status: 'Draft'
  };
  state.invoices.push(invoice);
  state.metadata.lastInvoiceNumber++;
  state.currentInvoiceId = invoice.id;
  pushHistory({type: 'newInvoice', invoiceId: invoice.id});
  render();
}

function getCurrentInvoice() {
  return state.invoices.find(inv => inv.id === state.currentInvoiceId);
}

function updateInvoiceField(field, value) {
  const invoice = getCurrentInvoice();
  if (invoice) {
    invoice[field] = value;
    invoice.updatedAt = new Date().toISOString();
    pushHistory({type: 'updateField', field, value, invoiceId: invoice.id});
  }
}

function addLineItem(desc = '', qty = 1, unitPrice = 0, discount = 0) {
  const invoice = getCurrentInvoice();
  if (invoice) {
    const newItem = {
      id: generateId('item_'),
      description: desc,
      qty: parseFloat(qty) || 0,
      unitPrice: parseFloat(unitPrice) || 0,
      discountPercent: parseFloat(discount) || 0,
      position: invoice.items.length
    };
    invoice.items.push(newItem);
    updatePositions(invoice);
    pushHistory({type: 'addItem', itemId: newItem.id, invoiceId: invoice.id});
  }
}

function updateLineItem(itemId, field, value) {
  const invoice = getCurrentInvoice();
  const item = invoice.items.find(item => item.id === itemId);
  if (item) {
    item[field] = field.includes('Percent') ? parseFloat(value) || 0 : parseFloat(value) || 0;
    validateLineItem(item);
    pushHistory({type: 'updateItem', itemId, field, value, invoiceId: invoice.id});
  }
}

function deleteLineItem(itemId) {
  const invoice = getCurrentInvoice();
  const index = invoice.items.findIndex(item => item.id === itemId);
  if (index > -1) {
    invoice.items.splice(index, 1);
    updatePositions(invoice);
    pushHistory({type: 'deleteItem', itemId, invoiceId: invoice.id});
  }
}

function updatePositions(invoice) {
  invoice.items.forEach((item, i) => item.position = i);
}

function validateLineItem(item) {
  item.qty = Math.max(0, item.qty);
  item.unitPrice = Math.max(0, item.unitPrice);
  item.discountPercent = Math.max(0, Math.min(100, item.discountPercent));
}

function calculateTotals() {
  const invoice = getCurrentInvoice();
  if (!invoice) return {subtotal: 0, tax: 0, total: 0};
  
  let subtotal = 0;
  invoice.items.forEach(item => {
    const lineTotal = item.qty * item.unitPrice * (1 - item.discountPercent / 100);
    subtotal += lineTotal;
  });
  
  const tax = subtotal * (invoice.taxPercent / 100);
  return {subtotal: subtotal.toFixed(2), tax: tax.toFixed(2), total: (subtotal + tax).toFixed(2)};
}

// UI Rendering
function render() {
  renderClients();
  renderCurrentInvoice();
  renderSavedItems();
}

function renderClients() {
  dom.clientList.innerHTML = state.clients.map(client => 
    `<div class="client-item" role="option" tabindex="0" data-id="${client.id}" aria-selected="false">
      ${client.name} ${client.company ? `(${client.company})` : ''}
      <small>${client.email}</small>
    </div>`
  ).join('');
  
  const selectOptions = ['<option value="">Select client...</option>'].concat(
    state.clients.map(client => `<option value="${client.id}">${client.name} - ${client.company || 'No company'}</option>`)
  );
  dom.clientSelect.innerHTML = selectOptions.join('');
}

function renderCurrentInvoice() {
  const invoice = getCurrentInvoice();
  if (!invoice) {
    dom.invoiceNumber.value = '';
    dom.date.value = '';
    dom.dueDate.value = '';
    dom.taxPercent.value = '';
    dom.statusSelect.value = 'Draft';
    dom.notes.value = '';
    dom.lineTbody.innerHTML = '';
    return;
  }
  
  dom.invoiceNumber.value = invoice.number;
  dom.date.value = invoice.date;
  dom.dueDate.value = invoice.dueDate;
  dom.taxPercent.value = invoice.taxPercent;
  dom.statusSelect.value = invoice.status;
  dom.notes.value = invoice.notes;
  dom.clientSelect.value = invoice.clientId;
  
  dom.lineTbody.innerHTML = invoice.items.map(item => `
    <tr class="line-row" data-id="${item.id}" draggable="true" tabindex="0">
      <td><span class="grabber" role="img" aria-label="Drag handle">⋮⋮</span></td>
      <td><input type="text" value="${item.description}" data-field="description" class="line-input"></td>
      <td><input type="number" class="qty line-input" value="${item.qty}" min="0" step="0.1" data-field="qty"></td>
      <td><input type="number" class="price line-input" value="${item.unitPrice}" min="0" step="0.01" data-field="unitPrice" style="text-align:right;"></td>
      <td><input type="number" class="discount line-input" value="${item.discountPercent}" min="0" max="100" step="0.1" data-field="discountPercent"></td>
      <td style="font-weight:600;text-align:right;">${calculateLineTotal(item)}</td>
      <td>
        <button class="dup-line" aria-label="Duplicate">⧟</button>
        <button class="del-line" aria-label="Delete">×</button>
      </td>
    </tr>
  `).join('');
  
  const totals = calculateTotals();
  dom.totals.subtotal.textContent = totals.subtotal;
  dom.totals.tax.textContent = totals.tax;
  dom.totals.total.textContent = totals.total;
}

function renderSavedItems() {
  document.getElementById('item-list').innerHTML = state.savedItems.map(item => 
    `<div class="client-item" draggable="true" data-type="item" data-id="${item.id}">
      ${item.description} - $${item.unitPrice}
    </div>`
  ).join('');
}

function calculateLineTotal(item) {
  const total = item.qty * item.unitPrice * (1 - item.discountPercent / 100);
  return total.toFixed(2);
}

// Event bindings
function bindEvents() {
  // Toolbar
  document.getElementById('new-invoice').addEventListener('click', createNewInvoice);
  document.getElementById('save').addEventListener('click', atomicSave);
  document.getElementById('export-json').addEventListener('click', exportJSON);
  document.getElementById('import-json').addEventListener('change', handleImport);
  document.getElementById('print').addEventListener('click', () => window.print());
  document.getElementById('reset').addEventListener('click', confirmReset);
  
  // Header fields
  dom.date.addEventListener('change', (e) => updateInvoiceField('date', e.target.value));
  dom.dueDate.addEventListener('change', (e) => updateInvoiceField('dueDate', e.target.value));
  dom.taxPercent.addEventListener('change', (e) => updateInvoiceField('taxPercent', parseFloat(e.target.value) || 0));
  dom.statusSelect.addEventListener('change', (e) => updateInvoiceField('status', e.target.value));
  dom.notes.addEventListener('input', (e) => updateInvoiceField('notes', e.target.value));
  dom.clientSelect.addEventListener('change', (e) => updateInvoiceField('clientId', e.target.value));
  
  // Line items
  document.getElementById('add-line').addEventListener('click', () => addLineItem());
  document.getElementById('send-invoice').addEventListener('click', simulateSend);
  
  // Undo/Redo
  document.getElementById('undo').addEventListener('click', undo);
  document.getElementById('redo').addEventListener('click', redo);
  
  // Client management
  document.getElementById('add-client').addEventListener('click', showClientModal);
  
  // Drag and drop
  document.addEventListener('dragstart', handleDragStart);
  document.addEventListener('dragover', handleDragOver);
  document.addEventListener('drop', handleDrop);
  document.addEventListener('dragend', handleDragEnd);
  
  // Keyboard shortcuts
  document.addEventListener('keydown', handleKeydown);
  
  // Online status
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();
  
  // Storage events
  window.addEventListener('storage', checkStorageQuota);
}

function handleKeydown(e) {
  if (e.target.closest('input, textarea, select')) return;
  
  if (e.altKey && e.key === 'n') {
    e.preventDefault();
    createNewInvoice();
  } else if (e.altKey && e.key === 's') {
    e.preventDefault();
    atomicSave();
  } else if (e.ctrlKey && e.key === 'z') {
    e.preventDefault();
    undo();
  } else if (e.ctrlKey && e.key === 'y') {
    e.preventDefault();
    redo();
  } else if (e.key === 'p' && e.ctrlKey) {
    e.preventDefault();
    window.print();
  }
}

function handleDragStart(e) {
  const row = e.target.closest('tr');
  if (row && row.classList.contains('line-row')) {
    dragData = {type: 'line', id: row.dataset.id};
    e.target.style.opacity = '0.5';
  } else if (e.target.dataset.type === 'item') {
    dragData = {type: 'savedItem', id: e.target.dataset.id};
  }
}

function handleDragOver(e) {
  e.preventDefault();
}

function handleDrop(e) {
  e.preventDefault();
  const dropTarget = e.target.closest('tr.line-row');
  
  if (dragData.type === 'line' && dropTarget) {
    const invoice = getCurrentInvoice();
    const draggedItem = invoice.items.find(item => item.id === dragData.id);
    const targetItem = invoice.items.find(item => item.id === dropTarget.dataset.id);
    
    const draggedIndex = invoice.items.indexOf(draggedItem);
    const targetIndex = invoice.items.indexOf(targetItem);
    
    invoice.items.splice(draggedIndex, 1);
    invoice.items.splice(targetIndex, 0, draggedItem);
    updatePositions(invoice);
    pushHistory({type: 'reorder', invoiceId: invoice.id});
    renderCurrentInvoice();
  } else if (dragData.type === 'savedItem') {
    const savedItem = state.savedItems.find(item => item.id === dragData.id);
    if (savedItem) {
      addLineItem(savedItem.description, savedItem.qty || 1, savedItem.unitPrice, savedItem.discountPercent || 0);
    }
  }
}

function handleDragEnd(e) {
  if (dragData?.type === 'line') {
    e.target.style.opacity = '1';
  }
  dragData = null;
}

// Modals
function showClientModal(editId = null) {
  const modal = document.getElementById('client-modal');
  const title = document.getElementById('modal-title');
  
  if (editId) {
    const client = state.clients.find(c => c.id === editId);
    if (client) {
      document.getElementById('client-name').value = client.name;
      document.getElementById('client-company').value = client.company || '';
      document.getElementById('client-email').value = client.email || '';
      document.getElementById('client-phone').value = client.phone || '';
      document.getElementById('client-address').value = client.address || '';
      title.textContent = 'Edit Client';
    }
  } else {
    title.textContent = 'Add Client';
    ['client-name','client-company','client-email','client-phone','client-address'].forEach(id => 
      document.getElementById(id).value = ''
    );
  }
  
  modal.classList.remove('hidden');
  modal.setAttribute('aria-hidden', 'false');
  modal.querySelector('input').focus();
  window.currentEditClientId = editId;
}

function saveClient() {
  const client = {
    id: window.currentEditClientId || generateId('c_'),
    name: document.getElementById('client-name').value.trim(),
    company: document.getElementById('client-company').value.trim(),
    email: document.getElementById('client-email').value.trim(),
    phone: document.getElementById('client-phone').value.trim(),
    address: document.getElementById('client-address').value.trim()
  };
  
  if (!client.name) {
    announce('Name is required', 'error');
    return;
  }
  
  if (window.currentEditClientId) {
    const index = state.clients.findIndex(c => c.id === client.id);
    state.clients[index] = client;
    pushHistory({type: 'updateClient', clientId: client.id});
  } else {
    state.clients.push(client);
    pushHistory({type: 'addClient', client});
  }
  
  document.getElementById('client-modal').classList.add('hidden');
  render();
  announce('Client saved');
}

function deleteClient(clientId) {
  const index = state.clients.findIndex(c => c.id === clientId);
  if (index > -1) {
    state.clients.splice(index, 1);
    pushHistory({type: 'deleteClient', clientId});
    render();
  }
}

// Export/Import
function exportJSON() {
  const dataStr = JSON.stringify(state, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `pocket-invoice-${new Date().toISOString().slice(0,10)}.json`;
  link.click();
  URL.revokeObjectURL(url);
}

function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const imported = JSON.parse(e.target.result);
      showConfirm('Replace all data with imported file?', () => {
        Object.assign(state, imported);
        atomicSave();
        render();
        announce('Data imported');
      });
    } catch (err) {
      announce('Invalid JSON file', 'error');
    }
  };
  reader.readAsText(file);
}

// Print
function printInvoice() {
  const invoice = getCurrentInvoice();
  if (!invoice) return;
  
  const client = state.clients.find(c => c.id === invoice.clientId);
  const printHTML = `
    <div id="print-invoice">
      <h1>Invoice #${invoice.number}</h1>
      ${client ? `<p><strong>${client.name}</strong><br>${client.company || ''}<br>${client.email}<br>${client.phone}</p>` : ''}
      <p>Date: ${invoice.date} | Due: ${invoice.dueDate || 'Net 30'} | Status: ${invoice.status}</p>
      <table>
        <thead><tr><th>Description</th><th>Qty</th><th>Unit</th><th>Disc%</th><th>Total</th></tr></thead>
        <tbody>
          ${invoice.items.map(item => `
            <tr>
              <td>${item.description}</td>
              <td>${item.qty}</td>
              <td>$${item.unitPrice.toFixed(2)}</td>
              <td>${item.discountPercent}%</td>
              <td>$${calculateLineTotal(item)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div style="margin-top:20px;text-align:right;">
        <div>Subtotal: $${calculateTotals().subtotal}</div>
        <div>Tax (${invoice.taxPercent}%): $${calculateTotals().tax}</div>
        <div style="font-size:18pt;font-weight:bold;">Total: $${calculateTotals().total}</div>
      </div>
      ${invoice.notes ? `<div style="margin-top:30px;"><strong>Notes:</strong> ${invoice.notes}</div>` : ''}
    </div>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html><head>
      <title>Invoice #${invoice.number}</title>
      <style>
        body{font-family:serif;margin:40px;background:#fff;color:#000;}
        table{width:100%;border-collapse:collapse;margin:20px 0;}
        th,td{border:1px solid #000;padding:8px;text-align:left;}
        th{background:#f0f0f0;}
      </style>
    </head><body>${printHTML}</body></html>
  `);
  printWindow.document.close();
  printWindow.print();
}

// Utilities
function announce(message, type = 'success') {
  dom.liveRegion.textContent = `${type === 'error' ? 'Error: ' : ''}${message}`;
  setTimeout(() => dom.liveRegion.textContent = '', 5000);
}

function updateDirtyIndicator() {
  dom.dirtyIndicator.style.display = state.isDirty ? 'inline-block' : 'none';
}

function updateOnlineStatus() {
  const isOnline = navigator.onLine;
  dom.onlineStatus.textContent = isOnline ? '● Online' : '● Offline';
  dom.onlineStatus.className = isOnline ? 'online' : 'offline';
}

async function checkStorageQuota() {
  if ('storage' in navigator && 'estimate' in navigator.storage) {
    const estimate = await navigator.storage.estimate();
    const usagePercent = (estimate.usage / estimate.quota) * 100;
    if (usagePercent > 80) {
      dom.storageStatus.textContent = 'Storage full';
      dom.storageStatus.style.color = 'var(--error)';
    } else {
      dom.storageStatus.textContent = '';
    }
  }
}

function showConfirm(message, yesCallback) {
  document.getElementById('confirm-text').textContent = message;
  const modal = document.getElementById('confirm-modal');
  modal.classList.remove('hidden');
  modal.setAttribute('aria-hidden', 'false');
  window.currentConfirmCallback = yesCallback;
}

function simulateSend() {
  const invoice = getCurrentInvoice();
  if (invoice) {
    invoice.status = 'Sent';
    invoice.updatedAt = new Date().toISOString();
    pushHistory({type: 'sendInvoice', invoiceId: invoice.id});
    render();
    navigator.clipboard.writeText(document.querySelector('.content').innerHTML).then(() => {
      announce('Invoice marked Sent. Content copied to clipboard.');
    });
  }
}

function confirmReset() {
  showConfirm('Reset all data? This cannot be undone.', () => {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });
}

// Line item event delegation
function bindLineEvents() {
  dom.lineTbody.addEventListener('input', (e) => {
    const input = e.target;
    if (input.classList.contains('line-input')) {
      const row = input.closest('tr');
      const itemId = row.dataset.id;
      const field = input.dataset.field;
      updateLineItem(itemId, field, input.value);
      input.classList.toggle('error', input.validity.bad);
    }
  });
  
  dom.lineTbody.addEventListener('click', (e) => {
    if (e.target.classList.contains('del-line')) {
      const row = e.target.closest('tr');
      deleteLineItem(row.dataset.id);
    } else if (e.target.classList.contains('dup-line')) {
      const row = e.target.closest('tr');
      const invoice = getCurrentInvoice();
      const item = invoice.items.find(item => item.id === row.dataset.id);
      addLineItem(item.description, item.qty, item.unitPrice, item.discountPercent);
    }
  });
  
  // Client list clicks
  dom.clientList.addEventListener('click', (e) => {
    const item = e.target.closest('.client-item');
    if (item) {
      const clientId = item.dataset.id;
      updateInvoiceField('clientId', clientId);
    }
  });
  
  // Right-click context menu for delete
  dom.clientList.addEventListener('contextmenu', (e) => {
    const item = e.target.closest('.client-item');
    if (item) {
      e.preventDefault();
      deleteClient(item.dataset.id);
    }
  });
}

// Modal event handlers
document.getElementById('save-client').addEventListener('click', saveClient);
document.getElementById('cancel-client').addEventListener('click', () => {
  document.getElementById('client-modal').classList.add('hidden');
});
document.getElementById('confirm-yes').addEventListener('click', () => {
  window.currentConfirmCallback?.();
  document.getElementById('confirm-modal').classList.add('hidden');
});
document.getElementById('confirm-no').addEventListener('click', () => {
  document.getElementById('confirm-modal').classList.add('hidden');
});

// Focus trapping for modals
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      modal.classList.add('hidden');
    }
  });
});

// Debounced autosave
let saveTimeout;
function debounceSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(atomicSave, 300);
}

// Initialize
loadState();
bindEvents();
bindLineEvents();
updateDirtyIndicator();

// Auto-save on changes (for fields that trigger pushHistory)
const autoSaveFields = ['date', 'dueDate', 'taxPercent', 'statusSelect', 'notes', 'clientSelect'];
autoSaveFields.forEach(id => {
  document.getElementById(id).addEventListener('change', debounceSave);
});

announce('Pocket Invoice Studio loaded');
</script>
</body>
</html>
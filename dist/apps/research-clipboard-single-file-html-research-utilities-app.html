<!DOCTYPE html>
<!--
Research Clipboard — single-file HTML research utilities app
Storage key: "research_clipboard_v1"
Shortcuts:
  Ctrl/Cmd+K => focus quick-capture (id="quick-capture")
  Enter in quick-capture => Add clip (id="btn-add")
  Ctrl/Cmd+Z => Undo; Ctrl/Cmd+Y or Ctrl/Cmd+Shift+Z => Redo
  Ctrl/Cmd+S => Open Export dialog (id="btn-export")
  Esc => Close editor/dismiss modal
Schema:
  root: { clips: {id: Clip}, order: [id], tags: {tagName: count}, settings: {...}, nextId: n }
  Clip: { id, title, text, tags: [str], url, starred: bool, pinned: bool, attachments: [{name, type, dataUri, size}], createdAt: ISO, updatedAt: ISO }
Notes:
  - Single-file app, inline CSS and JS, no external libs.
  - Accessible: ARIA roles, keyboard navigation, forms labeled.
  - Persistence: localStorage with graceful fallback to memory.
  - Undo/Redo: linear stack in memory, limit configurable in settings.
  - Attachments stored as base64 data URIs (max per-file adjustable).
  - Export/Import: JSON, plain text bundle, simple single-file HTML bundle.
-->
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2025-12-20T01:26:28.134246Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Research Clipboard</title>
<style>
:root{
  --bg:#f6f7f9; --card:#ffffff; --muted:#667; --accent:#0b79f7; --danger:#c0392b; --glass: rgba(255,255,255,0.6);
  --shadow: 0 1px 3px rgba(20,20,30,0.08);
}
[data-theme="dark"]{
  --bg:#0f1113; --card:#111417; --muted:#9aa4b2; --accent:#4da3ff; --danger:#ff6b6b; --glass: rgba(255,255,255,0.03);
  --shadow: 0 1px 4px rgba(0,0,0,0.6);
  color: #dfe7ef;
  background: var(--bg);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body{background:var(--bg);color: #102028;line-height:1.25;padding:0 0 40px}
.header{
  position:sticky;top:0;z-index:40;display:flex;align-items:center;gap:8px;padding:10px;background:linear-gradient(var(--glass),var(--glass));backdrop-filter: blur(6px);border-bottom:1px solid rgba(0,0,0,0.04)
}
.title{font-weight:600;margin-right:8px}
.toolbar{display:flex;flex:1;gap:8px;align-items:center}
#quick-capture{flex:1;padding:8px 10px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);min-width:120px}
.btn{
  background:var(--card);border:1px solid rgba(0,0,0,0.06);padding:8px 10px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow)
}
.icon{width:16px;height:16px;display:inline-block}
.small{padding:6px 8px;font-size:13px}
.container{display:grid;grid-template-columns:240px 1fr 380px;gap:12px;padding:12px;max-width:1300px;margin:10px auto}
@media (max-width:1000px){.container{grid-template-columns:200px 1fr}.rightpane{display:none}}
@media (max-width:720px){.container{grid-template-columns:1fr}.leftcol{display:none}.rightpane{display:none}.header{flex-wrap:wrap;padding-bottom:12px}}
.leftcol{background:var(--card);padding:12px;border-radius:8px;height:calc(100vh - 120px);overflow:auto;box-shadow:var(--shadow)}
.filter-btn{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.04);margin-bottom:8px;cursor:pointer}
.tags-list{margin-top:10px;display:flex;flex-direction:column;gap:6px}
.tag-item{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.04);cursor:pointer}
.main{min-height:60vh}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;padding:6px;align-items:start}
.card{background:var(--card);padding:10px;border-radius:8px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.03);display:flex;flex-direction:column;gap:8px;cursor:pointer;position:relative}
.card .meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
.preview{white-space:pre-wrap;overflow:hidden;max-height:6.2em;text-overflow:ellipsis}
.tag-pill{background:rgba(11,121,247,0.08);color:var(--accent);padding:4px 6px;border-radius:6px;font-size:12px;margin-right:6px}
.card-controls{display:flex;gap:6px;align-items:center}
.badge{background:#eee;padding:4px 6px;border-radius:6px;font-size:12px}
.star{color:gold}
.pinned{border-left:4px solid var(--accent)}
.rightpane{background:var(--card);padding:12px;border-radius:8px;height:calc(100vh - 120px);overflow:auto;box-shadow:var(--shadow);position:sticky;top:70px}
.drawer-hidden{display:none}
.form-row{display:flex;flex-direction:column;margin-bottom:8px}
.form-row label{font-size:13px;color:var(--muted);margin-bottom:4px}
.textarea{min-height:140px;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:transparent;resize:vertical}
.input{padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)}
.attach-list{display:flex;gap:8px;flex-wrap:wrap}
.attach-item{border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:6px;display:flex;align-items:center;gap:8px}
.footer-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{background:var(--card);padding:16px;border-radius:8px;max-width:680px;width:92%;box-shadow:var(--shadow)}
.empty{padding:40px;border:2px dashed rgba(0,0,0,0.06);border-radius:8px;text-align:center;color:var(--muted)}
.kv{font-family:monospace;background:#f1f5f9;padding:6px;border-radius:4px;font-size:12px}
.search{display:flex;gap:8px;align-items:center}
.small-muted{font-size:12px;color:var(--muted)}
.settings{margin-left:auto}
.hidden{display:none}
.badge-count{background:var(--accent);color:white;padding:2px 6px;border-radius:999px;font-size:12px}
a.inline{color:var(--accent)}
/* focus */
[tabindex]:focus,button:focus,input:focus,textarea:focus{outline:2px solid rgba(11,121,247,0.18);outline-offset:2px}
.drag-hint{opacity:0.6;font-size:12px}
</style>
<body data-theme="light">
  <header class="header" role="banner">
    <div class="title" aria-hidden="true">Research Clipboard</div>
    <div class="toolbar" role="search">
      <input id="quick-capture" aria-label="Quick capture" placeholder="Quick-capture: paste snippet or text and press Enter (Ctrl/Cmd+K to focus)" />
      <button id="btn-add" class="btn small" aria-label="Add clip">Add</button>
      <button id="btn-undo" class="btn small" aria-label="Undo (Ctrl/Cmd+Z)">Undo</button>
      <button id="btn-redo" class="btn small" aria-label="Redo (Ctrl/Cmd+Y)">Redo</button>
      <button id="btn-export" class="btn small" aria-label="Export">Export</button>
      <div class="settings">
        <button id="btn-settings" class="btn small" aria-expanded="false" aria-controls="settings-panel">Settings</button>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <aside class="leftcol" aria-label="Filters and tags">
      <div>
        <div class="filter-btn" role="button" tabindex="0" data-filter="all">All <span class="badge-count" id="count-all">0</span></div>
        <div class="filter-btn" role="button" tabindex="0" data-filter="untagged">Untagged <span class="badge-count" id="count-untagged">0</span></div>
        <div class="filter-btn" role="button" tabindex="0" data-filter="starred">Starred <span class="badge-count" id="count-starred">0</span></div>
        <div class="filter-btn" role="button" tabindex="0" data-filter="attachments">With Attachments</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <select id="date-filter" class="input" aria-label="Date filter">
            <option value="any">Any time</option>
            <option value="24h">Last 24h</option>
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
          </select>
          <button id="btn-toggle-navigate" class="btn small" title="Toggle navigate mode">Nav</button>
        </div>
        <div style="margin-top:10px" class="search">
          <input id="search" class="input" placeholder="Search title, text, tags, url" aria-label="Search clips" />
        </div>
        <div style="margin-top:12px" class="small-muted">Tags</div>
        <div class="tags-list" id="tags-list" role="list" tabindex="0" aria-label="Tag list"></div>
      </div>
      <div style="margin-top:16px">
        <div class="small-muted">Storage</div>
        <div id="storage-info" class="small-muted kv" style="margin-top:6px">...</div>
        <div style="margin-top:8px">
          <button id="btn-import" class="btn small" aria-label="Import JSON">Import JSON</button>
          <button id="btn-clear-all" class="btn small" aria-label="Clear all data">Clear All</button>
        </div>
      </div>
    </aside>

    <section class="main" aria-label="Clips area">
      <div id="clips-toolbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="small-muted" id="result-info">0 clips</div>
        <div class="drag-hint small-muted">Drag cards to reorder</div>
      </div>
      <div id="clips" class="grid" aria-live="polite" role="list"></div>
      <div id="empty-state" class="empty hidden" role="region">
        <div style="font-size:18px;font-weight:600">No clips yet</div>
        <div style="margin-top:8px" class="small-muted">Use the quick-capture above or click Add to create your first clip.</div>
        <div style="margin-top:12px">
          <button id="btn-empty-add" class="btn" aria-label="Add first clip">Add first clip</button>
        </div>
      </div>
    </section>

    <aside class="rightpane" id="editor-drawer" role="dialog" aria-modal="true" aria-hidden="true">
      <div id="editor-content" class="drawer-hidden">
        <form id="editor-form" onsubmit="return false;">
          <div class="form-row">
            <label for="edit-title">Title</label>
            <input id="edit-title" class="input" />
          </div>
          <div class="form-row">
            <label for="edit-text">Text</label>
            <textarea id="edit-text" class="textarea"></textarea>
          </div>
          <div class="form-row">
            <label for="edit-tags">Tags (comma separated)</label>
            <input id="edit-tags" class="input" aria-describedby="tag-suggestions" />
            <div id="tag-suggestions" class="small-muted" style="margin-top:6px"></div>
          </div>
          <div class="form-row">
            <label for="edit-url">Source URL</label>
            <input id="edit-url" class="input" placeholder="https://..." />
            <div id="url-error" class="small-muted" style="color:var(--danger);display:none"></div>
          </div>
          <div class="form-row">
            <label>Attachments (max <span id="attach-max">2MB</span> each)</label>
            <div id="dropzone" class="input" style="min-height:54px;display:flex;align-items:center;justify-content:space-between">
              <div>Drag files here or <button id="pick-file" class="btn small" type="button">Choose</button></div>
              <div id="attach-count" class="small-muted">0 / 3</div>
            </div>
            <div class="attach-list" id="attach-list" style="margin-top:8px"></div>
          </div>

          <div class="form-row">
            <label for="edit-notes">Notes</label>
            <textarea id="edit-notes" class="textarea" placeholder="Private notes"></textarea>
          </div>

          <div class="footer-actions">
            <button id="btn-save" class="btn" type="button">Save</button>
            <button id="btn-duplicate" class="btn" type="button">Duplicate</button>
            <button id="btn-delete" class="btn" type="button" style="background:var(--danger);color:white">Delete</button>
            <button id="btn-close" class="btn" type="button">Close</button>
            <div style="margin-left:auto" class="small-muted" id="clip-meta"></div>
          </div>
        </form>
      </div>
      <div id="editor-empty" class="small-muted">Select a clip to view or edit it.</div>
    </aside>

  </main>

  <!-- Modals (hidden by default) -->
  <div id="modal-root" aria-hidden="true"></div>

<script>
/* Modular JS: storage, rendering, editor, attachments, undo/redo, export/import, keyboard
   Keep code concise and commented. No external libs.
*/

/* --- Config & Defaults --- */
const STORAGE_KEY = "research_clipboard_v1";
const DEFAULT_SETTINGS = {
  attachMaxBytes: 2 * 1024 * 1024,
  undoLimit: 50,
  showTimestamps: true,
  theme: "light"
};

/* --- In-memory state --- */
let state = {
  clips: {},            // id -> clip
  order: [],            // array of ids
  tags: {},             // tag -> count
  settings: {...DEFAULT_SETTINGS},
  nextId: 1
};
let memoryOnly = false;
let undoStack = [];
let redoStack = [];
let navigateMode = false;

/* --- Util --- */
const $ = id => document.getElementById(id);
const nowISO = ()=> new Date().toISOString();
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const safeParse = (s, fallback)=>{try{return JSON.parse(s)}catch(e){return fallback}};
const uid = ()=> (state.nextId++).toString();

/* LocalStorage persistence with fallback */
function saveState(){
  const out = {clips: state.clips, order: state.order, tags: state.tags, settings: state.settings, nextId: state.nextId};
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
    memoryOnly = false;
    updateStorageInfo();
  }catch(e){
    // fallback to memory-only
    memoryOnly = true;
    showModal("Warning","localStorage unavailable. Data will only persist in this session. Export recommended.",[{text:"OK"}]);
    updateStorageInfo();
  }
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      state.clips = parsed.clips || {};
      state.order = parsed.order || [];
      state.tags = parsed.tags || {};
      state.settings = {...DEFAULT_SETTINGS, ...(parsed.settings || {})};
      state.nextId = parsed.nextId || 1;
    }else{
      // initial
      state = {...state, settings:{...DEFAULT_SETTINGS}};
      saveState();
    }
  }catch(e){
    memoryOnly = true;
    showModal("Warning","Failed to load from localStorage. Running in memory-only mode.",[{text:"OK"}]);
    // leave default state
  }
  document.body.setAttribute("data-theme", state.settings.theme || "light");
  $("attach-max").textContent = readableBytes(state.settings.attachMaxBytes);
}

/* --- Simple Modal system --- */
function showModal(title, html, buttons=[{text:"Close"}], opts={}){
  const root = $("modal-root");
  root.innerHTML = "";
  root.setAttribute("aria-hidden","false");
  const backdrop = document.createElement("div");
  backdrop.className="modal-backdrop";
  const modal = document.createElement("div");
  modal.className="modal";
  modal.setAttribute("role","dialog");
  modal.innerHTML = `<div style="font-weight:600;margin-bottom:8px">${title}</div><div>${html}</div>`;
  const btnRow = document.createElement("div"); btnRow.style.marginTop="12px"; btnRow.style.display="flex"; btnRow.style.gap="8px"; btnRow.style.justifyContent="flex-end";
  buttons.forEach(b=>{
    const btn = document.createElement("button"); btn.className="btn small"; btn.textContent=b.text;
    btn.onclick = () => { if(b.onClick) b.onClick(); root.innerHTML=""; root.setAttribute("aria-hidden","true"); };
    btnRow.appendChild(btn);
  });
  modal.appendChild(btnRow);
  backdrop.appendChild(modal);
  root.appendChild(backdrop);
  // Esc to close
  backdrop.tabIndex = -1;
  backdrop.addEventListener("keydown",(e)=>{ if(e.key==="Escape"){ root.innerHTML=""; root.setAttribute("aria-hidden","true"); }});
}

/* --- Storage helpers --- */
function indexTagsForClip(clip, delta){
  clip.tags = clip.tags || [];
  clip.tags.forEach(t=>{
    state.tags[t] = (state.tags[t]||0) + delta;
    if(state.tags[t] <= 0) delete state.tags[t];
  });
}
function addClip(clip, options={record:true, atTop:false}){
  clip.id = clip.id || uid();
  clip.createdAt = clip.createdAt || nowISO();
  clip.updatedAt = clip.updatedAt || clip.createdAt;
  state.clips[clip.id] = clip;
  if(options.atTop) state.order.unshift(clip.id); else state.order.push(clip.id);
  indexTagsForClip(clip, +1);
  if(options.record) pushUndo({type:"create", clipId:clip.id});
  saveState();
  renderAll();
  return clip;
}
function updateClip(id, patch, options={record:true}){
  const old = JSON.parse(JSON.stringify(state.clips[id]));
  if(!old) return;
  // update tag index
  if(patch.tags){
    // remove old
    indexTagsForClip({tags:old.tags||[]}, -1);
    indexTagsForClip({tags:patch.tags||[]}, +1);
  }
  const updated = {...old, ...patch, updatedAt: nowISO()};
  state.clips[id] = updated;
  if(options.record) pushUndo({type:"update", clipId:id, before:old, after:updated});
  saveState();
  renderAll();
}
function deleteClip(id, options={record:true}){
  const clip = state.clips[id];
  if(!clip) return;
  if(options.record) pushUndo({type:"delete", clip: JSON.parse(JSON.stringify(clip)), index: state.order.indexOf(id)});
  indexTagsForClip(clip, -1);
  delete state.clips[id];
  state.order = state.order.filter(x=>x!==id);
  saveState();
  renderAll();
}

/* --- Undo/Redo --- */
function pushUndo(action){
  undoStack.push(action);
  if(undoStack.length > state.settings.undoLimit) undoStack.shift();
  redoStack = [];
  updateUndoRedoUI();
}
function undo(){
  const a = undoStack.pop(); if(!a) return;
  if(a.type==="create"){
    // remove created clip
    const id = a.clipId;
    const clip = state.clips[id];
    if(clip){
      indexTagsForClip(clip,-1);
      delete state.clips[id];
      state.order = state.order.filter(x=>x!==id);
    }
  }else if(a.type==="delete"){
    // restore
    const clip = a.clip;
    state.clips[clip.id] = clip;
    state.order.splice(a.index,0,clip.id);
    indexTagsForClip(clip,+1);
  }else if(a.type==="update"){
    state.clips[a.clipId] = a.before;
    // rebuild tags
    // clear all and reindex locally by diff
    // simple: recompute state.tags from scratch
    rebuildTagIndex();
  }else if(a.type==="reorder"){
    state.order = a.before.slice();
  }
  redoStack.push(a);
  saveState();
  renderAll();
  updateUndoRedoUI();
}
function redo(){
  const a = redoStack.pop(); if(!a) return;
  if(a.type==="create"){
    // recreate
    const id = a.clipId;
    const clip = a.clip || null;
    if(clip){
      state.clips[id] = clip;
      state.order.push(id);
      indexTagsForClip(clip,+1);
    }
  }else if(a.type==="delete"){
    const id = a.clip.id;
    if(state.clips[id]){
      indexTagsForClip(state.clips[id],-1);
      delete state.clips[id];
      state.order = state.order.filter(x=>x!==id);
    }
  }else if(a.type==="update"){
    state.clips[a.clipId] = a.after;
    rebuildTagIndex();
  }else if(a.type==="reorder"){
    state.order = a.after.slice();
  }
  undoStack.push(a);
  saveState();
  renderAll();
  updateUndoRedoUI();
}
function rebuildTagIndex(){
  state.tags = {};
  Object.values(state.clips).forEach(c=>{
    (c.tags||[]).forEach(t=> state.tags[t] = (state.tags[t]||0)+1);
  });
}

/* --- Attachments --- */
function readFileAsDataURL(file, cb){
  if(file.size > state.settings.attachMaxBytes){
    cb(new Error("File exceeds per-file size limit"));
    return;
  }
  const reader = new FileReader();
  reader.onload = e => cb(null, {name:file.name,type:file.type,dataUri:e.target.result,size:file.size});
  reader.onerror = e => cb(new Error("Read failed"));
  reader.readAsDataURL(file);
}

/* --- Rendering --- */
let renderTimer = null;
function renderAll(){
  // debounce heavy rerenders
  if(renderTimer) clearTimeout(renderTimer);
  renderTimer = setTimeout(()=>{ renderClips(); renderTags(); updateCounts(); renderTimer=null }, 0);
}
function renderTags(){
  const list = $("tags-list"); list.innerHTML = "";
  const tags = Object.entries(state.tags).sort((a,b)=>b[1]-a[1]);
  if(tags.length===0){
    list.innerHTML = `<div class="small-muted">No tags yet</div>`; return;
  }
  tags.forEach(([t,count])=>{
    const el = document.createElement("div");
    el.className = "tag-item";
    el.setAttribute("role","listitem");
    el.tabIndex = 0;
    el.innerHTML = `<div>${t}</div><div class="small-muted">${count}</div>`;
    el.onclick = ()=>{ applyFilterByTag(t); };
    el.onkeydown = (e)=>{ if(e.key==="Enter"||e.key===" ") applyFilterByTag(t); };
    list.appendChild(el);
  });
  $("tag-suggestions").textContent = "Suggestions: " + tags.slice(0,8).map(x=>x).join(", ");
}
let activeFilter = {kind:"all", tag:null, date:"any", query:"", attachments:false};
function applyFilterByTag(tag){
  activeFilter = {kind:"tag", tag, date:$("date-filter").value, query:$("search").value, attachments:false};
  $("search").value = "";
  renderClips();
}

/* incremental rendering with simple windowing */
function renderClips(){
  const container = $("clips");
  const q = $("search").value.trim().toLowerCase();
  const dateFilter = $("date-filter").value;
  const listOrder = state.order.slice();
  // pinned on top
  listOrder.sort((a,b)=>{
    const A=state.clips[a], B=state.clips[b];
    if((A.pinned?1:0)!==(B.pinned?1:0)) return (B.pinned?1:0)-(A.pinned?1:0);
    return 0;
  });
  const results = [];
  const now = Date.now();
  listOrder.forEach(id=>{
    const c = state.clips[id];
    if(!c) return;
    // filters
    if(activeFilter.kind==="untagged" && (c.tags||[]).length>0) return;
    if(activeFilter.kind==="starred" && !c.starred) return;
    if(activeFilter.kind==="attachments" && !(c.attachments && c.attachments.length)) return;
    if(activeFilter.kind==="tag" && activeFilter.tag && !(c.tags||[]).includes(activeFilter.tag)) return;
    if(activeFilter.tag === null && activeFilter.kind==="all"){}
    if(dateFilter!=="any"){
      const cutoff = dateFilter==="24h"? now - 24*3600*1000 : dateFilter==="7d"? now - 7*24*3600*1000 : now - 30*24*3600*1000;
      if(new Date(c.createdAt).getTime() < cutoff) return;
    }
    // search query
    if(q){
      const hay = ((c.title||"") + " " + (c.text||"") + " " + (c.tags||[]).join(" ") + " " + (c.url||"")).toLowerCase();
      if(hay.indexOf(q)===-1) return; // simple substring match
    }
    results.push(c);
  });
  $("result-info").textContent = results.length + " clips";
  // empty state
  if(results.length===0){ $("empty-state").classList.remove("hidden"); container.innerHTML=""; return; } else { $("empty-state").classList.add("hidden"); }
  // basic incremental: render first N then others
  container.innerHTML = "";
  const batch = 60;
  const renderBatch = (start)=>{
    const end = Math.min(results.length, start + batch);
    for(let i=start;i<end;i++){
      const c = results[i];
      const card = document.createElement("div");
      card.className = "card" + (c.pinned? " pinned":"");
      card.setAttribute("role","listitem");
      card.tabIndex = 0;
      card.dataset.id = c.id;
      const previewText = (c.text||"").slice(0,200).replace(/\n+/g," ");
      const tagsHTML = (c.tags||[]).map(t=>`<span class="tag-pill">${escapeHtml(t)}</span>`).join("");
      const attachmentsCount = (c.attachments||[]).length;
      card.innerHTML = `<div>
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1"><div style="font-weight:600">${escapeHtml(c.title||previewText.slice(0,40))}</div>
            <div class="small-muted preview">${escapeHtml(previewText)}</div></div>
            <div class="card-controls" style="margin-left:8px">
              <button class="btn small" data-action="star" title="Star" aria-label="Star">${c.starred? "★":"☆"}</button>
              <button class="btn small" data-action="menu" title="Menu" aria-label="Menu">⋯</button>
            </div>
          </div>
          <div class="meta" style="margin-top:6px"><div class="small-muted">${c.url? escapeHtml(truncateUrl(c.url)): ""}</div><div class="small-muted">${state.settings.showTimestamps ? new Date(c.createdAt).toLocaleString() : ""}</div></div>
          <div style="margin-top:6px">${tagsHTML} ${(attachmentsCount? `<span class="badge">${attachmentsCount} att.</span>`:"")}</div>
        </div>`;
      // click handlers
      card.onclick = (e)=>{
        // avoid when clicking star/menu
        if(e.target && e.target.dataset && e.target.dataset.action) return;
        openEditor(c.id);
      };
      // star button
      card.querySelectorAll('button[data-action="star"]').forEach(b=>{
        b.onclick = (ev)=>{ ev.stopPropagation(); toggleStar(c.id); };
      });
      // menu (duplicate)
      card.querySelectorAll('button[data-action="menu"]').forEach(b=>{
        b.onclick = (ev)=>{ ev.stopPropagation(); duplicateClip(c.id); };
      });
      // drag
      card.draggable = true;
      card.addEventListener("dragstart", dragStart);
      card.addEventListener("dragover", dragOver);
      card.addEventListener("drop", dropCard);
      container.appendChild(card);
    }
    if(end < results.length){
      setTimeout(()=>renderBatch(end), 20);
    }
  };
  renderBatch(0);
}

/* Helpers */
function toggleStar(id){ const c = state.clips[id]; if(!c) return; updateClip(id, {starred: !c.starred}); }
function duplicateClip(id){
  const src = state.clips[id];
  if(!src) return;
  const copy = JSON.parse(JSON.stringify(src));
  delete copy.id;
  copy.title = (copy.title || "").slice(0,120) + " (copy)";
  copy.createdAt = copy.updatedAt = nowISO();
  copy.attachments = (copy.attachments||[]).slice();
  addClip(copy);
}
function truncateUrl(u){
  try{
    const url = new URL(u);
    return url.hostname + url.pathname.slice(0,30);
  }catch(e){
    return u.slice(0,30);
  }
}
function escapeHtml(s){ if(!s) return ""; return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function readableBytes(n){
  if(n<1024) return n + " B";
  if(n<1024*1024) return (n/1024).toFixed(1)+" KB";
  return (n/(1024*1024)).toFixed(2)+" MB";
}

/* Counts & storage info */
function updateCounts(){
  $("count-all").textContent = Object.keys(state.clips).length;
  $("count-starred").textContent = Object.values(state.clips).filter(c=>c.starred).length;
  $("count-untagged").textContent = Object.values(state.clips).filter(c=>!(c.tags && c.tags.length)).length;
}
function updateStorageInfo(){
  let info = "";
  try{
    const s = JSON.stringify(state);
    const bytes = new Blob([s]).size;
    info = `${readableBytes(bytes)} used (localStorage)`;
    if(memoryOnly) info += " — localStorage unavailable";
    // warn near quota check not reliable across browsers; show if >2.5MB
    if(bytes > 2.5 * 1024 * 1024) info += " — Approaching quota. Consider export+clear.";
  }catch(e){
    info = "Unable to compute storage usage.";
  }
  $("storage-info").textContent = info;
}

/* --- Editor Drawer --- */
let currentEditingId = null;
function openEditor(id){
  currentEditingId = id;
  const drawer = $("editor-drawer");
  drawer.setAttribute("aria-hidden","false");
  const content = $("editor-content");
  content.classList.remove("drawer-hidden");
  $("editor-empty").style.display = "none";
  const clip = state.clips[id];
  if(!clip) return;
  $("edit-title").value = clip.title || "";
  $("edit-text").value = clip.text || "";
  $("edit-tags").value = (clip.tags||[]).join(", ");
  $("edit-url").value = clip.url || "";
  $("edit-notes").value = clip.notes || "";
  renderAttachmentsList(clip);
  $("clip-meta").textContent = `Created: ${new Date(clip.createdAt).toLocaleString()}`;
}
function closeEditor(){
  currentEditingId = null;
  const drawer = $("editor-drawer");
  drawer.setAttribute("aria-hidden","true");
  $("editor-content").classList.add("drawer-hidden");
  $("editor-empty").style.display = "";
}

/* Attach list rendering */
function renderAttachmentsList(clip){
  const list = $("attach-list"); list.innerHTML = "";
  const atts = clip.attachments || [];
  $("attach-count").textContent = `${atts.length} / 3`;
  atts.forEach((a, idx)=>{
    const el = document.createElement("div"); el.className = "attach-item";
    const preview = (a.type.startsWith("image/")) ? `<img src="${a.dataUri}" alt="${escapeHtml(a.name)}" style="width:48px;height:48px;object-fit:cover;border-radius:4px">` : `<div style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:#eee;border-radius:4px">${a.type.split("/")||"file"}</div>`;
    el.innerHTML = `${preview}<div style="min-width:0"><div style="font-weight:600">${escapeHtml(a.name)}</div><div class="small-muted">${a.type} • ${readableBytes(a.size)}</div></div><div style="margin-left:auto;display:flex;flex-direction:column;gap:6px"><button class="btn small" data-act="download">Download</button><button class="btn small" data-act="remove">Remove</button></div>`;
    // download
    el.querySelector('[data-act="download"]').onclick = ()=>{ downloadDataUri(a.dataUri, a.name); };
    el.querySelector('[data-act="remove"]').onclick = ()=>{ if(!currentEditingId) return; const clip = state.clips[currentEditingId]; clip.attachments.splice(idx,1); updateClip(currentEditingId, {attachments: clip.attachments}); };
    list.appendChild(el);
  });
}

/* File picker & dropzone */
$("pick-file").addEventListener("click", ()=> {
  const inp = document.createElement("input");
  inp.type="file"; inp.multiple = true;
  inp.onchange = ()=>{ handleFiles(inp.files); };
  inp.click();
});
const dz = $("dropzone");
dz.addEventListener("dragover", e=>{ e.preventDefault(); dz.style.border="1px dashed var(--accent)"; });
dz.addEventListener("dragleave", e=>{ dz.style.border="1px solid rgba(0,0,0,0.06)"; });
dz.addEventListener("drop", e=>{ e.preventDefault(); dz.style.border="1px solid rgba(0,0,0,0.06)"; handleFiles(e.dataTransfer.files); });

function handleFiles(fileList){
  if(!currentEditingId){ showModal("No clip selected","Select or create a clip to add attachments.",[{text:"OK"}]); return; }
  const clip = state.clips[currentEditingId];
  const existing = clip.attachments || [];
  const allowed = 3 - existing.length;
  if(allowed <= 0){ showModal("Limit","Each clip can have up to 3 attachments.",[{text:"OK"}]); return; }
  const files = Array.from(fileList).slice(0, allowed);
  const toAdd = [];
  let pending = files.length;
  files.forEach(f=>{
    readFileAsDataURL(f,(err, data)=>{
      pending--;
      if(err){ showModal("Attachment error", err.message, [{text:"OK"}]); }
      else toAdd.push(data);
      if(pending===0){
        const newAtt = existing.concat(toAdd);
        updateClip(currentEditingId, {attachments: newAtt});
        openEditor(currentEditingId); // refresh attachments list
      }
    });
  });
}

/* download helper */
function downloadDataUri(dataUri, filename){
  const a = document.createElement("a");
  a.href = dataUri; a.download = filename || "file";
  document.body.appendChild(a); a.click(); a.remove();
}

/* --- Quick-capture and toolbar actions --- */
$("btn-add").addEventListener("click", ()=>{ addFromQuick(); });
$("btn-empty-add").addEventListener("click", ()=>{ addFromQuick(); });
$("quick-capture").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addFromQuick(); } });
function addFromQuick(){
  const text = $("quick-capture").value.trim();
  if(!text){ showModal("Empty","Please enter some text to add.",[{text:"OK"}]); return; }
  const url = (typeof document !== "undefined" && document.location) ? document.location.href : "";
  const clip = { title: text.slice(0,80), text, tags: [], url, starred:false, pinned:false, attachments:[], createdAt: nowISO(), updatedAt: nowISO() };
  addClip(clip, {atTop:true});
  $("quick-capture").value = "";
  // open editor for quick refinement
}

/* --- Editor buttons --- */
$("btn-save").addEventListener("click", ()=>{
  if(!currentEditingId) return;
  const title = $("edit-title").value.trim();
  const text = $("edit-text").value;
  const tags = $("edit-tags").value.split(",").map(s=>s.trim()).filter(s=>s);
  const url = $("edit-url").value.trim();
  if(url && !isValidUrl(url)){ $("url-error").style.display="block"; $("url-error").textContent="Invalid URL"; return; } else { $("url-error").style.display="none"; }
  const notes = $("edit-notes").value;
  updateClip(currentEditingId, {title, text, tags, url, notes});
});
$("btn-delete").addEventListener("click", ()=>{
  if(!currentEditingId) return;
  showModal("Confirm delete", `Type DELETE to confirm deleting this clip.`, [
    {text:"Cancel"},
    {text:"Delete", onClick: ()=> {
      const confirmInput = document.querySelector("#modal-root input");
      // we will implement typed confirmation inside modal
    }}
  ]);
  // custom modal with typed confirmation
  showTypedConfirm("Delete clip","Type DELETE to confirm deletion", (ok)=>{
    if(ok){ deleteClip(currentEditingId); closeEditor(); }
  });
});
$("btn-duplicate").addEventListener("click", ()=>{ if(currentEditingId) duplicateClip(currentEditingId); });
$("btn-close").addEventListener("click", ()=>{ closeEditor(); });

function showTypedConfirm(title, prompt, cb){
  showModal(title, `<div>${prompt}</div><div style="margin-top:8px"><input id="typed" class="input" placeholder="Type here"/></div>`, [
    {text:"Cancel"},
    {text:"Confirm", onClick: ()=>{
      const v = document.querySelector("#modal-root #typed")?.value || "";
      cb(v.trim()==="DELETE");
    }}
  ]);
}

/* --- Import/Export --- */
$("btn-export").addEventListener("click", ()=>{ openExportDialog(); });
$("btn-import").addEventListener("click", ()=>{ openImportDialog(); });

function openExportDialog(){
  const all = confirmExportData();
  const html = `<div class="small-muted">Choose export format</div><div style="margin-top:8px;display:flex;gap:8px"><button id="exp-json" class="btn small">Export JSON</button><button id="exp-txt" class="btn small">Plain text bundle</button><button id="exp-html" class="btn small">Single-file HTML bundle</button></div>`;
  showModal("Export", html, [{text:"Close"}]);
  setTimeout(()=>{
    document.querySelector("#modal-root #exp-json").onclick = ()=>{ downloadJSON(all ? null : getSelectedIds()); };
    document.querySelector("#modal-root #exp-txt").onclick = ()=>{ downloadPlainText(all ? null : getSelectedIds()); };
    document.querySelector("#modal-root #exp-html").onclick = ()=>{ downloadHTMLBundle(all ? null : getSelectedIds()); };
  },10);
}
function confirmExportData(){ return true; } // placeholder to select subset; for now export all

function getSelectedIds(){ return state.order.slice(); }

function downloadJSON(ids=null){
  const subset = buildExportObject(ids);
  const blob = new Blob([JSON.stringify(subset, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download="research-clips.json"; document.body.appendChild(a); a.click(); a.remove();
}
function downloadPlainText(ids=null){
  const subset = buildExportObject(ids);
  const parts = [];
  Object.values(subset.clips).forEach(c=>{
    parts.push(`---\nTitle: ${c.title||""}\nURL: ${c.url||""}\nTags: ${(c.tags||[]).join(", ")}\nCreated: ${c.createdAt}\n\n${c.text||""}\n`);
  });
  const blob = new Blob([parts.join("\n")], {type:"text/plain"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download="research-clips.txt"; document.body.appendChild(a); a.click(); a.remove();
}
function downloadHTMLBundle(ids=null){
  const subset = buildExportObject(ids);
  let html = `<!doctype html><meta charset="utf-8"><title>Research Clips Export</title><style>body{font-family:system-ui,Arial;padding:20px} .clip{border:1px solid #ddd;padding:12px;margin-bottom:12px;border-radius:6px}</style><h1>Research Clips</h1>`;
  Object.values(subset.clips).forEach(c=>{
    html += `<div class="clip"><div style="font-weight:600">${escapeHtml(c.title||"")}</div><div class="small-muted">${escapeHtml(c.url||"")}</div><div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(c.text||"")}</div></div>`;
  });
  const blob = new Blob([html], {type:"text/html"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download="research-clips.html"; document.body.appendChild(a); a.click(); a.remove();
}
function buildExportObject(ids=null){
  const clips = {};
  const order = [];
  const idsToExport = ids || state.order.slice();
  idsToExport.forEach(id=>{
    if(state.clips[id]){ clips[id] = state.clips[id]; order.push(id); }
  });
  return {clips, order, tags: state.tags, settings: state.settings, nextId: state.nextId};
}

function openImportDialog(){
  const inp = document.createElement("input"); inp.type="file"; inp.accept="application/json";
  inp.onchange = ()=>{ const f = inp.files; if(!f) return; const r = new FileReader(); r.onload = e=>{ try{ const parsed = JSON.parse(e.target.result); // merge cautiously
      showModal("Import","Importing will merge with existing data. Continue?", [{text:"Cancel"},{text:"Import", onClick:()=> doImport(parsed)}]); }catch(err){ showModal("Error","Invalid JSON",[{text:"OK"}]); } };
    r.readAsText(f);
  };
  inp.click();
}
function doImport(parsed){
  // naive merge: add clips with new ids if conflict
  const mapping = {};
  Object.values(parsed.clips||{}).forEach(c=>{
    const newId = uid();
    const clip = {...c, id:newId};
    addClip(clip,{record:false});
    mapping[c.id]=newId;
  });
  saveState();
  renderAll();
}

/* --- Drag & Drop Reorder --- */
let dragSrcId = null;
function dragStart(e){
  dragSrcId = this.dataset.id;
  e.dataTransfer.effectAllowed = "move";
  this.style.opacity = "0.5";
}
function dragOver(e){
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
}
function dropCard(e){
  e.preventDefault();
  const targetId = this.dataset.id;
  if(!dragSrcId || dragSrcId===targetId) return;
  const before = state.order.slice();
  // reorder: move dragSrcId to position before targetId
  state.order = state.order.filter(x=>x!==dragSrcId);
  const idx = state.order.indexOf(targetId);
  state.order.splice(idx,0,dragSrcId);
  pushUndo({type:"reorder", before, after: state.order.slice()});
  saveState();
  renderAll();
  dragSrcId = null;
}

/* --- Validation --- */
function isValidUrl(u){
  try{ if(!u) return false; new URL(u); return true; }catch(e){ return false; }
}

/* --- Keyboard shortcuts --- */
document.addEventListener("keydown",(e)=>{
  const mac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
  const ctrl = mac? e.metaKey : e.ctrlKey;
  if(ctrl && e.key.toLowerCase()==="k"){ e.preventDefault(); $("quick-capture").focus(); }
  if(e.key==="Escape"){ closeEditor(); const root = $("modal-root"); root.innerHTML=""; root.setAttribute("aria-hidden","true"); }
  if(ctrl && (e.key==="z" || e.key==="Z")){ e.preventDefault(); if(e.shiftKey) redo(); else undo(); }
  if((ctrl && e.key.toLowerCase()==="y") || (ctrl && e.shiftKey && e.key.toLowerCase()==="z")){ e.preventDefault(); redo(); }
  if(ctrl && e.key.toLowerCase()==="s"){ e.preventDefault(); openExportDialog(); }
});

/* --- Settings --- */
$("btn-settings").addEventListener("click", ()=>{
  const panelOpen = $("btn-settings").getAttribute("aria-expanded")==="true";
  if(panelOpen){ $("btn-settings").setAttribute("aria-expanded","false"); return; }
  const html = `<div style="display:flex;flex-direction:column;gap:8px">
    <label>Attachment max size (bytes) <input id="set-attach" class="input" value="${state.settings.attachMaxBytes}"></label>
    <label>Undo stack size <input id="set-undo" class="input" value="${state.settings.undoLimit}"></label>
    <label>Show timestamps in cards <select id="set-ts" class="input"><option value="true">Yes</option><option value="false">No</option></select></label>
    <label>Theme <select id="set-theme" class="input"><option value="light">Light</option><option value="dark">Dark</option></select></label>
    <div style="display:flex;gap:8px"><button id="save-settings" class="btn small">Save</button><button id="clear-data" class="btn small" style="background:var(--danger);color:white">Clear All Data</button></div>
  </div>`;
  showModal("Settings", html, [{text:"Close"}]);
  setTimeout(()=>{
    document.querySelector("#modal-root #set-ts").value = state.settings.showTimestamps ? "true":"false";
    document.querySelector("#modal-root #set-theme").value = state.settings.theme || "light";
    document.querySelector("#modal-root #save-settings").onclick = ()=>{
      const a = parseInt(document.querySelector("#modal-root #set-attach").value)||state.settings.attachMaxBytes;
      const b = parseInt(document.querySelector("#modal-root #set-undo").value)||state.settings.undoLimit;
      const ts = document.querySelector("#modal-root #set-ts").value==="true";
      const theme = document.querySelector("#modal-root #set-theme").value;
      state.settings.attachMaxBytes = clamp(a, 1024, 10*1024*1024);
      state.settings.undoLimit = clamp(b, 1, 500);
      state.settings.showTimestamps = ts;
      state.settings.theme = theme;
      document.body.setAttribute("data-theme", theme);
      saveState();
      $("attach-max").textContent = readableBytes(state.settings.attachMaxBytes);
      showModal("Saved","Settings saved.",[{text:"OK"}]);
    };
    document.querySelector("#modal-root #clear-data").onclick = ()=>{
      showTypedConfirm("Delete all data","Type DELETE ALL to permanently clear all data", (ok)=>{
        if(ok){
          localStorage.removeItem(STORAGE_KEY);
          state = {clips:{}, order:[], tags:{}, settings:{...DEFAULT_SETTINGS}, nextId:1};
          saveState();
          renderAll();
          document.querySelector("#modal-root").innerHTML="";
        }
      });
    };
  },10);
});

/* Clear all button in left column */
$("btn-clear-all").addEventListener("click", ()=>{
  showTypedConfirm("Delete all data","Type DELETE ALL to permanently clear all data", (ok)=>{
    if(ok){
      localStorage.removeItem(STORAGE_KEY);
      state = {clips:{}, order:[], tags:{}, settings:{...DEFAULT_SETTINGS}, nextId:1};
      saveState();
      renderAll();
    }
  });
});

/* Undo/Redo UI */
function updateUndoRedoUI(){
  $("btn-undo").disabled = undoStack.length===0;
  $("btn-redo").disabled = redoStack.length===0;
}
$("btn-undo").addEventListener("click", ()=>undo());
$("btn-redo").addEventListener("click", ()=>redo());

/* Search debounce */
let searchTimer = null;
$("search").addEventListener("input",(e)=>{
  if(searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>{ activeFilter = {kind:"all", tag:null, date:$("date-filter").value, query:$("search").value}; renderClips(); searchTimer=null },150);
});

/* Filters (left column) */
document.querySelectorAll('.filter-btn').forEach(el=>{
  el.addEventListener('click', ()=>{ const f = el.dataset.filter; if(f==='all') activeFilter={kind:'all'}; else if(f==='untagged') activeFilter={kind:'untagged'}; else if(f==='starred') activeFilter={kind:'starred'}; else if(f==='attachments') activeFilter={kind:'attachments'}; renderClips(); });
});

/* Storage warning on load */
function checkLocalStorageAvailability(){
  try{
    const test = "__ls_test__";
    localStorage.setItem(test,test);
    localStorage.removeItem(test);
    return true;
  }catch(e){ return false; }
}

/* Init */
function init(){
  if(!checkLocalStorageAvailability()) memoryOnly = true;
  loadState();
  renderAll();
  updateUndoRedoUI();
  updateStorageInfo();
  // Wire quick-capture shortcut focus
  document.addEventListener("click", (e)=>{ updateStorageInfo(); });
  // accessibility: close drawer on Esc
  document.addEventListener("keyup",(e)=>{ if(e.key==="Escape") closeEditor(); });
  // safety: show empty state if none
  if(state.order.length===0) $("empty-state").classList.remove("hidden");
}
init();

/* Additional utilities used above but defined later */
function downloadFileBlob(blob, name){
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); a.remove();
}
</script>
</body>
</html>
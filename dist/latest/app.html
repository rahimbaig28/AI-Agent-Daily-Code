<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auto-generated via Perplexity on 2026-01-09T01:40:58.011512Z -->

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>

<meta charset="UTF-8">
<title>Accessibility Toolkit Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --bg-color: #ffffff;
  --text-color: #111111;
  --accent-color: #005fcc;
  --border-color: #cccccc;
  --focus-color: #ff9800;
  --panel-bg: #f5f5f5;
}

[data-theme="dark"] {
  --bg-color: #111111;
  --text-color: #f5f5f5;
  --accent-color: #4dabf7;
  --border-color: #555555;
  --focus-color: #ffb74d;
  --panel-bg: #1f1f1f;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  line-height: 1.5;
}

a {
  color: var(--accent-color);
}

a:hover,
button:hover {
  cursor: pointer;
}

button,
input,
select,
textarea {
  font-family: inherit;
  font-size: 1rem;
}

button {
  border-radius: 4px;
  border: 1px solid var(--border-color);
  padding: 0.5rem 0.75rem;
  background: var(--panel-bg);
  color: var(--text-color);
}

button:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible,
a:focus-visible {
  outline: 3px solid var(--focus-color);
  outline-offset: 3px;
}

/* Layout */
.app-container {
  max-width: 960px;
  margin: 0 auto;
  padding: 0 1rem 2rem;
}

header[role="banner"] {
  position: sticky;
  top: 0;
  z-index: 100;
  background-color: var(--bg-color);
  border-bottom: 1px solid var(--border-color);
  padding: 0.5rem 1rem 0.75rem;
}

.header-inner {
  max-width: 960px;
  margin: 0 auto;
}

.header-top-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

header h1 {
  margin: 0;
  font-size: 1.4rem;
}

header p {
  margin: 0.25rem 0 0;
  font-size: 0.95rem;
}

.header-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
}

.header-meta {
  margin-top: 0.5rem;
  font-size: 0.85rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: center;
  justify-content: space-between;
}

.badge {
  display: inline-block;
  padding: 0.1rem 0.4rem;
  border-radius: 999px;
  border: 1px solid var(--border-color);
  font-size: 0.75rem;
}

/* Skip link */
.skip-link {
  position: absolute;
  left: -999px;
  top: 0;
  background: var(--focus-color);
  color: #000;
  padding: 0.4rem 0.75rem;
  z-index: 200;
}

.skip-link:focus {
  left: 0.5rem;
  top: 0.5rem;
}

/* Sections */
main {
  margin-top: 1rem;
}

section {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background-color: var(--panel-bg);
  border-radius: 6px;
  border: 1px solid var(--border-color);
}

section h2 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.25rem;
}

.helper-text {
  font-size: 0.85rem;
  color: var(--text-color);
  opacity: 0.8;
}

/* Form layout */
.field-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: flex-end;
  margin-bottom: 0.75rem;
}

.field-group {
  display: flex;
  flex-direction: column;
  min-width: 140px;
}

.field-group label {
  font-size: 0.9rem;
  margin-bottom: 0.15rem;
}

.inline-inputs {
  display: flex;
  gap: 0.35rem;
  align-items: center;
}

input[type="text"],
input[type="color"],
select,
textarea {
  padding: 0.4rem 0.5rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
  background-color: var(--bg-color);
  color: var(--text-color);
}

textarea {
  min-height: 80px;
  resize: vertical;
}

/* Theme & Contrast */
#contrast-preview {
  margin-top: 0.75rem;
  padding: 0.75rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

#contrast-preview p {
  margin: 0 0 0.5rem;
}

.status-row {
  margin-top: 0.5rem;
  font-size: 0.9rem;
}

.badges-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  margin-top: 0.35rem;
}

.badge-pass {
  border-color: #2e7d32;
  color: #2e7d32;
}

.badge-fail {
  border-color: #c62828;
  color: #c62828;
}

.error-text {
  font-size: 0.8rem;
  color: #c62828;
  min-height: 1em;
}

/* Focus Lab */
.focus-items {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.focus-item {
  position: relative;
  padding: 0.35rem 0.5rem;
  border-radius: 4px;
  border: 1px dashed transparent;
}

.focus-order-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  font-size: 0.7rem;
  padding: 0.1rem 0.3rem;
  border-radius: 999px;
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  display: none;
}

.focus-item[data-show-order="true"] .focus-order-badge {
  display: inline-block;
}

#focus-order-list {
  margin-top: 0.5rem;
  font-size: 0.9rem;
}

#focus-order-list ol {
  padding-left: 1.3rem;
  margin: 0.25rem 0 0;
}

/* Live region */
.live-region-box {
  margin-top: 0.75rem;
  padding: 0.6rem;
  border-radius: 4px;
  border: 1px dashed var(--border-color);
  font-size: 0.9rem;
}

.last-announcement {
  margin-top: 0.75rem;
  padding: 0.6rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
  background: var(--bg-color);
  font-size: 0.9rem;
}

/* Checklist */
.checklist-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.25rem;
}

.checklist-item label {
  flex: 1;
}

.checklist-item.completed label {
  text-decoration: line-through;
  opacity: 0.7;
}

.checklist-item button.delete-item {
  padding: 0.2rem 0.4rem;
  font-size: 0.8rem;
}

.notes-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
  margin-top: 0.5rem;
}

/* Footer reset */
.footer-actions {
  margin-top: 1rem;
  text-align: right;
}

/* Keyboard shortcuts text */
.shortcuts-text {
  font-size: 0.85rem;
}

/* Responsive */
@media (max-width: 600px) {
  .field-row {
    flex-direction: column;
    align-items: stretch;
  }
  header h1 {
    font-size: 1.2rem;
  }
}
</style>
</head>
<body>
<a href="#main" class="skip-link">Skip to main content</a>

<header role="banner">
  <div class="header-inner">
    <div class="header-top-row">
      <div>
        <h1 id="app-title">Accessibility Toolkit Panel</h1>
        <div id="header-text">
          <p id="header-description">Compact toolbar to try contrast checks, focus-visible behavior, ARIA live announcements, and keyboard-only navigation.</p>
        </div>
      </div>
      <div class="header-controls">
        <div>
          <label for="theme-toggle">Theme:</label>
          <button id="theme-toggle" type="button" aria-label="Theme: system" aria-pressed="false">System</button>
        </div>
        <div>
          <button id="toggle-header" type="button" aria-expanded="true" aria-controls="header-text">Hide header</button>
        </div>
      </div>
    </div>
    <div class="header-meta" aria-hidden="false">
      <span class="badge" aria-label="Offline capable indicator">Offline-capable</span>
      <span class="shortcuts-text">Keyboard shortcuts: Alt+1–4 focus section headings.</span>
    </div>
  </div>
</header>

<div class="app-container">
  <main id="main">
    <!-- Theme & Contrast -->
    <section id="theme-contrast-section" aria-labelledby="theme-contrast-heading">
      <h2 id="theme-contrast-heading" tabindex="-1">Theme &amp; Contrast</h2>
      <p class="helper-text">Paste colors or use the pickers, then review the contrast ratio and WCAG thresholds.</p>

      <div class="field-row">
        <div class="field-group">
          <label for="fg-hex">Foreground color (hex)</label>
          <div class="inline-inputs">
            <input id="fg-hex" type="text" inputmode="text" aria-describedby="fg-error" autocomplete="off" placeholder="#112233">
            <input id="fg-color" type="color" aria-label="Foreground color picker">
          </div>
          <div id="fg-error" class="error-text" aria-live="polite"></div>
        </div>

        <div class="field-group">
          <label for="bg-hex">Background color (hex)</label>
          <div class="inline-inputs">
            <input id="bg-hex" type="text" inputmode="text" aria-describedby="bg-error" autocomplete="off" placeholder="#ffffff">
            <input id="bg-color" type="color" aria-label="Background color picker">
          </div>
          <div id="bg-error" class="error-text" aria-live="polite"></div>
        </div>

        <div class="field-group">
          <label>
            <input type="checkbox" id="use-theme-colors">
            Use app theme colors
          </label>
        </div>
      </div>

      <div class="field-group">
        <label for="sample-text">Sample text</label>
        <textarea id="sample-text" rows="3">The quick brown fox jumps over the lazy dog.</textarea>
      </div>

      <div id="contrast-preview">
        <p id="contrast-text-preview">
          This is sample text. <a href="#">Sample link</a> and
          <button type="button">Sample button</button>.
        </p>
        <div class="status-row">
          <span id="contrast-ratio">Contrast ratio: --</span>
          <div class="badges-row" aria-live="polite">
            <span id="badge-aa-normal" class="badge">AA normal: --</span>
            <span id="badge-aa-large" class="badge">AA large: --</span>
            <span id="badge-aaa-normal" class="badge">AAA normal: --</span>
            <span id="badge-aaa-large" class="badge">AAA large: --</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Focusable Elements Lab -->
    <section id="focus-lab-section" aria-labelledby="focus-lab-heading">
      <h2 id="focus-lab-heading" tabindex="-1">Focusable Elements Lab</h2>
      <p>Press Tab to move through items, Shift+Tab to move backward. Activate with Enter or Space.</p>

      <div class="field-row">
        <div class="field-group">
          <label>
            <input type="checkbox" id="show-focus-order">
            Show focus order
          </label>
        </div>
        <div class="field-group">
          <span id="current-focus-line" aria-live="polite" class="helper-text">Current focus: none</span>
        </div>
      </div>

      <div class="focus-items" id="focus-items">
        <div class="focus-item" data-index="1">
          <button id="lab-button" type="button"
                  aria-describedby="lab-button-desc">Sample button</button>
          <div id="lab-button-desc" class="helper-text">Role: button. Activate with Enter or Space.</div>
          <span class="focus-order-badge" aria-hidden="true">1</span>
        </div>

        <div class="focus-item" data-index="2">
          <a id="lab-link" href="#focus-lab-section"
             aria-describedby="lab-link-desc">Sample link</a>
          <div id="lab-link-desc" class="helper-text">Role: link. Follow with Enter.</div>
          <span class="focus-order-badge" aria-hidden="true">2</span>
        </div>

        <div class="focus-item" data-index="3">
          <label>
            <input id="lab-checkbox" type="checkbox"
                   aria-describedby="lab-checkbox-desc">
            Sample checkbox
          </label>
          <div id="lab-checkbox-desc" class="helper-text">Role: checkbox. Toggle with Space.</div>
          <span class="focus-order-badge" aria-hidden="true">3</span>
        </div>

        <div class="focus-item" data-index="4">
          <fieldset>
            <legend>Sample radio group</legend>
            <label>
              <input type="radio" name="lab-radio" id="lab-radio-1"
                     aria-describedby="lab-radio-desc">
              Option one
            </label>
            <br>
            <label>
              <input type="radio" name="lab-radio" id="lab-radio-2"
                     aria-describedby="lab-radio-desc">
              Option two
            </label>
          </fieldset>
          <div id="lab-radio-desc" class="helper-text">Role: radio group. Use arrow keys within group; Space selects.</div>
          <span class="focus-order-badge" aria-hidden="true">4</span>
        </div>

        <div class="focus-item" data-index="5">
          <div class="field-group">
            <label for="lab-text-input">Sample text input</label>
            <input id="lab-text-input" type="text"
                   placeholder="Type here"
                   aria-describedby="lab-text-desc">
          </div>
          <div id="lab-text-desc" class="helper-text">Role: textbox. Type freely; Enter may submit forms.</div>
          <span class="focus-order-badge" aria-hidden="true">5</span>
        </div>
      </div>

      <div id="focus-order-list" aria-live="polite">
        <!-- populated by JS -->
      </div>
    </section>

    <!-- ARIA Live Region Tester -->
    <section id="live-region-section" aria-labelledby="live-region-heading">
      <h2 id="live-region-heading" tabindex="-1">ARIA Live Region Tester</h2>
      <p class="helper-text">
        Use <strong>polite</strong> for non-urgent updates that should wait for the user to pause, and
        <strong>assertive</strong> for important alerts that should interrupt current speech.
      </p>

      <div class="field-row">
        <div class="field-group">
          <label for="live-message">Message to announce</label>
          <input id="live-message" type="text" autocomplete="off">
        </div>
        <div class="field-group">
          <label for="live-politeness">Politeness level</label>
          <select id="live-politeness">
            <option value="polite">polite</option>
            <option value="assertive">assertive</option>
          </select>
        </div>
        <div class="field-group">
          <label>&nbsp;</label>
          <button id="announce-btn" type="button">Announce</button>
        </div>
      </div>

      <div id="live-region" class="live-region-box" role="status" aria-live="polite" aria-atomic="true">
        Screen readers will announce messages here.
      </div>

      <div class="last-announcement">
        <div><strong>Last announced message:</strong></div>
        <div id="last-announcement-text">None yet.</div>
        <div id="last-announcement-time" class="helper-text"></div>
      </div>
    </section>

    <!-- Checklist & Notes -->
    <section id="checklist-section" aria-labelledby="checklist-heading" aria-label="Accessibility checklist">
      <h2 id="checklist-heading" tabindex="-1">Checklist &amp; Notes</h2>

      <div>
        <h3>Accessibility checklist</h3>
        <div id="checklist-container">
          <!-- items injected by JS -->
        </div>

        <div class="field-row" style="margin-top:0.5rem;">
          <div class="field-group">
            <label for="new-checklist-item">Add custom item</label>
            <input id="new-checklist-item" type="text" autocomplete="off" placeholder="Describe the check">
          </div>
          <div class="field-group">
            <label>&nbsp;</label>
            <button id="add-checklist-item" type="button">Add item</button>
          </div>
        </div>
      </div>

      <div style="margin-top:1rem;">
        <h3>Accessibility notes</h3>
        <div class="field-group">
          <label for="notes-textarea">Accessibility notes for this project</label>
          <textarea id="notes-textarea" aria-describedby="notes-helper"></textarea>
        </div>
        <div id="notes-helper" class="helper-text">
          Notes are autosaved locally as you type. They never leave this browser.
        </div>
        <div class="notes-controls">
          <button id="test-data-btn" type="button">Test data</button>
          <span class="helper-text">Use test data to quickly verify persistence.</span>
        </div>
      </div>

      <div class="footer-actions">
        <button id="reset-all-btn" type="button">Reset all settings</button>
      </div>
    </section>
  </main>
</div>

<script>
(function() {
  const STORAGE_KEYS = {
    theme: 'themePreference',
    contrast: 'contrastSettings',
    checklist: 'checklistState',
    notes: 'notesContent',
    focusLab: 'focusLabSettings'
  };

  const defaultChecklistItems = [
    'All images have appropriate alt text or are marked decorative.',
    'Interactive elements are reachable and operable via keyboard.',
    'Focus order is logical and visible using focus indicators.',
    'Color is not the only means of conveying information.',
    'Headings follow a clear, hierarchical structure.',
    'ARIA roles and attributes are used only when necessary and correctly.'
  ];

  let themeState = {
    mode: 'system' // 'system' | 'light' | 'dark'
  };

  function getSystemTheme() {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    return 'light';
  }

  function applyTheme(mode) {
    const root = document.documentElement;
    let effectiveMode = mode === 'system' ? getSystemTheme() : mode;
    if (effectiveMode === 'dark') {
      root.setAttribute('data-theme', 'dark');
    } else {
      root.setAttribute('data-theme', 'light');
    }
    const btn = document.getElementById('theme-toggle');
    btn.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
    btn.setAttribute('aria-label', 'Theme: ' + mode);
    btn.setAttribute('aria-pressed', mode !== 'system');
    themeState.mode = mode;
  }

  function themeInit() {
    const stored = localStorage.getItem(STORAGE_KEYS.theme);
    let mode = 'system';
    if (stored === 'light' || stored === 'dark' || stored === 'system') {
      mode = stored;
    }
    applyTheme(mode);

    const btn = document.getElementById('theme-toggle');
    btn.addEventListener('click', function() {
      let next;
      if (themeState.mode === 'system') next = 'light';
      else if (themeState.mode === 'light') next = 'dark';
      else next = 'system';
      applyTheme(next);
      try {
        localStorage.setItem(STORAGE_KEYS.theme, next);
      } catch (e) {}
    });

    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
        if (themeState.mode === 'system') {
          applyTheme('system');
        }
      });
    }
  }

  function normalizeHex(val) {
    if (!val) return null;
    let v = val.trim();
    if (v === '#') v = v.slice(1);
    if (v.length === 3) {
      if (!/^[0-9a-fA-F]{3}$/.test(v)) return null;
      v = v.split('').map(c => c + c).join('');
    }
    if (!/^[0-9a-fA-F]{6}$/.test(v)) return null;
    return '#' + v.toLowerCase();
  }

  function hexToRgb(hex) {
    const v = hex.replace('#', '');
    return {
      r: parseInt(v.substring(0, 2), 16),
      g: parseInt(v.substring(2, 4), 16),
      b: parseInt(v.substring(4, 6), 16)
    };
  }

  function relLuminance(rgb) {
    function channel(c) {
      const cs = c / 255;
      return cs <= 0.03928 ? cs / 12.92 : Math.pow((cs + 0.055) / 1.055, 2.4);
    }
    const R = channel(rgb.r);
    const G = channel(rgb.g);
    const B = channel(rgb.b);
    return 0.2126 * R + 0.7152 * G + 0.0722 * B;
  }

  function contrastRatio(hex1, hex2) {
    const L1 = relLuminance(hexToRgb(hex1));
    const L2 = relLuminance(hexToRgb(hex2));
    const lighter = Math.max(L1, L2);
    const darker = Math.min(L1, L2);
    return (lighter + 0.05) / (darker + 0.05);
  }

  function setBadge(element, passes, label) {
    element.textContent = label + ': ' + (passes ? 'Pass' : 'Fail');
    element.classList.remove('badge-pass', 'badge-fail');
    element.classList.add(passes ? 'badge-pass' : 'badge-fail');
  }

  function updateContrastPreview(fg, bg, sampleText) {
    const preview = document.getElementById('contrast-text-preview');
    preview.style.color = fg;
    preview.style.backgroundColor = bg;
    preview.querySelector('a').style.color = fg;
    preview.querySelector('button').style.color = fg;
    preview.querySelector('button').style.borderColor = fg;
    preview.firstChild.textContent = sampleText + ' ';
  }

  function saveContrastSettings(fg, bg, sampleText) {
    const payload = { fg, bg, sampleText };
    try {
      localStorage.setItem(STORAGE_KEYS.contrast, JSON.stringify(payload));
    } catch (e) {}
  }

  function contrastUpdate() {
    const fgInput = document.getElementById('fg-hex');
    const bgInput = document.getElementById('bg-hex');
    const fgError = document.getElementById('fg-error');
    const bgError = document.getElementById('bg-error');
    const fgColor = document.getElementById('fg-color');
    const bgColor = document.getElementById('bg-color');
    const ratioSpan = document.getElementById('contrast-ratio');

    const rawFg = fgInput.value || fgColor.value;
    const rawBg = bgInput.value || bgColor.value;

    const normalizedFg = normalizeHex(rawFg);
    const normalizedBg = normalizeHex(rawBg);

    let valid = true;
    if (!normalizedFg) {
      fgError.textContent = 'Enter a valid hex color (#rgb or #rrggbb).';
      valid = false;
    } else {
      fgError.textContent = '';
      fgInput.value = normalizedFg;
      fgColor.value = normalizedFg;
    }
    if (!normalizedBg) {
      bgError.textContent = 'Enter a valid hex color (#rgb or #rrggbb).';
      valid = false;
    } else {
      bgError.textContent = '';
      bgInput.value = normalizedBg;
      bgColor.value = normalizedBg;
    }

    const sampleText = document.getElementById('sample-text').value;

    if (!valid) {
      ratioSpan.textContent = 'Contrast ratio: --';
      return;
    }

    const ratio = contrastRatio(normalizedFg, normalizedBg);
    const rounded = Math.round(ratio * 100) / 100;
    ratioSpan.textContent = 'Contrast ratio: ' + rounded.toFixed(2) + ':1';

    const aaNormal = ratio >= 4.5;
    const aaLarge = ratio >= 3;
    const aaaNormal = ratio >= 7;
    const aaaLarge = ratio >= 4.5;

    setBadge(document.getElementById('badge-aa-normal'), aaNormal, 'AA normal');
    setBadge(document.getElementById('badge-aa-large'), aaLarge, 'AA large');
    setBadge(document.getElementById('badge-aaa-normal'), aaaNormal, 'AAA normal');
    setBadge(document.getElementById('badge-aaa-large'), aaaLarge, 'AAA large');

    updateContrastPreview(normalizedFg, normalizedBg, sampleText);
    saveContrastSettings(normalizedFg, normalizedBg, sampleText);
  }

  function contrastInit() {
    const fgInput = document.getElementById('fg-hex');
    const bgInput = document.getElementById('bg-hex');
    const fgColor = document.getElementById('fg-color');
    const bgColor = document.getElementById('bg-color');
    const sampleText = document.getElementById('sample-text');
    const useTheme = document.getElementById('use-theme-colors');

    const stored = localStorage.getItem(STORAGE_KEYS.contrast);
    let fg = '#112233';
    let bg = '#ffffff';
    let textVal = sampleText.value;

    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        if (parsed && normalizeHex(parsed.fg) && normalizeHex(parsed.bg)) {
          fg = normalizeHex(parsed.fg);
          bg = normalizeHex(parsed.bg);
        }
        if (typeof parsed.sampleText === 'string') {
          textVal = parsed.sampleText;
        }
      } catch (e) {}
    }

    fgInput.value = fg;
    bgInput.value = bg;
    fgColor.value = fg;
    bgColor.value = bg;
    sampleText.value = textVal;

    function syncWithThemeIfNeeded() {
      if (!useTheme.checked) return;
      const styles = getComputedStyle(document.documentElement);
      const themeFg = styles.getPropertyValue('--text-color').trim() || '#111111';
      const themeBg = styles.getPropertyValue('--bg-color').trim() || '#ffffff';
      fgInput.value = themeFg;
      bgInput.value = themeBg;
      fgColor.value = themeFg;
      bgColor.value = themeBg;
    }

    useTheme.addEventListener('change', function() {
      if (useTheme.checked) {
        syncWithThemeIfNeeded();
      }
      contrastUpdate();
    });

    ['input', 'change'].forEach(ev => {
      fgInput.addEventListener(ev, contrastUpdate);
      bgInput.addEventListener(ev, contrastUpdate);
      fgColor.addEventListener(ev, function() {
        fgInput.value = fgColor.value;
        contrastUpdate();
      });
      bgColor.addEventListener(ev, function() {
        bgInput.value = bgColor.value;
        contrastUpdate();
      });
      sampleText.addEventListener(ev, contrastUpdate);
    });

    window.addEventListener('load', function() {
      if (useTheme.checked) {
        syncWithThemeIfNeeded();
      }
      contrastUpdate();
    });

    window.addEventListener('resize', function() {
      if (useTheme.checked) {
        syncWithThemeIfNeeded();
        contrastUpdate();
      }
    });
  }

  function describeElement(el) {
    if (!el) return 'Current focus: none';
    const tag = el.tagName.toLowerCase();
    const role = el.getAttribute('role') || (tag === 'a' ? 'link' :
                  tag === 'button' ? 'button' :
                  tag === 'input' ? (el.type === 'checkbox' ? 'checkbox' :
                                      el.type === 'radio' ? 'radio' :
                                      'textbox') :
                  tag === 'select' ? 'combobox' :
                  tag === 'textarea' ? 'textbox' : tag);
    let labelText = '';
    const ariaLabel = el.getAttribute('aria-label');
    if (ariaLabel) {
      labelText = ariaLabel;
    } else {
      const labelledby = el.getAttribute('aria-labelledby');
      if (labelledby) {
        const ref = document.getElementById(labelledby);
        if (ref) labelText = ref.textContent.trim();
      }
      if (!labelText) {
        if (el.id) {
          const lbl = document.querySelector('label[for="' + el.id + '"]');
          if (lbl) labelText = lbl.textContent.trim();
        }
      }
      if (!labelText && (tag === 'button' || tag === 'a')) {
        labelText = el.textContent.trim();
      }
      if (!labelText && tag === 'input' && el.placeholder) {
        labelText = el.placeholder;
      }
    }
    if (!labelText) labelText = '(no label text)';
    return 'Current focus: ' + role + ' – ' + labelText;
  }

  function renderFocusOrderList(show) {
    const container = document.getElementById('focus-order-list');
    container.innerHTML = '';
    if (!show) return;
    const items = Array.from(document.querySelectorAll('#focus-items .focus-item'));
    const ol = document.createElement('ol');
    items.sort((a, b) => {
      const ai = parseInt(a.getAttribute('data-index'), 10);
      const bi = parseInt(b.getAttribute('data-index'), 10);
      return ai - bi;
    });
    items.forEach(item => {
      const labelEl = item.querySelector('button, a, input, textarea, select');
      if (!labelEl) return;
      const li = document.createElement('li');
      li.textContent = describeElement(labelEl).replace('Current focus: ', '');
      ol.appendChild(li);
    });
    const heading = document.createElement('div');
    heading.textContent = 'Focus order preview:';
    container.appendChild(heading);
    container.appendChild(ol);
  }

  function focusLabInit() {
    const toggle = document.getElementById('show-focus-order');
    const currentLine = document.getElementById('current-focus-line');
    const items = Array.from(document.querySelectorAll('#focus-items .focus-item'));
    const stored = localStorage.getItem(STORAGE_KEYS.focusLab);
    let show = false;
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        if (parsed && typeof parsed.showOrder === 'boolean') {
          show = parsed.showOrder;
        }
      } catch (e) {}
    }
    toggle.checked = show;
    items.forEach(item => {
      item.setAttribute('data-show-order', show ? 'true' : 'false');
    });
    renderFocusOrderList(show);

    toggle.addEventListener('change', function() {
      const isOn = toggle.checked;
      items.forEach(item => item.setAttribute('data-show-order', isOn ? 'true' : 'false'));
      renderFocusOrderList(isOn);
      try {
        localStorage.setItem(STORAGE_KEYS.focusLab, JSON.stringify({ showOrder: isOn }));
      } catch (e) {}
    });

    document.addEventListener('focusin', function(e) {
      const active = e.target;
      if (!active) return;
      currentLine.textContent = describeElement(active);
    });
  }

  function liveRegionAnnounce() {
    const msgInput = document.getElementById('live-message');
    const levelSelect = document.getElementById('live-politeness');
    const liveRegion = document.getElementById('live-region');
    const lastText = document.getElementById('last-announcement-text');
    const lastTime = document.getElementById('last-announcement-time');

    const msg = msgInput.value.trim();
    const level = levelSelect.value === 'assertive' ? 'assertive' : 'polite';

    liveRegion.textContent = '';
    void liveRegion.offsetWidth;

    if (level === 'assertive') {
      liveRegion.setAttribute('role', 'alert');
      liveRegion.setAttribute('aria-live', 'assertive');
    } else {
      liveRegion.setAttribute('role', 'status');
      liveRegion.setAttribute('aria-live', 'polite');
    }
    liveRegion.textContent = msg || '(empty message)';

    const now = new Date();
    lastText.textContent = msg || '(empty message)';
    lastTime.textContent = 'Announced at: ' + now.toLocaleTimeString();

    msgInput.value = '';
    msgInput.focus();
  }

  function liveRegionInit() {
    const btn = document.getElementById('announce-btn');
    btn.addEventListener('click', liveRegionAnnounce);
    document.getElementById('live-message').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        liveRegionAnnounce();
      }
    });
  }

  function buildChecklistItem(id, text, checked, isDefault) {
    const wrapper = document.createElement('div');
    wrapper.className = 'checklist-item';
    if (checked) wrapper.classList.add('completed');
    wrapper.dataset.itemId = id;
    wrapper.dataset.default = isDefault ? 'true' : 'false';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = id;
    checkbox.checked = !!checked;

    const label = document.createElement('label');
    label.setAttribute('for', id);
    label.textContent = text;

    wrapper.appendChild(checkbox);
    wrapper.appendChild(label);

    if (!isDefault) {
      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.textContent = 'Delete';
      delBtn.className = 'delete-item';
      delBtn.setAttribute('aria-label', 'Delete custom item: ' + text);
      wrapper.appendChild(delBtn);
    }

    return wrapper;
  }

  function saveChecklistState() {
    const container = document.getElementById('checklist-container');
    const items = Array.from(container.querySelectorAll('.checklist-item'));
    const state = items.map(item => {
      const checkbox = item.querySelector('input[type="checkbox"]');
      const label = item.querySelector('label');
      return {
        id: item.dataset.itemId,
        text: label.textContent,
        checked: checkbox.checked,
        isDefault: item.dataset.default === 'true'
      };
    });
    try {
      localStorage.setItem(STORAGE_KEYS.checklist, JSON.stringify(state));
    } catch (e) {}
  }

  function checklistToggle(e) {
    const target = e.target;
    if (target.type === 'checkbox') {
      const wrapper = target.closest('.checklist-item');
      if (target.checked) wrapper.classList.add('completed');
      else wrapper.classList.remove('completed');
      saveChecklistState();
    } else if (target.classList.contains('delete-item')) {
      const wrapper = target.closest('.checklist-item');
      if (wrapper && wrapper.dataset.default !== 'true') {
        wrapper.remove();
        saveChecklistState();
      }
    }
  }

  function checklistAdd() {
    const input = document.getElementById('new-checklist-item');
    const text = input.value.trim();
    if (!text) {
      input.focus();
      return;
    }
    const container = document.getElementById('checklist-container');
    const id = 'custom-item-' + Date.now();
    const itemEl = buildChecklistItem(id, text, false, false);
    container.appendChild(itemEl);
    input.value = '';
    saveChecklistState();
  }

  function checklistInit() {
    const container = document.getElementById('checklist-container');
    container.innerHTML = '';

    const stored = localStorage.getItem(STORAGE_KEYS.checklist);
    let itemsToRender = [];

    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed) && parsed.length) {
          itemsToRender = parsed;
        }
      } catch (e) {}
    }

    if (!itemsToRender.length) {
      itemsToRender = defaultChecklistItems.map((text, index) => ({
        id: 'default-item-' + index,
        text,
        checked: false,
        isDefault: true
      }));
    }

    itemsToRender.forEach(item => {
      const el = buildChecklistItem(item.id, item.text, !!item.checked, !!item.isDefault);
      container.appendChild(el);
    });

    container.addEventListener('click', checklistToggle);
    container.addEventListener('change', checklistToggle);

    document.getElementById('add-checklist-item').addEventListener('click', checklistAdd);
    document.getElementById('new-checklist-item').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        checklistAdd();
      }
    });
  }

  let notesSaveTimeout = null;

  function notesSave() {
    const textarea = document.getElementById('notes-textarea');
    const val = textarea.value;
    try {
      localStorage.setItem(STORAGE_KEYS.notes, val);
    } catch (e) {}
  }

  function notesInit() {
    const textarea = document.getElementById('notes-textarea');
    const stored = localStorage.getItem(STORAGE_KEYS.notes);
    if (typeof stored === 'string') {
      textarea.value = stored;
    }
    textarea.addEventListener('input', function() {
      if (notesSaveTimeout) {
        clearTimeout(notesSaveTimeout);
      }
      notesSaveTimeout = setTimeout(notesSave, 300);
    });

    document.getElementById('test-data-btn').addEventListener('click', function() {
      const confirmUse = window.confirm('Apply test data? This appends sample notes and checks a couple of checklist items.');
      if (!confirmUse) return;

      const sampleNote = 'Sample accessibility notes:\n- Verified keyboard navigation across primary flows.\n- Contrast issues found on header links.\n- Screen reader labels need refinement for custom components.';
      const existing = textarea.value;
      textarea.value = existing ? (existing + '\n\n' + sampleNote) : sampleNote;
      notesSave();

      const container = document.getElementById('checklist-container');
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      if (checkboxes.length >= 2) {
        checkboxes.checked = true;
        checkboxes[1].checked = true;
        checkboxes.closest('.checklist-item').classList.add('completed');
        checkboxes[1].closest('.checklist-item').classList.add('completed');
      }
      saveChecklistState();
    });
  }

  function resetAll() {
    const ok = window.confirm('Reset all settings, saved state, and notes? This cannot be undone.');
    if (!ok) return;
    try {
      Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
    } catch (e) {}
    window.location.reload();
  }

  function headerInit() {
    const toggle = document.getElementById('toggle-header');
    const headerText = document.getElementById('header-text');
    const meta = document.querySelector('.header-meta');

    toggle.addEventListener('click', function() {
      const expanded = toggle.getAttribute('aria-expanded') === 'true';
      const next = !expanded;
      toggle.setAttribute('aria-expanded', String(next));
      toggle.textContent = next ? 'Hide header' : 'Show header';
      headerText.style.display = next ? '' : 'none';
      if (meta) meta.style.display = next ? '' : 'none';
      headerText.setAttribute('aria-hidden', String(!next));
    });
  }

  function shortcutsInit() {
    const map = {
      '1': 'theme-contrast-heading',
      '2': 'focus-lab-heading',
      '3': 'live-region-heading',
      '4': 'checklist-heading'
    };
    document.addEventListener('keydown', function(e) {
      if (!e.altKey || e.shiftKey || e.ctrlKey || e.metaKey) return;
      const id = map[e.key];
      if (!id) return;
      const el = document.getElementById(id);
      if (el) {
        e.preventDefault();
        el.focus();
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    themeInit();
    headerInit();
    contrastInit();
    focusLabInit();
    liveRegionInit();
    checklistInit();
    notesInit();
    shortcutsInit();

    document.getElementById('reset-all-btn').addEventListener('click', resetAll);
  });
})();
</script>
</body>
</html>